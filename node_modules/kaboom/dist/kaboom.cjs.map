{
  "version": 3,
  "sources": ["../src/kaboom.ts", "../src/math.ts", "../src/utils.ts", "../src/fps.ts", "../src/timer.ts"],
  "sourcesContent": ["// TODO: event registers return Promise for next event when callback not passed?\n// TODO: pass original browser event in input handlers\n\nconst VERSION = \"3000.0.0-alpha.10\"\n\nimport {\n\tsat,\n\tvec2,\n\tvec3,\n\tVec3,\n\tRect,\n\tPolygon,\n\tLine,\n\tCircle,\n\tColor,\n\tVec2,\n\tMat4,\n\tQuad,\n\tRNG,\n\tquad,\n\trgb,\n\thsl2rgb,\n\trand,\n\trandi,\n\trandSeed,\n\tchance,\n\tchoose,\n\tclamp,\n\tlerp,\n\tmap,\n\tmapc,\n\twave,\n\ttestLineLine,\n\ttestRectRect,\n\ttestRectLine,\n\ttestRectPoint,\n\ttestPolygonPoint,\n\ttestCirclePoint,\n\tdeg2rad,\n\trad2deg,\n\teasings,\n} from \"./math\"\n\nimport {\n\tIDList,\n\tEvent,\n\tEventHandler,\n\tdownload,\n\tdownloadText,\n\tdownloadJSON,\n\tdownloadBlob,\n\tuid,\n\tisDataURL,\n\tdeepEq,\n\tdataURLToArrayBuffer,\n\t// eslint-disable-next-line\n\twarn,\n\t// eslint-disable-next-line\n\tbenchmark,\n} from \"./utils\"\n\nimport {\n\tGfxShader,\n\tGfxFont,\n\tRenderProps,\n\tCharTransform,\n\tTextureOpt,\n\tFormattedText,\n\tFormattedChar,\n\tDrawRectOpt,\n\tDrawLineOpt,\n\tDrawLinesOpt,\n\tDrawTriangleOpt,\n\tDrawPolygonOpt,\n\tDrawCircleOpt,\n\tDrawEllipseOpt,\n\tDrawUVQuadOpt,\n\tVertex,\n\tFontData,\n\tBitmapFontData,\n\tShaderData,\n\tLoadSpriteSrc,\n\tLoadSpriteOpt,\n\tSpriteAtlasData,\n\tLoadBitmapFontOpt,\n\tKaboomCtx,\n\tKaboomOpt,\n\tAudioPlay,\n\tAudioPlayOpt,\n\tDrawSpriteOpt,\n\tDrawTextOpt,\n\tTextAlign,\n\tGameObj,\n\tEventController,\n\tSceneID,\n\tSceneDef,\n\tCompList,\n\tComp,\n\tTag,\n\tKey,\n\tMouseButton,\n\tPosComp,\n\tScaleComp,\n\tRotateComp,\n\tColorComp,\n\tOpacityComp,\n\tAnchor,\n\tAnchorComp,\n\tZComp,\n\tFollowComp,\n\tMoveComp,\n\tOffScreenCompOpt,\n\tOffScreenComp,\n\tAreaCompOpt,\n\tAreaComp,\n\tSpriteComp,\n\tSpriteCompOpt,\n\tSpriteAnimPlayOpt,\n\tSpriteAnims,\n\tTextComp,\n\tTextCompOpt,\n\tRectComp,\n\tRectCompOpt,\n\tUVQuadComp,\n\tCircleComp,\n\tOutlineComp,\n\tTimerComp,\n\tBodyComp,\n\tBodyCompOpt,\n\tUniform,\n\tShaderComp,\n\tFixedComp,\n\tStayComp,\n\tHealthComp,\n\tLifespanComp,\n\tLifespanCompOpt,\n\tStateComp,\n\tDebug,\n\tKaboomPlugin,\n\tMergeObj,\n\tLevelComp,\n\tLevelOpt,\n\tCursor,\n\tRecording,\n\tBoomOpt,\n\tPeditFile,\n\tShape,\n\tDoubleJumpComp,\n\tVirtualButton,\n\tTimerController,\n\tTweenController,\n} from \"./types\"\n\nimport FPSCounter from \"./fps\"\nimport Timer from \"./timer\"\n\n// @ts-ignore\nimport happyFontSrc from \"./assets/happy_28x36.png\"\n// @ts-ignore\nimport beanSpriteSrc from \"./assets/bean.png\"\n// @ts-ignore\nimport burpSoundSrc from \"./assets/burp.mp3\"\n// @ts-ignore\nimport kaSpriteSrc from \"./assets/ka.png\"\n// @ts-ignore\nimport boomSpriteSrc from \"./assets/boom.png\"\n\ntype ButtonState =\n\t\"up\"\n\t| \"pressed\"\n\t| \"rpressed\"\n\t| \"down\"\n\t| \"released\"\n\ntype EventList<M> = {\n\t[event in keyof M]?: (event: M[event]) => void\n}\n\ninterface SpriteCurAnim {\n\tname: string,\n\ttimer: number,\n\tloop: boolean,\n\tspeed: number,\n\tpingpong: boolean,\n\tonEnd: () => void,\n}\n\n// translate these key names to a simpler version\nconst KEY_ALIAS = {\n\t\"ArrowLeft\": \"left\",\n\t\"ArrowRight\": \"right\",\n\t\"ArrowUp\": \"up\",\n\t\"ArrowDown\": \"down\",\n\t\" \": \"space\",\n}\n\n// according to https://developer.mozilla.org/en-US/docs/Web/API/MouseEvent/button\nconst MOUSE_BUTTONS = [\n\t\"left\",\n\t\"middle\",\n\t\"right\",\n\t\"back\",\n\t\"forward\",\n]\n\n// don't trigger browser default event when these keys are pressed\nconst PREVENT_DEFAULT_KEYS = [\n\t\"space\",\n\t\"left\",\n\t\"right\",\n\t\"up\",\n\t\"down\",\n\t\"tab\",\n\t\"f1\",\n\t\"f2\",\n\t\"f3\",\n\t\"f4\",\n\t\"f5\",\n\t\"f6\",\n\t\"f7\",\n\t\"f8\",\n\t\"f9\",\n\t\"f10\",\n\t\"f11\",\n\t\"s\",\n]\n\n// some default charsets for loading bitmap fonts\nconst ASCII_CHARS = \" !\\\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\\\]^_`abcdefghijklmnopqrstuvwxyz{|}~\"\n\n// audio gain range\nconst MIN_GAIN = 0\nconst MAX_GAIN = 3\n\n// audio speed range\nconst MIN_SPEED = 0\nconst MAX_SPEED = 3\n\n// audio detune range\nconst MIN_DETUNE = -1200\nconst MAX_DETUNE = 1200\n\nconst DEF_ANCHOR = \"topleft\"\nconst BG_GRID_SIZE = 64\n\nconst DEF_FONT = \"happy\"\nconst DBG_FONT = \"monospace\"\nconst DEF_TEXT_SIZE = 36\nconst DEF_TEXT_CACHE_SIZE = 64\nconst FONT_ATLAS_SIZE = 1024\n// 0.1 pixel padding to texture coordinates to prevent artifact\nconst UV_PAD = 0.1\n\nconst LOG_MAX = 1\n\nconst VERTEX_FORMAT = [\n\t{ name: \"a_pos\", size: 3 },\n\t{ name: \"a_uv\", size: 2 },\n\t{ name: \"a_color\", size: 4 },\n]\n\nconst STRIDE = VERTEX_FORMAT.reduce((sum, f) => sum + f.size, 0)\n\nconst MAX_BATCHED_QUAD = 2048\nconst MAX_BATCHED_VERTS = MAX_BATCHED_QUAD * 4 * STRIDE\nconst MAX_BATCHED_INDICES = MAX_BATCHED_QUAD * 6\n\n// vertex shader template, replace {{user}} with user vertex shader code\nconst VERT_TEMPLATE = `\nattribute vec3 a_pos;\nattribute vec2 a_uv;\nattribute vec4 a_color;\n\nvarying vec3 v_pos;\nvarying vec2 v_uv;\nvarying vec4 v_color;\n\nvec4 def_vert() {\n\treturn vec4(a_pos, 1.0);\n}\n\n{{user}}\n\nvoid main() {\n\tvec4 pos = vert(a_pos, a_uv, a_color);\n\tv_pos = a_pos;\n\tv_uv = a_uv;\n\tv_color = a_color;\n\tgl_Position = pos;\n}\n`\n\n// fragment shader template, replace {{user}} with user fragment shader code\nconst FRAG_TEMPLATE = `\nprecision mediump float;\n\nvarying vec3 v_pos;\nvarying vec2 v_uv;\nvarying vec4 v_color;\n\nuniform sampler2D u_tex;\n\nvec4 def_frag() {\n\treturn v_color * texture2D(u_tex, v_uv);\n}\n\n{{user}}\n\nvoid main() {\n\tgl_FragColor = frag(v_pos, v_uv, v_color, u_tex);\n\tif (gl_FragColor.a == 0.0) {\n\t\tdiscard;\n\t}\n}\n`\n\n// default {{user}} vertex shader code\nconst DEF_VERT = `\nvec4 vert(vec3 pos, vec2 uv, vec4 color) {\n\treturn def_vert();\n}\n`\n\n// default {{user}} fragment shader code\nconst DEF_FRAG = `\nvec4 frag(vec3 pos, vec2 uv, vec4 color, sampler2D tex) {\n\treturn def_frag();\n}\n`\n\nconst COMP_DESC = new Set([\n\t\"id\",\n\t\"require\",\n])\n\nconst COMP_EVENTS = new Set([\n\t\"add\",\n\t\"update\",\n\t\"draw\",\n\t\"destroy\",\n\t\"inspect\",\n\t\"drawInspect\",\n])\n\n// transform the button state to the next state\n// e.g. if a button becomes \"pressed\" one frame, it should become \"down\" next frame\nfunction processButtonState(s: ButtonState): ButtonState {\n\tif (s === \"pressed\" || s === \"rpressed\") {\n\t\treturn \"down\"\n\t} else if (s === \"released\") {\n\t\treturn \"up\"\n\t} else {\n\t\treturn s\n\t}\n}\n\n// wrappers around full screen functions to work across browsers\nfunction enterFullscreen(el: HTMLElement) {\n\tif (el.requestFullscreen) el.requestFullscreen()\n\t// @ts-ignore\n\telse if (el.webkitRequestFullscreen) el.webkitRequestFullscreen()\n}\n\nfunction exitFullscreen() {\n\tif (document.exitFullscreen) document.exitFullscreen()\n\t// @ts-ignore\n\telse if (document.webkitExitFullScreen) document.webkitExitFullScreen()\n}\n\nfunction getFullscreenElement(): Element | void {\n\treturn document.fullscreenElement\n\t\t// @ts-ignore\n\t\t|| document.webkitFullscreenElement\n}\n\n// convert anchor string to a vec2 offset\nfunction anchorPt(orig: Anchor | Vec2): Vec2 {\n\tswitch (orig) {\n\t\tcase \"topleft\": return vec2(-1, -1)\n\t\tcase \"top\": return vec2(0, -1)\n\t\tcase \"topright\": return vec2(1, -1)\n\t\tcase \"left\": return vec2(-1, 0)\n\t\tcase \"center\": return vec2(0, 0)\n\t\tcase \"right\": return vec2(1, 0)\n\t\tcase \"botleft\": return vec2(-1, 1)\n\t\tcase \"bot\": return vec2(0, 1)\n\t\tcase \"botright\": return vec2(1, 1)\n\t\tdefault: return orig\n\t}\n}\n\nfunction alignPt(align: TextAlign): number {\n\tswitch (align) {\n\t\tcase \"left\": return 0\n\t\tcase \"center\": return 0.5\n\t\tcase \"right\": return 1\n\t\tdefault: return 0\n\t}\n}\n\nfunction createEmptyAudioBuffer(ctx: AudioContext) {\n\treturn ctx.createBuffer(1, 1, 44100)\n}\n\n// only exports one kaboom() which contains all the state\nexport default (gopt: KaboomOpt = {}): KaboomCtx => {\n\n\tconst gc: Array<() => void> = []\n\n\tconst app = (() => {\n\n\t\tconst root = gopt.root ?? document.body\n\n\t\t// if root is not defined (which falls back to <body>) we assume user is using kaboom on a clean page, and modify <body> to better fit a full screen canvas\n\t\tif (root === document.body) {\n\t\t\tdocument.body.style[\"width\"] = \"100%\"\n\t\t\tdocument.body.style[\"height\"] = \"100%\"\n\t\t\tdocument.body.style[\"margin\"] = \"0px\"\n\t\t\tdocument.documentElement.style[\"width\"] = \"100%\"\n\t\t\tdocument.documentElement.style[\"height\"] = \"100%\"\n\t\t}\n\n\t\t// create a <canvas> if user didn't provide one\n\t\tconst canvas = gopt.canvas ?? (() => {\n\t\t\tconst canvas = document.createElement(\"canvas\")\n\t\t\troot.appendChild(canvas)\n\t\t\treturn canvas\n\t\t})()\n\n\t\t// global pixel scale\n\t\tconst gscale = gopt.scale ?? 1\n\t\tconst stretchToParent = !(gopt.width && gopt.height && !gopt.stretch && !gopt.letterbox)\n\t\tconst pw = canvas.parentElement.offsetWidth\n\t\tconst ph = canvas.parentElement.offsetHeight\n\n\t\t// adjust canvas size according to user size / viewport settings\n\t\tif (stretchToParent) {\n\t\t\tcanvas.width = pw\n\t\t\tcanvas.height = ph\n\t\t} else {\n\t\t\tcanvas.width = gopt.width * gscale\n\t\t\tcanvas.height = gopt.height * gscale\n\t\t}\n\n\t\tconst cw = canvas.width\n\t\tconst ch = canvas.height\n\t\tconst pixelDensity = gopt.pixelDensity || window.devicePixelRatio\n\n\t\tcanvas.width *= pixelDensity\n\t\tcanvas.height *= pixelDensity\n\n\t\t// canvas css styles\n\t\tconst styles = [\n\t\t\t`width: ${cw}px`,\n\t\t\t`height: ${ch}px`,\n\t\t\t\"outline: none\",\n\t\t\t\"cursor: default\",\n\t\t]\n\n\t\tif (gopt.crisp) {\n\t\t\t// chrome only supports pixelated and firefox only supports crisp-edges\n\t\t\tstyles.push(\"image-rendering: pixelated\")\n\t\t\tstyles.push(\"image-rendering: crisp-edges\")\n\t\t}\n\n\t\tcanvas.style.cssText = styles.join(\";\")\n\t\t// make canvas focusable\n\t\tcanvas.tabIndex = 0\n\n\t\treturn {\n\n\t\t\tcanvas: canvas,\n\t\t\t// for 2d context\n\t\t\tcanvas2: canvas.cloneNode() as HTMLCanvasElement,\n\t\t\tpixelDensity: pixelDensity,\n\n\t\t\tstretchToParent: stretchToParent,\n\t\t\tlastParentWidth: pw,\n\t\t\tlastParentHeight: ph,\n\n\t\t\t// keep track of all button states\n\t\t\tkeyStates: {} as Record<Key, ButtonState>,\n\t\t\tmouseStates: {} as Record<MouseButton, ButtonState>,\n\t\t\tvirtualButtonStates: {} as Record<VirtualButton, ButtonState>,\n\n\t\t\t// input states from last frame, should reset every frame\n\t\t\tcharInputted: [],\n\t\t\tnumKeyDown: 0,\n\t\t\tisMouseMoved: false,\n\t\t\tisKeyPressed: false,\n\t\t\tisKeyPressedRepeat: false,\n\t\t\tisKeyReleased: false,\n\t\t\tmouseStarted: false,\n\t\t\tmousePos: vec2(0, 0),\n\t\t\tmouseDeltaPos: vec2(0, 0),\n\n\t\t\t// total time elapsed\n\t\t\ttime: 0,\n\t\t\t// real total time elapsed (including paused time)\n\t\t\trealTime: 0,\n\t\t\t// if we should skip next dt, to prevent the massive dt surge if user switch to another tab for a while and comeback\n\t\t\tskipTime: false,\n\t\t\t// how much time last frame took\n\t\t\tdt: 0.0,\n\t\t\t// total frames elapsed\n\t\t\tnumFrames: 0,\n\n\t\t\t// if we're on a touch device\n\t\t\tisTouchScreen: (\"ontouchstart\" in window) || navigator.maxTouchPoints > 0,\n\n\t\t\t// requestAnimationFrame id\n\t\t\tloopID: null,\n\t\t\t// if our game loop is currently stopped / paused\n\t\t\tstopped: false,\n\t\t\tpaused: false,\n\n\t\t\tfpsCounter: new FPSCounter(),\n\n\t\t}\n\n\t})()\n\n\tconst gl = app.canvas\n\t\t.getContext(\"webgl\", {\n\t\t\tantialias: true,\n\t\t\tdepth: true,\n\t\t\tstencil: true,\n\t\t\talpha: true,\n\t\t\tpreserveDrawingBuffer: true,\n\t\t})\n\n\tclass Texture {\n\n\t\tglTex: WebGLTexture\n\t\twidth: number\n\t\theight: number\n\n\t\tconstructor(w: number, h: number, opt: TextureOpt = {}) {\n\n\t\t\tthis.glTex = gl.createTexture()\n\t\t\tgc.push(() => this.free())\n\t\t\tthis.bind()\n\n\t\t\tif (w && h) {\n\t\t\t\tgl.texImage2D(\n\t\t\t\t\tgl.TEXTURE_2D,\n\t\t\t\t\t0, gl.RGBA,\n\t\t\t\t\tw,\n\t\t\t\t\th,\n\t\t\t\t\t0,\n\t\t\t\t\tgl.RGBA,\n\t\t\t\t\tgl.UNSIGNED_BYTE,\n\t\t\t\t\tnull,\n\t\t\t\t)\n\t\t\t}\n\n\t\t\tthis.width = w\n\t\t\tthis.height = h\n\n\t\t\tconst filter = (() => {\n\t\t\t\tswitch (opt.filter ?? gopt.texFilter) {\n\t\t\t\t\tcase \"linear\": return gl.LINEAR\n\t\t\t\t\tcase \"nearest\": return gl.NEAREST\n\t\t\t\t\tdefault: return gl.NEAREST\n\t\t\t\t}\n\t\t\t})()\n\n\t\t\tconst wrap = (() => {\n\t\t\t\tswitch (opt.wrap) {\n\t\t\t\t\tcase \"repeat\": return gl.REPEAT\n\t\t\t\t\tcase \"clampToEdge\": return gl.CLAMP_TO_EDGE\n\t\t\t\t\tdefault: return gl.CLAMP_TO_EDGE\n\t\t\t\t}\n\t\t\t})()\n\n\t\t\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, filter)\n\t\t\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, filter)\n\t\t\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, wrap)\n\t\t\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, wrap)\n\t\t\tthis.unbind()\n\n\t\t}\n\n\t\tstatic fromImage(img: TexImageSource, opt: TextureOpt = {}): Texture {\n\t\t\tconst tex = new Texture(0, 0, opt)\n\t\t\ttex.bind()\n\t\t\tgl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, img)\n\t\t\ttex.width = img.width\n\t\t\ttex.height = img.height\n\t\t\ttex.unbind()\n\t\t\treturn tex\n\t\t}\n\n\t\tupdate(x: number, y: number, img: TexImageSource) {\n\t\t\tthis.bind()\n\t\t\tgl.texSubImage2D(gl.TEXTURE_2D, 0, x, y, gl.RGBA, gl.UNSIGNED_BYTE, img)\n\t\t\tthis.unbind()\n\t\t}\n\n\t\tbind() {\n\t\t\tgl.bindTexture(gl.TEXTURE_2D, this.glTex)\n\t\t}\n\n\t\tunbind() {\n\t\t\tgl.bindTexture(gl.TEXTURE_2D, null)\n\t\t}\n\n\t\tfree() {\n\t\t\tgl.deleteTexture(this.glTex)\n\t\t}\n\n\t}\n\n\tconst gfx = (() => {\n\n\t\tconst defShader = makeShader(DEF_VERT, DEF_FRAG)\n\n\t\t// a 1x1 white texture to draw raw shapes like rectangles and polygons\n\t\t// we use a texture for those so we can use only 1 pipeline for drawing sprites + shapes\n\t\tconst emptyTex = Texture.fromImage(\n\t\t\tnew ImageData(new Uint8ClampedArray([ 255, 255, 255, 255 ]), 1, 1),\n\t\t)\n\n\t\tif (gopt.background) {\n\t\t\tconst c = Color.fromArray(gopt.background)\n\t\t\tgl.clearColor(c.r / 255, c.g / 255, c.b / 255, gopt.background[3] ?? 1)\n\t\t}\n\n\t\tgl.enable(gl.BLEND)\n\t\tgl.enable(gl.SCISSOR_TEST)\n\t\tgl.blendFuncSeparate(\n\t\t\tgl.SRC_ALPHA,\n\t\t\tgl.ONE_MINUS_SRC_ALPHA,\n\t\t\tgl.ONE,\n\t\t\tgl.ONE_MINUS_SRC_ALPHA,\n\t\t)\n\n\t\t// we only use one vertex and index buffer that batches all draw calls\n\t\tconst vbuf = gl.createBuffer()\n\n\t\tgl.bindBuffer(gl.ARRAY_BUFFER, vbuf)\n\t\tgl.bufferData(gl.ARRAY_BUFFER, MAX_BATCHED_VERTS * 4, gl.DYNAMIC_DRAW)\n\n\t\tVERTEX_FORMAT.reduce((offset, f, i) => {\n\t\t\tgl.vertexAttribPointer(i, f.size, gl.FLOAT, false, STRIDE * 4, offset)\n\t\t\tgl.enableVertexAttribArray(i)\n\t\t\treturn offset + f.size * 4\n\t\t}, 0)\n\n\t\tgl.bindBuffer(gl.ARRAY_BUFFER, null)\n\n\t\tconst ibuf = gl.createBuffer()\n\n\t\tgl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, ibuf)\n\t\tgl.bufferData(gl.ELEMENT_ARRAY_BUFFER, MAX_BATCHED_INDICES * 4, gl.DYNAMIC_DRAW)\n\t\tgl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, null)\n\n\t\t// a checkerboard texture used for the default background\n\t\tconst bgTex = Texture.fromImage(\n\t\t\tnew ImageData(new Uint8ClampedArray([\n\t\t\t\t128, 128, 128, 255,\n\t\t\t\t190, 190, 190, 255,\n\t\t\t\t190, 190, 190, 255,\n\t\t\t\t128, 128, 128, 255,\n\t\t\t]), 2, 2), {\n\t\t\t\twrap: \"repeat\",\n\t\t\t\tfilter: \"nearest\",\n\t\t\t},\n\t\t)\n\n\t\treturn {\n\n\t\t\t// keep track of how many draw calls we're doing this frame\n\t\t\tdrawCalls: 0,\n\t\t\t// how many draw calls we're doing last frame, this is the number we give to users\n\t\t\tlastDrawCalls: 0,\n\n\t\t\t// gfx states\n\t\t\tdefShader: defShader,\n\t\t\tcurShader: defShader,\n\t\t\tdefTex: emptyTex,\n\t\t\tcurTex: emptyTex,\n\t\t\tcurUniform: {},\n\t\t\tvbuf: vbuf,\n\t\t\tibuf: ibuf,\n\n\t\t\t// local vertex / index buffer queue\n\t\t\tvqueue: [],\n\t\t\tiqueue: [],\n\n\t\t\ttransform: new Mat4(),\n\t\t\ttransformStack: [],\n\n\t\t\tbgTex: bgTex,\n\n\t\t\twidth: gopt.width,\n\t\t\theight: gopt.height,\n\n\t\t\tviewport: {\n\t\t\t\tx: 0,\n\t\t\t\ty: 0,\n\t\t\t\twidth: gl.drawingBufferWidth,\n\t\t\t\theight: gl.drawingBufferHeight,\n\t\t\t},\n\n\t\t}\n\n\t})()\n\n\tclass SpriteData {\n\n\t\ttex: Texture\n\t\tframes: Quad[] = [ new Quad(0, 0, 1, 1) ]\n\t\tanims: SpriteAnims = {}\n\n\t\tconstructor(tex: Texture, frames?: Quad[], anims: SpriteAnims = {}) {\n\t\t\tthis.tex = tex\n\t\t\tif (frames) this.frames = frames\n\t\t\tthis.anims = anims\n\t\t}\n\n\t\tstatic from(src: LoadSpriteSrc, opt: LoadSpriteOpt = {}): Promise<SpriteData> {\n\t\t\treturn typeof src === \"string\"\n\t\t\t\t? SpriteData.fromURL(src, opt)\n\t\t\t\t: Promise.resolve(SpriteData.fromImage(src, opt),\n\t\t\t\t)\n\t\t}\n\n\t\tstatic fromImage(data: TexImageSource, opt: LoadSpriteOpt = {}): SpriteData {\n\t\t\treturn new SpriteData(\n\t\t\t\tTexture.fromImage(data, opt),\n\t\t\t\tslice(opt.sliceX || 1, opt.sliceY || 1),\n\t\t\t\topt.anims ?? {},\n\t\t\t)\n\t\t}\n\n\t\tstatic fromURL(url: string, opt: LoadSpriteOpt = {}): Promise<SpriteData> {\n\t\t\treturn loadImg(url).then((img) => SpriteData.fromImage(img, opt))\n\t\t}\n\n\t}\n\n\tclass SoundData {\n\n\t\tbuf: AudioBuffer\n\n\t\tconstructor(buf: AudioBuffer) {\n\t\t\tthis.buf = buf\n\t\t}\n\n\t\tstatic fromArrayBuffer(buf: ArrayBuffer): Promise<SoundData> {\n\t\t\treturn new Promise((resolve, reject) =>\n\t\t\t\taudio.ctx.decodeAudioData(buf, resolve, reject),\n\t\t\t).then((buf: AudioBuffer) => new SoundData(buf))\n\t\t}\n\n\t\tstatic fromURL(url: string): Promise<SoundData> {\n\t\t\tif (isDataURL(url)) {\n\t\t\t\treturn SoundData.fromArrayBuffer(dataURLToArrayBuffer(url))\n\t\t\t} else {\n\t\t\t\treturn fetchArrayBuffer(url).then((buf) => SoundData.fromArrayBuffer(buf))\n\t\t\t}\n\t\t}\n\n\t}\n\n\tconst audio = (() => {\n\n\t\t// TODO: handle when audio context is unavailable\n\t\tconst ctx = new (\n\t\t\twindow.AudioContext || (window as any).webkitAudioContext\n\t\t)() as AudioContext\n\t\tconst masterNode = ctx.createGain()\n\t\tmasterNode.connect(ctx.destination)\n\n\t\t// by default browsers can only load audio async, we don't deal with that and just start with an empty audio buffer\n\t\tconst burpSnd = new SoundData(createEmptyAudioBuffer(ctx))\n\n\t\t// load that burp sound\n\t\tctx.decodeAudioData(burpSoundSrc.buffer.slice(0)).then((buf) => {\n\t\t\tburpSnd.buf = buf\n\t\t}).catch((err) => {\n\t\t\tconsole.error(\"Failed to load burp: \", err)\n\t\t})\n\n\t\treturn {\n\t\t\tctx,\n\t\t\tmasterNode,\n\t\t\tburpSnd,\n\t\t}\n\n\t})()\n\n\tclass Asset<D> {\n\t\tdone: boolean = false\n\t\tdata: D | null = null\n\t\terror: Error | null = null\n\t\tprivate onLoadEvents: Event<[D]> = new Event()\n\t\tprivate onErrorEvents: Event<[Error]> = new Event()\n\t\tprivate onFinishEvents: Event<[]> = new Event()\n\t\tconstructor(loader: Promise<D>) {\n\t\t\tloader.then((data) => {\n\t\t\t\tthis.data = data\n\t\t\t\tthis.onLoadEvents.trigger(data)\n\t\t\t}).catch((err) => {\n\t\t\t\tthis.error = err\n\t\t\t\tif (this.onErrorEvents.numListeners() > 0) {\n\t\t\t\t\tthis.onErrorEvents.trigger(err)\n\t\t\t\t} else {\n\t\t\t\t\tthrow err\n\t\t\t\t}\n\t\t\t}).finally(() => {\n\t\t\t\tthis.onFinishEvents.trigger()\n\t\t\t\tthis.done = true\n\t\t\t})\n\t\t}\n\t\tstatic loaded<D>(data: D): Asset<D> {\n\t\t\tconst asset = new Asset(Promise.resolve(data))\n\t\t\tasset.data = data\n\t\t\tasset.done = true\n\t\t\treturn asset\n\t\t}\n\t\tonLoad(action: (data: D) => void) {\n\t\t\tthis.onLoadEvents.add(action)\n\t\t\treturn this\n\t\t}\n\t\tonError(action: (err: Error) => void) {\n\t\t\tthis.onErrorEvents.add(action)\n\t\t\treturn this\n\t\t}\n\t\tonFinish(action: () => void) {\n\t\t\tthis.onFinishEvents.add(action)\n\t\t\treturn this\n\t\t}\n\t\tthen(action: (data: D) => void): Asset<D> {\n\t\t\treturn this.onLoad(action)\n\t\t}\n\t\tcatch(action: (err: Error) => void): Asset<D> {\n\t\t\treturn this.onError(action)\n\t\t}\n\t\tfinally(action: () => void): Asset<D> {\n\t\t\treturn this.onFinish(action)\n\t\t}\n\t}\n\n\tclass AssetBucket<D> {\n\t\tassets: Map<string, Asset<D>> = new Map()\n\t\tlastUID: number = 0\n\t\tadd(name: string | null, loader: Promise<D>): Asset<D> {\n\t\t\t// if user don't provide a name we use a generated one\n\t\t\tconst id = name ?? (this.lastUID++ + \"\")\n\t\t\tconst asset = new Asset(loader)\n\t\t\tthis.assets.set(id, asset)\n\t\t\treturn asset\n\t\t}\n\t\taddLoaded(name: string | null, data: D) {\n\t\t\tconst id = name ?? (this.lastUID++ + \"\")\n\t\t\tconst asset = Asset.loaded(data)\n\t\t\tthis.assets.set(id, asset)\n\t\t}\n\t\tget(handle: string): Asset<D> | void {\n\t\t\treturn this.assets.get(handle)\n\t\t}\n\t\tprogress(): number {\n\t\t\tif (this.assets.size === 0) {\n\t\t\t\treturn 1\n\t\t\t}\n\t\t\tlet loaded = 0\n\t\t\tthis.assets.forEach((asset) => {\n\t\t\t\tif (asset.done) {\n\t\t\t\t\tloaded++\n\t\t\t\t}\n\t\t\t})\n\t\t\treturn loaded / this.assets.size\n\t\t}\n\t}\n\n\tconst assets = {\n\t\t// prefix for when loading from a url\n\t\turlPrefix: \"\",\n\t\t// asset holders\n\t\tsprites: new AssetBucket<SpriteData>(),\n\t\tfonts: new AssetBucket<FontData>(),\n\t\tbitmapFonts: new AssetBucket<BitmapFontData>(),\n\t\tsounds: new AssetBucket<SoundData>(),\n\t\tshaders: new AssetBucket<ShaderData>(),\n\t\tcustom: new AssetBucket<any>(),\n\t\t// if we finished initially loading all assets\n\t\tloaded: false,\n\t}\n\n\tconst game = {\n\n\t\t// general events\n\t\tev: new EventHandler(),\n\t\t// object events\n\t\tobjEvents: new EventHandler(),\n\n\t\t// root game object\n\t\troot: make([]),\n\n\t\t// misc\n\t\tgravity: 0,\n\t\tscenes: {},\n\n\t\t// on screen log\n\t\tlogs: [],\n\n\t\t// camera\n\t\tcam: {\n\t\t\tpos: null,\n\t\t\tscale: vec2(1),\n\t\t\tangle: 0,\n\t\t\tshake: 0,\n\t\t\ttransform: new Mat4(),\n\t\t},\n\n\t}\n\n\t// TODO: accept Asset<T>?\n\t// wrap individual loaders with global loader counter, for stuff like progress bar\n\tfunction load<T>(prom: Promise<T>): Asset<T> {\n\t\treturn assets.custom.add(null, prom)\n\t}\n\n\t// get current load progress\n\tfunction loadProgress(): number {\n\t\tconst buckets = [\n\t\t\tassets.sprites,\n\t\t\tassets.sounds,\n\t\t\tassets.shaders,\n\t\t\tassets.fonts,\n\t\t\tassets.bitmapFonts,\n\t\t\tassets.custom,\n\t\t]\n\t\treturn buckets.reduce((n, bucket) => n + bucket.progress(), 0) / buckets.length\n\t}\n\n\t// global load path prefix\n\tfunction loadRoot(path?: string): string {\n\t\tif (path !== undefined) {\n\t\t\tassets.urlPrefix = path\n\t\t}\n\t\treturn assets.urlPrefix\n\t}\n\n\t// wrapper around fetch() that applies urlPrefix and basic error handling\n\tfunction fetchURL(path: string) {\n\t\tconst url = assets.urlPrefix + path\n\t\treturn fetch(url)\n\t\t\t.then((res) => {\n\t\t\t\tif (!res.ok) {\n\t\t\t\t\tthrow new Error(`Failed to fetch ${url}`)\n\t\t\t\t}\n\t\t\t\treturn res\n\t\t\t})\n\t}\n\n\tfunction fetchJSON(path: string) {\n\t\treturn fetchURL(path).then((res) => res.json())\n\t}\n\n\tfunction fetchText(path: string) {\n\t\treturn fetchURL(path).then((res) => res.text())\n\t}\n\n\tfunction fetchArrayBuffer(path: string) {\n\t\treturn fetchURL(path).then((res) => res.arrayBuffer())\n\t}\n\n\t// wrapper around image loader to get a Promise\n\tfunction loadImg(src: string): Promise<HTMLImageElement> {\n\t\tconst img = new Image()\n\t\timg.crossOrigin = \"anonymous\"\n\t\timg.src = isDataURL(src) ? src : assets.urlPrefix + src\n\t\treturn new Promise<HTMLImageElement>((resolve, reject) => {\n\t\t\timg.onload = () => resolve(img)\n\t\t\timg.onerror = () => reject(new Error(`Failed to load image from \"${src}\"`))\n\t\t})\n\t}\n\n\tfunction loadFont(name: string, src: string | ArrayBuffer): Asset<FontData> {\n\t\tconst font = new FontFace(name, typeof src === \"string\" ? `url(${src})` : src)\n\t\tdocument.fonts.add(font)\n\t\treturn assets.fonts.add(name, font.load().catch(() => {\n\t\t\tthrow new Error(`Failed to load font from \"${src}\"`)\n\t\t}))\n\t}\n\n\t// TODO: support LoadSpriteSrc\n\tfunction loadBitmapFont(\n\t\tname: string | null,\n\t\tsrc: string,\n\t\tgw: number,\n\t\tgh: number,\n\t\topt: LoadBitmapFontOpt = {},\n\t): Asset<BitmapFontData> {\n\t\treturn assets.bitmapFonts.add(name, loadImg(src)\n\t\t\t.then((img) => {\n\t\t\t\treturn makeFont(\n\t\t\t\t\tTexture.fromImage(img, opt),\n\t\t\t\t\tgw,\n\t\t\t\t\tgh,\n\t\t\t\t\topt.chars ?? ASCII_CHARS,\n\t\t\t\t)\n\t\t\t}),\n\t\t)\n\t}\n\n\t// get an array of frames based on configuration on how to slice the image\n\tfunction slice(x = 1, y = 1, dx = 0, dy = 0, w = 1, h = 1): Quad[] {\n\t\tconst frames = []\n\t\tconst qw = w / x\n\t\tconst qh = h / y\n\t\tfor (let j = 0; j < y; j++) {\n\t\t\tfor (let i = 0; i < x; i++) {\n\t\t\t\tframes.push(new Quad(\n\t\t\t\t\tdx + i * qw,\n\t\t\t\t\tdy + j * qh,\n\t\t\t\t\tqw,\n\t\t\t\t\tqh,\n\t\t\t\t))\n\t\t\t}\n\t\t}\n\t\treturn frames\n\t}\n\n\tfunction loadSpriteAtlas(\n\t\tsrc: LoadSpriteSrc,\n\t\tdata: SpriteAtlasData | string,\n\t): Asset<Record<string, SpriteData>> {\n\t\tif (typeof data === \"string\") {\n\t\t\treturn load(new Promise((res, rej) => {\n\t\t\t\tfetchJSON(data).then((data2) => {\n\t\t\t\t\tloadSpriteAtlas(src, data2).then(res).catch(rej)\n\t\t\t\t})\n\t\t\t}))\n\t\t}\n\t\treturn load(SpriteData.from(src).then((atlas) => {\n\t\t\tconst map = {}\n\t\t\tfor (const name in data) {\n\t\t\t\tconst w = atlas.tex.width\n\t\t\t\tconst h = atlas.tex.height\n\t\t\t\tconst info = data[name]\n\t\t\t\tconst spr = new SpriteData(\n\t\t\t\t\tatlas.tex,\n\t\t\t\t\tslice(\n\t\t\t\t\t\tinfo.sliceX,\n\t\t\t\t\t\tinfo.sliceY,\n\t\t\t\t\t\tinfo.x / w,\n\t\t\t\t\t\tinfo.y / h,\n\t\t\t\t\t\tinfo.width / w,\n\t\t\t\t\t\tinfo.height / h,\n\t\t\t\t\t),\n\t\t\t\t\tinfo.anims,\n\t\t\t\t)\n\t\t\t\tassets.sprites.addLoaded(name, spr)\n\t\t\t\tmap[name] = spr\n\t\t\t}\n\t\t\treturn map\n\t\t}))\n\t}\n\n\t// load a sprite to asset manager\n\tfunction loadSprite(\n\t\tname: string | null,\n\t\tsrc: LoadSpriteSrc,\n\t\topt: LoadSpriteOpt = {\n\t\t\tsliceX: 1,\n\t\t\tsliceY: 1,\n\t\t\tanims: {},\n\t\t},\n\t): Asset<SpriteData> {\n\t\treturn assets.sprites.add(\n\t\t\tname,\n\t\t\ttypeof src === \"string\"\n\t\t\t\t? SpriteData.fromURL(src, opt)\n\t\t\t\t: Promise.resolve(SpriteData.fromImage(src, opt),\n\t\t\t\t),\n\t\t)\n\t}\n\n\tfunction loadPedit(name: string | null, src: string | PeditFile): Asset<SpriteData> {\n\n\t\t// eslint-disable-next-line\n\t\treturn assets.sprites.add(name, new Promise(async (resolve) => {\n\n\t\t\tconst data = typeof src === \"string\" ? await fetchJSON(src) : src\n\t\t\tconst images = await Promise.all(data.frames.map(loadImg))\n\t\t\tconst canvas = document.createElement(\"canvas\")\n\t\t\tcanvas.width = data.width\n\t\t\tcanvas.height = data.height * data.frames.length\n\n\t\t\tconst ctx = canvas.getContext(\"2d\")\n\n\t\t\timages.forEach((img: HTMLImageElement, i) => {\n\t\t\t\tctx.drawImage(img, 0, i * data.height)\n\t\t\t})\n\n\t\t\tconst spr = await loadSprite(null, canvas, {\n\t\t\t\tsliceY: data.frames.length,\n\t\t\t\tanims: data.anims,\n\t\t\t})\n\n\t\t\tresolve(spr)\n\n\t\t}))\n\n\t}\n\n\tfunction loadAseprite(\n\t\tname: string | null,\n\t\timgSrc: LoadSpriteSrc,\n\t\tjsonSrc: string,\n\t): Asset<SpriteData> {\n\t\t// eslint-disable-next-line\n\t\treturn assets.sprites.add(name, new Promise(async (resolve) => {\n\t\t\tconst spr = await loadSprite(null, imgSrc)\n\t\t\tconst data = typeof jsonSrc === \"string\" ? await fetchJSON(jsonSrc) : jsonSrc\n\t\t\tconst size = data.meta.size\n\t\t\tspr.frames = data.frames.map((f: any) => {\n\t\t\t\treturn new Quad(\n\t\t\t\t\tf.frame.x / size.w,\n\t\t\t\t\tf.frame.y / size.h,\n\t\t\t\t\tf.frame.w / size.w,\n\t\t\t\t\tf.frame.h / size.h,\n\t\t\t\t)\n\t\t\t})\n\t\t\tfor (const anim of data.meta.frameTags) {\n\t\t\t\tif (anim.from === anim.to) {\n\t\t\t\t\tspr.anims[anim.name] = anim.from\n\t\t\t\t} else {\n\t\t\t\t\tspr.anims[anim.name] = {\n\t\t\t\t\t\tfrom: anim.from,\n\t\t\t\t\t\tto: anim.to,\n\t\t\t\t\t\tspeed: 10,\n\t\t\t\t\t\tloop: true,\n\t\t\t\t\t\tpingpong: anim.direction === \"pingpong\",\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tresolve(spr)\n\t\t}))\n\t}\n\n\tfunction loadShader(\n\t\tname: string | null,\n\t\tvert?: string,\n\t\tfrag?: string,\n\t\tisUrl: boolean = false,\n\t): Asset<ShaderData> {\n\n\t\treturn assets.shaders.add(name, new Promise<ShaderData>((resolve, reject) => {\n\n\t\t\tconst resolveUrl = (url?: string) =>\n\t\t\t\turl\n\t\t\t\t\t? fetchText(url)\n\t\t\t\t\t: new Promise((r) => r(null))\n\n\t\t\tif (isUrl) {\n\t\t\t\tPromise.all([resolveUrl(vert), resolveUrl(frag)])\n\t\t\t\t\t.then(([vcode, fcode]: [string | null, string | null]) => {\n\t\t\t\t\t\tresolve(makeShader(vcode, fcode))\n\t\t\t\t\t})\n\t\t\t\t\t.catch(reject)\n\t\t\t} else {\n\t\t\t\ttry {\n\t\t\t\t\tresolve(makeShader(vert, frag))\n\t\t\t\t} catch (err) {\n\t\t\t\t\treject(err)\n\t\t\t\t}\n\t\t\t}\n\n\t\t}))\n\n\t}\n\n\t// load a sound to asset manager\n\tfunction loadSound(\n\t\tname: string | null,\n\t\tsrc: string | ArrayBuffer,\n\t): Asset<SoundData> {\n\t\treturn assets.sounds.add(\n\t\t\tname,\n\t\t\ttypeof src === \"string\"\n\t\t\t\t? SoundData.fromURL(src)\n\t\t\t\t: SoundData.fromArrayBuffer(src),\n\t\t)\n\t}\n\n\tfunction loadBean(name: string = \"bean\"): Asset<SpriteData> {\n\t\treturn loadSprite(name, beanSpriteSrc)\n\t}\n\n\tfunction getSprite(handle: string): Asset<SpriteData> | void {\n\t\treturn assets.sprites.get(handle)\n\t}\n\n\tfunction getSound(handle: string): Asset<SoundData> | void {\n\t\treturn assets.sounds.get(handle)\n\t}\n\n\tfunction getFont(handle: string): Asset<FontData> | void {\n\t\treturn assets.fonts.get(handle)\n\t}\n\n\tfunction getBitmapFont(handle: string): Asset<BitmapFontData> | void {\n\t\treturn assets.bitmapFonts.get(handle)\n\t}\n\n\tfunction getShader(handle: string): Asset<ShaderData> | void {\n\t\treturn assets.shaders.get(handle)\n\t}\n\n\tfunction resolveSprite(\n\t\tsrc: DrawSpriteOpt[\"sprite\"],\n\t): Asset<SpriteData> | null {\n\t\tif (typeof src === \"string\") {\n\t\t\tconst spr = getSprite(src)\n\t\t\tif (spr) {\n\t\t\t\t// if it's already loaded or being loading, return it\n\t\t\t\treturn spr\n\t\t\t} else if (loadProgress() < 1) {\n\t\t\t\t// if there's any other ongoing loading task we return empty and don't error yet\n\t\t\t\treturn null\n\t\t\t} else {\n\t\t\t\t// if all other assets are loaded and we still haven't found this sprite, throw\n\t\t\t\tthrow new Error(`Sprite not found: ${src}`)\n\t\t\t}\n\t\t} else if (src instanceof SpriteData) {\n\t\t\treturn Asset.loaded(src)\n\t\t} else if (src instanceof Asset) {\n\t\t\treturn src\n\t\t} else {\n\t\t\tthrow new Error(`Invalid sprite: ${src}`)\n\t\t}\n\t}\n\n\tfunction resolveSound(\n\t\tsrc: Parameters<typeof play>[0],\n\t): SoundData | Asset<SoundData> | null {\n\t\tif (typeof src === \"string\") {\n\t\t\tconst snd = getSound(src)\n\t\t\tif (snd) {\n\t\t\t\treturn snd.data ? snd.data : snd\n\t\t\t} else if (loadProgress() < 1) {\n\t\t\t\treturn null\n\t\t\t} else {\n\t\t\t\tthrow new Error(`Sound not found: ${src}`)\n\t\t\t}\n\t\t} else if (src instanceof SoundData) {\n\t\t\treturn src\n\t\t} else if (src instanceof Asset) {\n\t\t\treturn src.data ? src.data : src\n\t\t} else {\n\t\t\tthrow new Error(`Invalid sound: ${src}`)\n\t\t}\n\t}\n\n\tfunction resolveShader(\n\t\tsrc: RenderProps[\"shader\"],\n\t): ShaderData | Asset<ShaderData> | null {\n\t\tif (!src) {\n\t\t\treturn gfx.defShader\n\t\t}\n\t\tif (typeof src === \"string\") {\n\t\t\tconst shader = getShader(src)\n\t\t\tif (shader) {\n\t\t\t\treturn shader.data ? shader.data : shader\n\t\t\t} else if (loadProgress() < 1) {\n\t\t\t\treturn null\n\t\t\t} else {\n\t\t\t\tthrow new Error(`Shader not found: ${src}`)\n\t\t\t}\n\t\t} else if (src instanceof Asset) {\n\t\t\treturn src.data ? src.data : src\n\t\t}\n\t\t// TODO: check type\n\t\t// @ts-ignore\n\t\treturn src\n\t}\n\n\tfunction resolveFont(\n\t\tsrc: DrawTextOpt[\"font\"],\n\t):\n\t\t| FontData\n\t\t| Asset<FontData>\n\t\t| BitmapFontData\n\t\t| Asset<BitmapFontData>\n\t\t| string\n\t\t| void\n\t{\n\t\tif (!src) {\n\t\t\treturn resolveFont(gopt.font ?? DEF_FONT)\n\t\t}\n\t\tif (typeof src === \"string\") {\n\t\t\tconst font = getBitmapFont(src)\n\t\t\tif (font) {\n\t\t\t\treturn font.data ? font.data : font\n\t\t\t} else if (document.fonts.check(`${DEF_TEXT_CACHE_SIZE}px ${src}`)) {\n\t\t\t\treturn src\n\t\t\t} else if (loadProgress() < 1) {\n\t\t\t\treturn null\n\t\t\t} else {\n\t\t\t\tthrow new Error(`Font not found: ${src}`)\n\t\t\t}\n\t\t} else if (src instanceof Asset) {\n\t\t\treturn src.data ? src.data : src\n\t\t}\n\t\t// TODO: check type\n\t\t// @ts-ignore\n\t\treturn src\n\t}\n\n\t// get / set master volume\n\tfunction volume(v?: number): number {\n\t\tif (v !== undefined) {\n\t\t\taudio.masterNode.gain.value = clamp(v, MIN_GAIN, MAX_GAIN)\n\t\t}\n\t\treturn audio.masterNode.gain.value\n\t}\n\n\t// plays a sound, returns a control handle\n\tfunction play(\n\t\tsrc: string | SoundData | Asset<SoundData>,\n\t\topt: AudioPlayOpt = {\n\t\t\tloop: false,\n\t\t\tvolume: 1,\n\t\t\tspeed: 1,\n\t\t\tdetune: 0,\n\t\t\tseek: 0,\n\t\t},\n\t): AudioPlay {\n\n\t\tconst snd = resolveSound(src)\n\n\t\tif (snd instanceof Asset) {\n\t\t\tconst pb = play(new SoundData(createEmptyAudioBuffer(audio.ctx)))\n\t\t\tconst doPlay = (snd: SoundData) => {\n\t\t\t\tconst pb2 = play(snd, opt)\n\t\t\t\tfor (const k in pb2) {\n\t\t\t\t\tpb[k] = pb2[k]\n\t\t\t\t}\n\t\t\t}\n\t\t\tsnd.onLoad(doPlay)\n\t\t\treturn pb\n\t\t} else if (snd === null) {\n\t\t\tconst pb = play(new SoundData(createEmptyAudioBuffer(audio.ctx)))\n\t\t\tonLoad(() => {\n\t\t\t\t// TODO: check again when every asset is loaded\n\t\t\t})\n\t\t\treturn pb\n\t\t}\n\n\t\tconst ctx = audio.ctx\n\t\tlet stopped = false\n\t\tlet srcNode = ctx.createBufferSource()\n\n\t\tsrcNode.buffer = snd.buf\n\t\tsrcNode.loop = opt.loop ? true : false\n\n\t\tconst gainNode = ctx.createGain()\n\n\t\tsrcNode.connect(gainNode)\n\t\tgainNode.connect(audio.masterNode)\n\n\t\tconst pos = opt.seek ?? 0\n\n\t\tsrcNode.start(0, pos)\n\n\t\tlet startTime = ctx.currentTime - pos\n\t\tlet stopTime: number | null = null\n\n\t\tconst handle = {\n\n\t\t\tstop() {\n\t\t\t\tif (stopped) {\n\t\t\t\t\treturn\n\t\t\t\t}\n\t\t\t\tthis.pause()\n\t\t\t\tstartTime = ctx.currentTime\n\t\t\t},\n\n\t\t\tplay(seek?: number) {\n\n\t\t\t\tif (!stopped) {\n\t\t\t\t\treturn\n\t\t\t\t}\n\n\t\t\t\tconst oldNode = srcNode\n\n\t\t\t\tsrcNode = ctx.createBufferSource()\n\t\t\t\tsrcNode.buffer = oldNode.buffer\n\t\t\t\tsrcNode.loop = oldNode.loop\n\t\t\t\tsrcNode.playbackRate.value = oldNode.playbackRate.value\n\n\t\t\t\tif (srcNode.detune) {\n\t\t\t\t\tsrcNode.detune.value = oldNode.detune.value\n\t\t\t\t}\n\n\t\t\t\tsrcNode.connect(gainNode)\n\n\t\t\t\tconst pos = seek ?? this.time()\n\n\t\t\t\tsrcNode.start(0, pos)\n\t\t\t\tstartTime = ctx.currentTime - pos\n\t\t\t\tstopped = false\n\t\t\t\tstopTime = null\n\n\t\t\t},\n\n\t\t\tpause() {\n\t\t\t\tif (stopped) {\n\t\t\t\t\treturn\n\t\t\t\t}\n\t\t\t\tsrcNode.stop()\n\t\t\t\tstopped = true\n\t\t\t\tstopTime = ctx.currentTime\n\t\t\t},\n\n\t\t\tisPaused(): boolean {\n\t\t\t\treturn stopped\n\t\t\t},\n\n\t\t\tisStopped(): boolean {\n\t\t\t\treturn stopped\n\t\t\t},\n\n\t\t\t// TODO: affect time()\n\t\t\tspeed(val?: number): number {\n\t\t\t\tif (val !== undefined) {\n\t\t\t\t\tsrcNode.playbackRate.value = clamp(val, MIN_SPEED, MAX_SPEED)\n\t\t\t\t}\n\t\t\t\treturn srcNode.playbackRate.value\n\t\t\t},\n\n\t\t\tdetune(val?: number): number {\n\t\t\t\tif (!srcNode.detune) {\n\t\t\t\t\treturn 0\n\t\t\t\t}\n\t\t\t\tif (val !== undefined) {\n\t\t\t\t\tsrcNode.detune.value = clamp(val, MIN_DETUNE, MAX_DETUNE)\n\t\t\t\t}\n\t\t\t\treturn srcNode.detune.value\n\t\t\t},\n\n\t\t\tvolume(val?: number): number {\n\t\t\t\tif (val !== undefined) {\n\t\t\t\t\tgainNode.gain.value = clamp(val, MIN_GAIN, MAX_GAIN)\n\t\t\t\t}\n\t\t\t\treturn gainNode.gain.value\n\t\t\t},\n\n\t\t\tloop() {\n\t\t\t\tsrcNode.loop = true\n\t\t\t},\n\n\t\t\tunloop() {\n\t\t\t\tsrcNode.loop = false\n\t\t\t},\n\n\t\t\tduration(): number {\n\t\t\t\treturn snd.buf.duration\n\t\t\t},\n\n\t\t\ttime(): number {\n\t\t\t\tif (stopped) {\n\t\t\t\t\treturn stopTime - startTime\n\t\t\t\t} else {\n\t\t\t\t\treturn ctx.currentTime - startTime\n\t\t\t\t}\n\t\t\t},\n\n\t\t}\n\n\t\thandle.speed(opt.speed)\n\t\thandle.detune(opt.detune)\n\t\thandle.volume(opt.volume)\n\n\t\treturn handle\n\n\t}\n\n\t// core kaboom logic\n\tfunction burp(opt?: AudioPlayOpt): AudioPlay {\n\t\treturn play(audio.burpSnd, opt)\n\t}\n\n\ttype DrawTextureOpt = RenderProps & {\n\t\ttex: Texture,\n\t\twidth?: number,\n\t\theight?: number,\n\t\ttiled?: boolean,\n\t\tflipX?: boolean,\n\t\tflipY?: boolean,\n\t\tquad?: Quad,\n\t\tanchor?: Anchor | Vec2,\n\t}\n\n\tfunction makeShader(\n\t\tvertSrc: string | null = DEF_VERT,\n\t\tfragSrc: string | null = DEF_FRAG,\n\t): GfxShader {\n\n\t\tconst vcode = VERT_TEMPLATE.replace(\"{{user}}\", vertSrc ?? DEF_VERT)\n\t\tconst fcode = FRAG_TEMPLATE.replace(\"{{user}}\", fragSrc ?? DEF_FRAG)\n\t\tconst vertShader = gl.createShader(gl.VERTEX_SHADER)\n\t\tconst fragShader = gl.createShader(gl.FRAGMENT_SHADER)\n\n\t\tgl.shaderSource(vertShader, vcode)\n\t\tgl.shaderSource(fragShader, fcode)\n\t\tgl.compileShader(vertShader)\n\t\tgl.compileShader(fragShader)\n\n\t\tconst prog = gl.createProgram()\n\n\t\tgc.push(() => gl.deleteProgram(prog))\n\t\tgl.attachShader(prog, vertShader)\n\t\tgl.attachShader(prog, fragShader)\n\n\t\tgl.bindAttribLocation(prog, 0, \"a_pos\")\n\t\tgl.bindAttribLocation(prog, 1, \"a_uv\")\n\t\tgl.bindAttribLocation(prog, 2, \"a_color\")\n\n\t\tgl.linkProgram(prog)\n\n\t\tif (!gl.getProgramParameter(prog, gl.LINK_STATUS)) {\n\n\t\t\tconst formatShaderError = (msg: string) => {\n\t\t\t\tconst FMT = /^ERROR:\\s0:(?<line>\\d+):\\s(?<msg>.+)/\n\t\t\t\tconst match = msg.match(FMT)\n\t\t\t\treturn {\n\t\t\t\t\tline: Number(match.groups.line),\n\t\t\t\t\t// seem to be a \\n\\0 at the end of error messages, causing unwanted line break\n\t\t\t\t\tmsg: match.groups.msg.replace(/\\n\\0$/, \"\"),\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst vertError = gl.getShaderInfoLog(vertShader)\n\t\t\tconst fragError = gl.getShaderInfoLog(fragShader)\n\t\t\tlet msg = \"\"\n\n\t\t\tif (vertError) {\n\t\t\t\tconst err = formatShaderError(vertError)\n\t\t\t\tmsg += `Vertex shader line ${err.line - 14}: ${err.msg}`\n\t\t\t}\n\n\t\t\tif (fragError) {\n\t\t\t\tconst err = formatShaderError(fragError)\n\t\t\t\tmsg += `Fragment shader line ${err.line - 14}: ${err.msg}`\n\t\t\t}\n\n\t\t\tthrow new Error(msg)\n\n\t\t}\n\n\t\tgl.deleteShader(vertShader)\n\t\tgl.deleteShader(fragShader)\n\n\t\treturn {\n\n\t\t\tbind() {\n\t\t\t\tgl.useProgram(prog)\n\t\t\t},\n\n\t\t\tunbind() {\n\t\t\t\tgl.useProgram(null)\n\t\t\t},\n\n\t\t\tfree() {\n\t\t\t\tgl.deleteProgram(prog)\n\t\t\t},\n\n\t\t\tsend(uniform: Uniform) {\n\t\t\t\tfor (const name in uniform) {\n\t\t\t\t\tconst val = uniform[name]\n\t\t\t\t\tconst loc = gl.getUniformLocation(prog, name)\n\t\t\t\t\tif (typeof val === \"number\") {\n\t\t\t\t\t\tgl.uniform1f(loc, val)\n\t\t\t\t\t} else if (val instanceof Mat4) {\n\t\t\t\t\t\tgl.uniformMatrix4fv(loc, false, new Float32Array(val.m))\n\t\t\t\t\t} else if (val instanceof Color) {\n\t\t\t\t\t\t// TODO: opacity?\n\t\t\t\t\t\tgl.uniform3f(loc, val.r, val.g, val.b)\n\t\t\t\t\t} else if (val instanceof Vec3) {\n\t\t\t\t\t\tgl.uniform3f(loc, val.x, val.y, val.z)\n\t\t\t\t\t} else if (val instanceof Vec2) {\n\t\t\t\t\t\tgl.uniform2f(loc, val.x, val.y)\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t},\n\n\t\t}\n\n\t}\n\n\tfunction makeFont(\n\t\ttex: Texture,\n\t\tgw: number,\n\t\tgh: number,\n\t\tchars: string,\n\t): GfxFont {\n\n\t\tconst cols = tex.width / gw\n\t\tconst map: Record<string, Quad> = {}\n\t\tconst charMap = chars.split(\"\").entries()\n\n\t\tfor (const [i, ch] of charMap) {\n\t\t\tmap[ch] = new Quad(\n\t\t\t\t(i % cols) * gw,\n\t\t\t\tMath.floor(i / cols) * gh,\n\t\t\t\tgw,\n\t\t\t\tgh,\n\t\t\t)\n\t\t}\n\n\t\treturn {\n\t\t\ttex: tex,\n\t\t\tmap: map,\n\t\t\tsize: gh,\n\t\t}\n\n\t}\n\n\t// TODO: expose\n\tfunction drawRaw(\n\t\tverts: Vertex[],\n\t\tindices: number[],\n\t\tfixed: boolean,\n\t\ttex: Texture = gfx.defTex,\n\t\tshaderSrc: RenderProps[\"shader\"] = gfx.defShader,\n\t\tuniform: Uniform = {},\n\t) {\n\n\t\tconst shader = resolveShader(shaderSrc)\n\n\t\tif (!shader || shader instanceof Asset) {\n\t\t\treturn\n\t\t}\n\n\t\t// flush on texture / shader change and overflow\n\t\tif (\n\t\t\ttex !== gfx.curTex\n\t\t\t|| shader !== gfx.curShader\n\t\t\t|| !deepEq(gfx.curUniform, uniform)\n\t\t\t|| gfx.vqueue.length + verts.length * STRIDE > MAX_BATCHED_VERTS\n\t\t\t|| gfx.iqueue.length + indices.length > MAX_BATCHED_INDICES\n\t\t) {\n\t\t\tflush()\n\t\t}\n\n\t\tfor (const v of verts) {\n\n\t\t\t// TODO: cache camTransform * gfxTransform?\n\t\t\tconst transform = fixed ? gfx.transform : game.cam.transform.mult(gfx.transform)\n\n\t\t\t// normalized world space coordinate [-1.0 ~ 1.0]\n\t\t\tconst pt = screen2ndc(transform.multVec2(v.pos.xy()))\n\n\t\t\tgfx.vqueue.push(\n\t\t\t\tpt.x, pt.y, v.pos.z,\n\t\t\t\tv.uv.x, v.uv.y,\n\t\t\t\tv.color.r / 255, v.color.g / 255, v.color.b / 255, v.opacity,\n\t\t\t)\n\n\t\t}\n\n\t\tfor (const i of indices) {\n\t\t\tgfx.iqueue.push(i + gfx.vqueue.length / STRIDE - verts.length)\n\t\t}\n\n\t\tgfx.curTex = tex\n\t\tgfx.curShader = shader\n\t\tgfx.curUniform = uniform\n\n\t}\n\n\t// draw all batched shapes\n\tfunction flush() {\n\n\t\tif (\n\t\t\t!gfx.curTex\n\t\t\t|| !gfx.curShader\n\t\t\t|| gfx.vqueue.length === 0\n\t\t\t|| gfx.iqueue.length === 0\n\t\t) {\n\t\t\treturn\n\t\t}\n\n\t\tgl.bindBuffer(gl.ARRAY_BUFFER, gfx.vbuf)\n\t\tgl.bufferSubData(gl.ARRAY_BUFFER, 0, new Float32Array(gfx.vqueue))\n\t\tgl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, gfx.ibuf)\n\t\tgl.bufferSubData(gl.ELEMENT_ARRAY_BUFFER, 0, new Uint16Array(gfx.iqueue))\n\t\tgfx.curShader.bind()\n\t\tgfx.curShader.send(gfx.curUniform)\n\t\tgfx.curTex.bind()\n\t\tgl.drawElements(gl.TRIANGLES, gfx.iqueue.length, gl.UNSIGNED_SHORT, 0)\n\t\tgfx.curTex.unbind()\n\t\tgfx.curShader.unbind()\n\t\tgl.bindBuffer(gl.ARRAY_BUFFER, null)\n\t\tgl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, null)\n\n\t\tgfx.vqueue = []\n\t\tgfx.iqueue = []\n\n\t\tgfx.drawCalls++\n\n\t}\n\n\t// start a rendering frame, reset some states\n\tfunction frameStart() {\n\n\t\t// running this every frame now mainly because isFullscreen() is not updated real time when requested fullscreen\n\t\tupdateViewport()\n\n\t\tgl.clear(gl.COLOR_BUFFER_BIT)\n\n\t\tif (!gopt.background) {\n\t\t\tdrawUnscaled(() => {\n\t\t\t\tdrawUVQuad({\n\t\t\t\t\twidth: width(),\n\t\t\t\t\theight: height(),\n\t\t\t\t\tquad: new Quad(\n\t\t\t\t\t\t0,\n\t\t\t\t\t\t0,\n\t\t\t\t\t\twidth() / BG_GRID_SIZE,\n\t\t\t\t\t\theight() / BG_GRID_SIZE,\n\t\t\t\t\t),\n\t\t\t\t\ttex: gfx.bgTex,\n\t\t\t\t\tfixed: true,\n\t\t\t\t})\n\t\t\t})\n\t\t}\n\n\t\tgfx.drawCalls = 0\n\t\tgfx.transformStack = []\n\t\tgfx.transform = new Mat4()\n\n\t}\n\n\tfunction frameEnd() {\n\t\tflush()\n\t\tgfx.lastDrawCalls = gfx.drawCalls\n\t}\n\n\t// convert a screen space coordinate to webgl normalized device coordinate\n\tfunction screen2ndc(pt: Vec2): Vec2 {\n\t\treturn vec2(\n\t\t\tpt.x / width() * 2 - 1,\n\t\t\t-pt.y / height() * 2 + 1,\n\t\t)\n\t}\n\n\tfunction pushMatrix(m: Mat4) {\n\t\tgfx.transform = m.clone()\n\t}\n\n\tfunction pushTranslate(...args) {\n\t\tif (args[0] === undefined) return\n\t\tconst p = vec2(...args)\n\t\tif (p.x === 0 && p.y === 0) return\n\t\tgfx.transform = gfx.transform.translate(p)\n\t}\n\n\tfunction pushScale(...args) {\n\t\tif (args[0] === undefined) return\n\t\tconst p = vec2(...args)\n\t\tif (p.x === 1 && p.y === 1) return\n\t\tgfx.transform = gfx.transform.scale(p)\n\t}\n\n\tfunction pushRotateX(a: number) {\n\t\tif (!a) {\n\t\t\treturn\n\t\t}\n\t\tgfx.transform = gfx.transform.rotateX(a)\n\t}\n\n\tfunction pushRotateY(a: number) {\n\t\tif (!a) {\n\t\t\treturn\n\t\t}\n\t\tgfx.transform = gfx.transform.rotateY(a)\n\t}\n\n\tfunction pushRotateZ(a: number) {\n\t\tif (!a) {\n\t\t\treturn\n\t\t}\n\t\tgfx.transform = gfx.transform.rotateZ(a)\n\t}\n\n\tconst pushRotate = pushRotateZ\n\n\tfunction pushTransform() {\n\t\tgfx.transformStack.push(gfx.transform.clone())\n\t}\n\n\tfunction popTransform() {\n\t\tif (gfx.transformStack.length > 0) {\n\t\t\tgfx.transform = gfx.transformStack.pop()\n\t\t}\n\t}\n\n\t// draw a uv textured quad\n\tfunction drawUVQuad(opt: DrawUVQuadOpt) {\n\n\t\tif (opt.width === undefined || opt.height === undefined) {\n\t\t\tthrow new Error(\"drawUVQuad() requires property \\\"width\\\" and \\\"height\\\".\")\n\t\t}\n\n\t\tif (opt.width <= 0 || opt.height <= 0) {\n\t\t\treturn\n\t\t}\n\n\t\tconst w = opt.width\n\t\tconst h = opt.height\n\t\tconst anchor = anchorPt(opt.anchor || DEF_ANCHOR)\n\t\tconst offset = anchor.scale(vec2(w, h).scale(-0.5))\n\t\tconst q = opt.quad || new Quad(0, 0, 1, 1)\n\t\tconst color = opt.color || rgb(255, 255, 255)\n\t\tconst opacity = opt.opacity ?? 1\n\n\t\t// apply uv padding to avoid artifacts\n\t\tconst uvPadX = opt.tex ? UV_PAD / opt.tex.width : 0\n\t\tconst uvPadY = opt.tex ? UV_PAD / opt.tex.height : 0\n\t\tconst qx = q.x + uvPadX\n\t\tconst qy = q.y + uvPadY\n\t\tconst qw = q.w - uvPadX * 2\n\t\tconst qh = q.h - uvPadY * 2\n\n\t\tpushTransform()\n\t\tpushTranslate(opt.pos)\n\t\tpushRotateZ(opt.angle)\n\t\tpushScale(opt.scale)\n\t\tpushTranslate(offset)\n\n\t\tdrawRaw([\n\t\t\t{\n\t\t\t\tpos: vec3(-w / 2, h / 2, 0),\n\t\t\t\tuv: vec2(opt.flipX ? qx + qw : qx, opt.flipY ? qy : qy + qh),\n\t\t\t\tcolor: color,\n\t\t\t\topacity: opacity,\n\t\t\t},\n\t\t\t{\n\t\t\t\tpos: vec3(-w / 2, -h / 2, 0),\n\t\t\t\tuv: vec2(opt.flipX ? qx + qw : qx, opt.flipY ? qy + qh : qy),\n\t\t\t\tcolor: color,\n\t\t\t\topacity: opacity,\n\t\t\t},\n\t\t\t{\n\t\t\t\tpos: vec3(w / 2, -h / 2, 0),\n\t\t\t\tuv: vec2(opt.flipX ? qx : qx + qw, opt.flipY ? qy + qh : qy),\n\t\t\t\tcolor: color,\n\t\t\t\topacity: opacity,\n\t\t\t},\n\t\t\t{\n\t\t\t\tpos: vec3(w / 2, h / 2, 0),\n\t\t\t\tuv: vec2(opt.flipX ? qx : qx + qw, opt.flipY ? qy : qy + qh),\n\t\t\t\tcolor: color,\n\t\t\t\topacity: opacity,\n\t\t\t},\n\t\t], [0, 1, 3, 1, 2, 3], opt.fixed, opt.tex, opt.shader, opt.uniform)\n\n\t\tpopTransform()\n\n\t}\n\n\t// TODO: clean\n\tfunction drawTexture(opt: DrawTextureOpt) {\n\n\t\tif (!opt.tex) {\n\t\t\tthrow new Error(\"drawTexture() requires property \\\"tex\\\".\")\n\t\t}\n\n\t\tconst q = opt.quad ?? new Quad(0, 0, 1, 1)\n\t\tconst w = opt.tex.width * q.w\n\t\tconst h = opt.tex.height * q.h\n\t\tconst scale = vec2(1)\n\n\t\tif (opt.tiled) {\n\n\t\t\t// TODO: draw fract\n\t\t\tconst repX = Math.ceil((opt.width || w) / w)\n\t\t\tconst repY = Math.ceil((opt.height || h) / h)\n\t\t\tconst anchor = anchorPt(opt.anchor || DEF_ANCHOR).add(vec2(1, 1)).scale(0.5)\n\t\t\tconst offset = anchor.scale(repX * w, repY * h)\n\n\t\t\t// TODO: rotation\n\t\t\tfor (let i = 0; i < repX; i++) {\n\t\t\t\tfor (let j = 0; j < repY; j++) {\n\t\t\t\t\tdrawUVQuad({\n\t\t\t\t\t\t...opt,\n\t\t\t\t\t\tpos: (opt.pos || vec2(0)).add(vec2(w * i, h * j)).sub(offset),\n\t\t\t\t\t\tscale: scale.scale(opt.scale || vec2(1)),\n\t\t\t\t\t\ttex: opt.tex,\n\t\t\t\t\t\tquad: q,\n\t\t\t\t\t\twidth: w,\n\t\t\t\t\t\theight: h,\n\t\t\t\t\t\tanchor: \"topleft\",\n\t\t\t\t\t})\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\n\t\t\t// TODO: should this ignore scale?\n\t\t\tif (opt.width && opt.height) {\n\t\t\t\tscale.x = opt.width / w\n\t\t\t\tscale.y = opt.height / h\n\t\t\t} else if (opt.width) {\n\t\t\t\tscale.x = opt.width / w\n\t\t\t\tscale.y = scale.x\n\t\t\t} else if (opt.height) {\n\t\t\t\tscale.y = opt.height / h\n\t\t\t\tscale.x = scale.y\n\t\t\t}\n\n\t\t\tdrawUVQuad({\n\t\t\t\t...opt,\n\t\t\t\tscale: scale.scale(opt.scale || vec2(1)),\n\t\t\t\ttex: opt.tex,\n\t\t\t\tquad: q,\n\t\t\t\twidth: w,\n\t\t\t\theight: h,\n\t\t\t})\n\n\t\t}\n\n\t}\n\n\tfunction drawSprite(opt: DrawSpriteOpt) {\n\n\t\tif (!opt.sprite) {\n\t\t\tthrow new Error(\"drawSprite() requires property \\\"sprite\\\"\")\n\t\t}\n\n\t\tconst spr = resolveSprite(opt.sprite)\n\n\t\tif (!spr || !spr.data) {\n\t\t\treturn\n\t\t}\n\n\t\tconst q = spr.data.frames[opt.frame ?? 0]\n\n\t\tif (!q) {\n\t\t\tthrow new Error(`Frame not found: ${opt.frame ?? 0}`)\n\t\t}\n\n\t\tdrawTexture({\n\t\t\t...opt,\n\t\t\ttex: spr.data.tex,\n\t\t\tquad: q.scale(opt.quad || new Quad(0, 0, 1, 1)),\n\t\t})\n\n\t}\n\n\t// generate vertices to form an arc\n\tfunction getArcPts(\n\t\tpos: Vec2,\n\t\tradiusX: number,\n\t\tradiusY: number,\n\t\tstart: number,\n\t\tend: number,\n\t\tres: number = 1,\n\t): Vec2[] {\n\n\t\t// normalize and turn start and end angles to radians\n\t\tstart = deg2rad(start % 360)\n\t\tend = deg2rad(end % 360)\n\t\tif (end <= start) end += Math.PI * 2\n\n\t\t// TODO: better way to get this?\n\t\t// the number of vertices is sqrt(r1 + r2) * 3 * res with a minimum of 16\n\t\tconst nverts = Math.ceil(Math.max(Math.sqrt(radiusX + radiusY) * 3 * (res || 1), 16))\n\t\tconst step = (end - start) / nverts\n\t\tconst pts = []\n\n\t\t// calculate vertices\n\t\tfor (let a = start; a < end; a += step) {\n\t\t\tpts.push(pos.add(radiusX * Math.cos(a), radiusY * Math.sin(a)))\n\t\t}\n\n\t\t// doing this on the side due to possible floating point inaccuracy\n\t\tpts.push(pos.add(radiusX * Math.cos(end), radiusY * Math.sin(end)))\n\n\t\treturn pts\n\n\t}\n\n\tfunction drawRect(opt: DrawRectOpt) {\n\n\t\tif (opt.width === undefined || opt.height === undefined) {\n\t\t\tthrow new Error(\"drawRect() requires property \\\"width\\\" and \\\"height\\\".\")\n\t\t}\n\n\t\tif (opt.width <= 0 || opt.height <= 0) {\n\t\t\treturn\n\t\t}\n\n\t\tconst w = opt.width\n\t\tconst h = opt.height\n\t\tconst anchor = anchorPt(opt.anchor || DEF_ANCHOR).add(1, 1)\n\t\tconst offset = anchor.scale(vec2(w, h).scale(-0.5))\n\n\t\tlet pts = [\n\t\t\tvec2(0, 0),\n\t\t\tvec2(w, 0),\n\t\t\tvec2(w, h),\n\t\t\tvec2(0, h),\n\t\t]\n\n\t\t// TODO: gradient for rounded rect\n\t\t// TODO: drawPolygon should handle generic rounded corners\n\t\tif (opt.radius) {\n\n\t\t\t// maxium radius is half the shortest side\n\t\t\tconst r = Math.min(Math.min(w, h) / 2, opt.radius)\n\n\t\t\tpts = [\n\t\t\t\tvec2(r, 0),\n\t\t\t\tvec2(w - r, 0),\n\t\t\t\t...getArcPts(vec2(w - r, r), r, r, 270, 360),\n\t\t\t\tvec2(w, r),\n\t\t\t\tvec2(w, h - r),\n\t\t\t\t...getArcPts(vec2(w - r, h - r), r, r, 0, 90),\n\t\t\t\tvec2(w - r, h),\n\t\t\t\tvec2(r, h),\n\t\t\t\t...getArcPts(vec2(r, h - r), r, r, 90, 180),\n\t\t\t\tvec2(0, h - r),\n\t\t\t\tvec2(0, r),\n\t\t\t\t...getArcPts(vec2(r, r), r, r, 180, 270),\n\t\t\t]\n\n\t\t}\n\n\t\tdrawPolygon({\n\t\t\t...opt,\n\t\t\toffset,\n\t\t\tpts,\n\t\t\t...(opt.gradient ? {\n\t\t\t\tcolors: opt.horizontal ? [\n\t\t\t\t\topt.gradient[0],\n\t\t\t\t\topt.gradient[1],\n\t\t\t\t\topt.gradient[1],\n\t\t\t\t\topt.gradient[0],\n\t\t\t\t] : [\n\t\t\t\t\topt.gradient[0],\n\t\t\t\t\topt.gradient[0],\n\t\t\t\t\topt.gradient[1],\n\t\t\t\t\topt.gradient[1],\n\t\t\t\t],\n\t\t\t} : {}),\n\t\t})\n\n\t}\n\n\tfunction drawLine(opt: DrawLineOpt) {\n\n\t\tconst { p1, p2 } = opt\n\n\t\tif (!p1 || !p2) {\n\t\t\tthrow new Error(\"drawLine() requires properties \\\"p1\\\" and \\\"p2\\\".\")\n\t\t}\n\n\t\tconst w = opt.width || 1\n\n\t\t// the displacement from the line end point to the corner point\n\t\tconst dis = p2.sub(p1).unit().normal().scale(w * 0.5)\n\n\t\t// calculate the 4 corner points of the line polygon\n\t\tconst verts = [\n\t\t\tp1.sub(dis),\n\t\t\tp1.add(dis),\n\t\t\tp2.add(dis),\n\t\t\tp2.sub(dis),\n\t\t].map((p) => ({\n\t\t\tpos: vec3(p.x, p.y, 0),\n\t\t\tuv: vec2(0),\n\t\t\tcolor: opt.color ?? Color.WHITE,\n\t\t\topacity: opt.opacity ?? 1,\n\t\t}))\n\n\t\tdrawRaw(verts, [0, 1, 3, 1, 2, 3], opt.fixed, gfx.defTex, opt.shader, opt.uniform)\n\n\t}\n\n\tfunction drawLines(opt: DrawLinesOpt) {\n\n\t\tconst pts = opt.pts\n\n\t\tif (!pts) {\n\t\t\tthrow new Error(\"drawLines() requires property \\\"pts\\\".\")\n\t\t}\n\n\t\tif (pts.length < 2) {\n\t\t\treturn\n\t\t}\n\n\t\tif (opt.radius && pts.length >= 3) {\n\n\t\t\t// TODO: line joines\n\t\t\t// TODO: rounded vertices for arbitury polygonic shape\n\t\t\tlet minLen = pts[0].dist(pts[1])\n\n\t\t\tfor (let i = 1; i < pts.length - 1; i++) {\n\t\t\t\tminLen = Math.min(pts[i].dist(pts[i + 1]), minLen)\n\t\t\t}\n\n\t\t\t// eslint-disable-next-line\n\t\t\tconst radius = Math.min(opt.radius, minLen / 2)\n\n\t\t\tdrawLine({ ...opt, p1: pts[0], p2: pts[1] })\n\n\t\t\tfor (let i = 1; i < pts.length - 2; i++) {\n\t\t\t\tconst p1 = pts[i]\n\t\t\t\tconst p2 = pts[i + 1]\n\t\t\t\tdrawLine({\n\t\t\t\t\t...opt,\n\t\t\t\t\tp1: p1,\n\t\t\t\t\tp2: p2,\n\t\t\t\t})\n\t\t\t}\n\n\t\t\tdrawLine({ ...opt, p1: pts[pts.length - 2], p2: pts[pts.length - 1] })\n\n\t\t} else {\n\n\t\t\tfor (let i = 0; i < pts.length - 1; i++) {\n\t\t\t\tdrawLine({\n\t\t\t\t\t...opt,\n\t\t\t\t\tp1: pts[i],\n\t\t\t\t\tp2: pts[i + 1],\n\t\t\t\t})\n\t\t\t\t// TODO: other line join types\n\t\t\t\tif (opt.join !== \"none\") {\n\t\t\t\t\tdrawCircle({\n\t\t\t\t\t\t...opt,\n\t\t\t\t\t\tpos: pts[i],\n\t\t\t\t\t\tradius: opt.width / 2,\n\t\t\t\t\t})\n\t\t\t\t}\n\t\t\t}\n\n\t\t}\n\n\t}\n\n\tfunction drawTriangle(opt: DrawTriangleOpt) {\n\t\tif (!opt.p1 || !opt.p2 || !opt.p3) {\n\t\t\tthrow new Error(\"drawPolygon() requires properties \\\"p1\\\", \\\"p2\\\" and \\\"p3\\\".\")\n\t\t}\n\t\treturn drawPolygon({\n\t\t\t...opt,\n\t\t\tpts: [opt.p1, opt.p2, opt.p3],\n\t\t})\n\t}\n\n\t// TODO: anchor\n\tfunction drawCircle(opt: DrawCircleOpt) {\n\n\t\tif (!opt.radius) {\n\t\t\tthrow new Error(\"drawCircle() requires property \\\"radius\\\".\")\n\t\t}\n\n\t\tif (opt.radius === 0) {\n\t\t\treturn\n\t\t}\n\n\t\tdrawEllipse({\n\t\t\t...opt,\n\t\t\tradiusX: opt.radius,\n\t\t\tradiusY: opt.radius,\n\t\t\tangle: 0,\n\t\t})\n\n\t}\n\n\tfunction drawEllipse(opt: DrawEllipseOpt) {\n\n\t\tif (opt.radiusX === undefined || opt.radiusY === undefined) {\n\t\t\tthrow new Error(\"drawEllipse() requires properties \\\"radiusX\\\" and \\\"radiusY\\\".\")\n\t\t}\n\n\t\tif (opt.radiusX === 0 || opt.radiusY === 0) {\n\t\t\treturn\n\t\t}\n\n\t\tconst start = opt.start ?? 0\n\t\tconst end = opt.end ?? 360\n\n\t\tconst pts = getArcPts(\n\t\t\tvec2(0),\n\t\t\topt.radiusX,\n\t\t\topt.radiusY,\n\t\t\tstart,\n\t\t\tend,\n\t\t\topt.resolution,\n\t\t)\n\n\t\t// center\n\t\tpts.unshift(vec2(0))\n\n\t\tconst polyOpt = {\n\t\t\t...opt,\n\t\t\tpts,\n\t\t\tradius: 0,\n\t\t\t...(opt.gradient ? {\n\t\t\t\tcolors: [\n\t\t\t\t\topt.gradient[0],\n\t\t\t\t\t...Array(pts.length - 1).fill(opt.gradient[1]),\n\t\t\t\t],\n\t\t\t} : {}),\n\t\t}\n\n\t\t// full circle with outline shouldn't have the center point\n\t\tif (end - start >= 360 && opt.outline) {\n\t\t\tif (opt.fill !== false) {\n\t\t\t\tdrawPolygon({\n\t\t\t\t\t...polyOpt,\n\t\t\t\t\toutline: null,\n\t\t\t\t})\n\t\t\t}\n\t\t\tdrawPolygon({\n\t\t\t\t...polyOpt,\n\t\t\t\tpts: pts.slice(1),\n\t\t\t\tfill: false,\n\t\t\t})\n\t\t\treturn\n\t\t}\n\n\t\tdrawPolygon(polyOpt)\n\n\t}\n\n\tfunction drawPolygon(opt: DrawPolygonOpt) {\n\n\t\tif (!opt.pts) {\n\t\t\tthrow new Error(\"drawPolygon() requires property \\\"pts\\\".\")\n\t\t}\n\n\t\tconst npts = opt.pts.length\n\n\t\tif (npts < 3) {\n\t\t\treturn\n\t\t}\n\n\t\tpushTransform()\n\t\tpushTranslate(opt.pos)\n\t\tpushScale(opt.scale)\n\t\tpushRotateZ(opt.angle)\n\t\tpushTranslate(opt.offset)\n\n\t\tif (opt.fill !== false) {\n\n\t\t\tconst color = opt.color ?? Color.WHITE\n\n\t\t\tconst verts = opt.pts.map((pt, i) => ({\n\t\t\t\tpos: vec3(pt.x, pt.y, 0),\n\t\t\t\tuv: vec2(0, 0),\n\t\t\t\tcolor: opt.colors ? (opt.colors[i] ?? color) : color,\n\t\t\t\topacity: opt.opacity ?? 1,\n\t\t\t}))\n\n\t\t\t// TODO: better triangulation\n\t\t\tconst indices = [...Array(npts - 2).keys()]\n\t\t\t\t.map((n) => [0, n + 1, n + 2])\n\t\t\t\t.flat()\n\n\t\t\tdrawRaw(verts, opt.indices ?? indices, opt.fixed, gfx.defTex, opt.shader, opt.uniform)\n\n\t\t}\n\n\t\tif (opt.outline) {\n\t\t\tdrawLines({\n\t\t\t\tpts: [ ...opt.pts, opt.pts[0] ],\n\t\t\t\tradius: opt.radius,\n\t\t\t\twidth: opt.outline.width,\n\t\t\t\tcolor: opt.outline.color,\n\t\t\t\tjoin: opt.outline.join,\n\t\t\t\tuniform: opt.uniform,\n\t\t\t\tfixed: opt.fixed,\n\t\t\t\topacity: opt.opacity,\n\t\t\t})\n\t\t}\n\n\t\tpopTransform()\n\n\t}\n\n\tfunction drawStenciled(content: () => void, mask: () => void, test: number) {\n\n\t\tflush()\n\t\tgl.clear(gl.STENCIL_BUFFER_BIT)\n\t\tgl.enable(gl.STENCIL_TEST)\n\n\t\t// don't perform test, pure write\n\t\tgl.stencilFunc(\n\t\t\tgl.NEVER,\n\t\t\t1,\n\t\t\t0xFF,\n\t\t)\n\n\t\t// always replace since we're writing to the buffer\n\t\tgl.stencilOp(\n\t\t\tgl.REPLACE,\n\t\t\tgl.REPLACE,\n\t\t\tgl.REPLACE,\n\t\t)\n\n\t\tmask()\n\t\tflush()\n\n\t\t// perform test\n\t\tgl.stencilFunc(\n\t\t\ttest,\n\t\t\t1,\n\t\t\t0xFF,\n\t\t)\n\n\t\t// don't write since we're only testing\n\t\tgl.stencilOp(\n\t\t\tgl.KEEP,\n\t\t\tgl.KEEP,\n\t\t\tgl.KEEP,\n\t\t)\n\n\t\tcontent()\n\t\tflush()\n\t\tgl.disable(gl.STENCIL_TEST)\n\n\t}\n\n\tfunction drawMasked(content: () => void, mask: () => void) {\n\t\tdrawStenciled(content, mask, gl.EQUAL)\n\t}\n\n\tfunction drawSubtracted(content: () => void, mask: () => void) {\n\t\tdrawStenciled(content, mask, gl.NOTEQUAL)\n\t}\n\n\tfunction getViewportScale() {\n\t\treturn (gfx.viewport.width + gfx.viewport.height) / (gfx.width + gfx.height)\n\t}\n\n\tfunction drawUnscaled(content: () => void) {\n\t\tflush()\n\t\tconst ow = gfx.width\n\t\tconst oh = gfx.height\n\t\tgfx.width = gfx.viewport.width\n\t\tgfx.height = gfx.viewport.height\n\t\tcontent()\n\t\tflush()\n\t\tgfx.width = ow\n\t\tgfx.height = oh\n\t}\n\n\tfunction applyCharTransform(fchar: FormattedChar, tr: CharTransform) {\n\t\tif (tr.pos) fchar.pos = fchar.pos.add(tr.pos)\n\t\tif (tr.scale) fchar.scale = fchar.scale.scale(vec2(tr.scale))\n\t\tif (tr.angle) fchar.angle += tr.angle\n\t\tif (tr.color) fchar.color = fchar.color.mult(tr.color)\n\t\tif (tr.opacity) fchar.opacity *= tr.opacity\n\t}\n\n\t// TODO: escape\n\t// eslint-disable-next-line\n\tconst TEXT_STYLE_RE = /\\[(?<text>[^\\]]*)\\]\\.(?<style>[\\w\\.]+)+/g\n\n\tfunction compileStyledText(text: string): {\n\t\tcharStyleMap: Record<number, {\n\t\t\tlocalIdx: number,\n\t\t\tstyles: string[],\n\t\t}>,\n\t\ttext: string,\n\t} {\n\n\t\tconst charStyleMap = {}\n\t\t// get the text without the styling syntax\n\t\tconst renderText = text.replace(TEXT_STYLE_RE, \"$1\")\n\t\tlet idxOffset = 0\n\n\t\t// put each styled char index into a map for easy access when iterating each char\n\t\tfor (const match of text.matchAll(TEXT_STYLE_RE)) {\n\t\t\tconst styles = match.groups.style.split(\".\")\n\t\t\tconst origIdx = match.index - idxOffset\n\t\t\tfor (\n\t\t\t\tlet i = origIdx;\n\t\t\t\ti < match.index + match.groups.text.length;\n\t\t\t\ti++\n\t\t\t) {\n\t\t\t\tcharStyleMap[i] = {\n\t\t\t\t\tlocalIdx: i - origIdx,\n\t\t\t\t\tstyles: styles,\n\t\t\t\t}\n\t\t\t}\n\t\t\t// omit \"[\", \"]\", \".\" and the style text in the format string when calculating index\n\t\t\tidxOffset += 3 + match.groups.style.length\n\t\t}\n\n\t\treturn {\n\t\t\tcharStyleMap: charStyleMap,\n\t\t\ttext: renderText,\n\t\t}\n\n\t}\n\n\ttype FontAtlas = {\n\t\tfont: BitmapFontData,\n\t\tcursor: Vec2,\n\t}\n\n\tconst fontAtlases: Record<string, FontAtlas> = {}\n\n\t// TODO: cache formatted text\n\t// format text and return a list of chars with their calculated position\n\tfunction formatText(opt: DrawTextOpt): FormattedText {\n\n\t\tif (opt.text === undefined) {\n\t\t\tthrow new Error(\"formatText() requires property \\\"text\\\".\")\n\t\t}\n\n\t\tlet font = resolveFont(opt.font)\n\n\t\t// if it's still loading\n\t\tif (opt.text === \"\" || font instanceof Asset || !font) {\n\t\t\treturn {\n\t\t\t\twidth: 0,\n\t\t\t\theight: 0,\n\t\t\t\tchars: [],\n\t\t\t\topt: opt,\n\t\t\t}\n\t\t}\n\n\t\tconst { charStyleMap, text } = compileStyledText(opt.text + \"\")\n\t\tconst chars = text.split(\"\")\n\n\t\t// if it's not bitmap font, we draw it with 2d canvas or use cached image\n\t\tif (font instanceof FontFace || typeof font === \"string\") {\n\n\t\t\tconst fontName = font instanceof FontFace ? font.family : font\n\n\t\t\tconst atlas: FontAtlas = fontAtlases[fontName] ?? {\n\t\t\t\tfont: {\n\t\t\t\t\ttex: new Texture(FONT_ATLAS_SIZE, FONT_ATLAS_SIZE, {\n\t\t\t\t\t\tfilter: \"linear\",\n\t\t\t\t\t}),\n\t\t\t\t\tmap: {},\n\t\t\t\t\tsize: DEF_TEXT_CACHE_SIZE,\n\t\t\t\t},\n\t\t\t\tcursor: vec2(0),\n\t\t\t}\n\n\t\t\tif (!fontAtlases[fontName]) {\n\t\t\t\tfontAtlases[fontName] = atlas\n\t\t\t}\n\n\t\t\tfont = atlas.font\n\n\t\t\tfor (const ch of chars) {\n\n\t\t\t\tif (!atlas.font.map[ch]) {\n\n\t\t\t\t\tconst c2d = app.canvas2.getContext(\"2d\")\n\t\t\t\t\tc2d.font = `${font.size}px ${fontName}`\n\t\t\t\t\tc2d.clearRect(0, 0, app.canvas2.width, app.canvas2.height)\n\t\t\t\t\tc2d.textBaseline = \"top\"\n\t\t\t\t\tc2d.textAlign = \"left\"\n\t\t\t\t\tc2d.fillStyle = \"rgb(255, 255, 255)\"\n\t\t\t\t\tc2d.fillText(ch, 0, 0)\n\t\t\t\t\tconst m = c2d.measureText(ch)\n\t\t\t\t\tconst w = Math.ceil(m.width)\n\t\t\t\t\tconst img = c2d.getImageData(0, 0, w, font.size)\n\n\t\t\t\t\t// if we are about to exceed the X axis of the texture, go to another line\n\t\t\t\t\tif (atlas.cursor.x + w > FONT_ATLAS_SIZE) {\n\t\t\t\t\t\tatlas.cursor.x = 0\n\t\t\t\t\t\tatlas.cursor.y += font.size\n\t\t\t\t\t\tif (atlas.cursor.y > FONT_ATLAS_SIZE) {\n\t\t\t\t\t\t\t// TODO: create another tex\n\t\t\t\t\t\t\tthrow new Error(\"Font atlas exceeds character limit\")\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tfont.tex.update(atlas.cursor.x, atlas.cursor.y, img)\n\t\t\t\t\tfont.map[ch] = new Quad(atlas.cursor.x, atlas.cursor.y, w, font.size)\n\t\t\t\t\tatlas.cursor.x += w\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t}\n\n\t\tconst size = opt.size || font.size\n\t\tconst scale = vec2(opt.scale ?? 1).scale(size / font.size)\n\t\tconst lineSpacing = opt.lineSpacing ?? 0\n\t\tconst letterSpacing = opt.letterSpacing ?? 0\n\t\tlet curX = 0\n\t\tlet tw = 0\n\t\tlet th = 0\n\t\tconst lines: Array<{\n\t\t\twidth: number,\n\t\t\tchars: FormattedChar[],\n\t\t}> = []\n\t\tlet curLine: FormattedChar[] = []\n\t\tlet cursor = 0\n\t\tlet lastSpace = null\n\t\tlet lastSpaceWidth = null\n\n\t\t// TODO: word break\n\t\twhile (cursor < chars.length) {\n\n\t\t\tlet ch = chars[cursor]\n\n\t\t\t// always new line on '\\n'\n\t\t\tif (ch === \"\\n\") {\n\n\t\t\t\tth += size + lineSpacing\n\n\t\t\t\tlines.push({\n\t\t\t\t\twidth: curX - letterSpacing,\n\t\t\t\t\tchars: curLine,\n\t\t\t\t})\n\n\t\t\t\tlastSpace = null\n\t\t\t\tlastSpaceWidth = null\n\t\t\t\tcurX = 0\n\t\t\t\tcurLine = []\n\n\t\t\t} else {\n\n\t\t\t\tlet q = font.map[ch]\n\n\t\t\t\t// TODO: leave space if character not found?\n\t\t\t\tif (q) {\n\n\t\t\t\t\tlet gw = q.w * scale.x\n\n\t\t\t\t\tif (opt.width && curX + gw > opt.width) {\n\t\t\t\t\t\t// new line on last word if width exceeds\n\t\t\t\t\t\tth += size + lineSpacing\n\t\t\t\t\t\tif (lastSpace != null) {\n\t\t\t\t\t\t\tcursor -= curLine.length - lastSpace\n\t\t\t\t\t\t\tch = chars[cursor]\n\t\t\t\t\t\t\tq = font.map[ch]\n\t\t\t\t\t\t\tgw = q.w * scale.x\n\t\t\t\t\t\t\t// omit trailing space\n\t\t\t\t\t\t\tcurLine = curLine.slice(0, lastSpace - 1)\n\t\t\t\t\t\t\tcurX = lastSpaceWidth\n\t\t\t\t\t\t}\n\t\t\t\t\t\tlastSpace = null\n\t\t\t\t\t\tlastSpaceWidth = null\n\t\t\t\t\t\tlines.push({\n\t\t\t\t\t\t\twidth: curX - letterSpacing,\n\t\t\t\t\t\t\tchars: curLine,\n\t\t\t\t\t\t})\n\t\t\t\t\t\tcurX = 0\n\t\t\t\t\t\tcurLine = []\n\t\t\t\t\t}\n\n\t\t\t\t\t// push char\n\t\t\t\t\tcurLine.push({\n\t\t\t\t\t\ttex: font.tex,\n\t\t\t\t\t\twidth: q.w,\n\t\t\t\t\t\theight: q.h,\n\t\t\t\t\t\t// without some padding there'll be visual artifacts on edges\n\t\t\t\t\t\tquad: new Quad(\n\t\t\t\t\t\t\tq.x / font.tex.width,\n\t\t\t\t\t\t\tq.y / font.tex.height,\n\t\t\t\t\t\t\tq.w / font.tex.width,\n\t\t\t\t\t\t\tq.h / font.tex.height,\n\t\t\t\t\t\t),\n\t\t\t\t\t\tch: ch,\n\t\t\t\t\t\tpos: vec2(curX, th),\n\t\t\t\t\t\topacity: opt.opacity ?? 1,\n\t\t\t\t\t\tcolor: opt.color ?? Color.WHITE,\n\t\t\t\t\t\tscale: vec2(scale),\n\t\t\t\t\t\tangle: 0,\n\t\t\t\t\t})\n\n\t\t\t\t\tif (ch === \" \") {\n\t\t\t\t\t\tlastSpace = curLine.length\n\t\t\t\t\t\tlastSpaceWidth = curX\n\t\t\t\t\t}\n\n\t\t\t\t\tcurX += gw\n\t\t\t\t\ttw = Math.max(tw, curX)\n\t\t\t\t\tcurX += letterSpacing\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\tcursor++\n\n\t\t}\n\n\t\tlines.push({\n\t\t\twidth: curX - letterSpacing,\n\t\t\tchars: curLine,\n\t\t})\n\n\t\tth += size\n\n\t\tif (opt.width) {\n\t\t\ttw = opt.width\n\t\t}\n\n\t\tconst fchars: FormattedChar[] = []\n\n\t\tfor (const line of lines) {\n\n\t\t\tconst ox = (tw - line.width) * alignPt(opt.align ?? \"left\")\n\n\t\t\tfor (const fchar of line.chars) {\n\n\t\t\t\tconst q = font.map[fchar.ch]\n\t\t\t\tconst idx = fchars.length\n\n\t\t\t\tconst offset = new Vec2(\n\t\t\t\t\tq.w * scale.x * 0.5,\n\t\t\t\t\tq.h * scale.y * 0.5,\n\t\t\t\t)\n\n\t\t\t\tfchar.pos = fchar.pos.add(ox, 0).add(offset)\n\n\t\t\t\tif (opt.transform) {\n\t\t\t\t\tconst tr = typeof opt.transform === \"function\"\n\t\t\t\t\t\t? opt.transform(idx, fchar.ch)\n\t\t\t\t\t\t: opt.transform\n\t\t\t\t\tif (tr) {\n\t\t\t\t\t\tapplyCharTransform(fchar, tr)\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (charStyleMap[idx]) {\n\t\t\t\t\tconst { styles, localIdx } = charStyleMap[idx]\n\t\t\t\t\tfor (const name of styles) {\n\t\t\t\t\t\tconst style = opt.styles[name]\n\t\t\t\t\t\tconst tr = typeof style === \"function\"\n\t\t\t\t\t\t\t? style(localIdx, fchar.ch)\n\t\t\t\t\t\t\t: style\n\t\t\t\t\t\tif (tr) {\n\t\t\t\t\t\t\tapplyCharTransform(fchar, tr)\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tfchars.push(fchar)\n\n\t\t\t}\n\n\t\t}\n\n\t\treturn {\n\t\t\twidth: tw,\n\t\t\theight: th,\n\t\t\tchars: fchars,\n\t\t\topt: opt,\n\t\t}\n\n\t}\n\n\tfunction drawText(opt: DrawTextOpt) {\n\t\tdrawFormattedText(formatText(opt))\n\t}\n\n\tfunction drawFormattedText(ftext: FormattedText) {\n\t\tpushTransform()\n\t\tpushTranslate(ftext.opt.pos)\n\t\tpushRotateZ(ftext.opt.angle)\n\t\tpushTranslate(anchorPt(ftext.opt.anchor ?? \"topleft\").add(1, 1).scale(ftext.width, ftext.height).scale(-0.5))\n\t\tftext.chars.forEach((ch) => {\n\t\t\tdrawUVQuad({\n\t\t\t\ttex: ch.tex,\n\t\t\t\twidth: ch.width,\n\t\t\t\theight: ch.height,\n\t\t\t\tpos: ch.pos,\n\t\t\t\tscale: ch.scale,\n\t\t\t\tangle: ch.angle,\n\t\t\t\tcolor: ch.color,\n\t\t\t\topacity: ch.opacity,\n\t\t\t\tquad: ch.quad,\n\t\t\t\tanchor: \"center\",\n\t\t\t\tuniform: ftext.opt.uniform,\n\t\t\t\tshader: ftext.opt.shader,\n\t\t\t\tfixed: ftext.opt.fixed,\n\t\t\t})\n\t\t})\n\t\tpopTransform()\n\t}\n\n\t// update viewport based on user setting and fullscreen state\n\tfunction updateViewport() {\n\n\t\t// content size (scaled content size, with scale, stretch and letterbox)\n\t\t// view size (unscaled viewport size)\n\t\t// window size (will be the same as view size except letterbox mode)\n\n\t\t// check for resize\n\t\tif (app.stretchToParent && !isFullscreen()) {\n\t\t\t// TODO: update cam pos\n\t\t\t// TODO: if <html>/<body> height not set to 100% the height keeps growing\n\t\t\tconst pw = app.canvas.parentElement.offsetWidth\n\t\t\tconst ph = app.canvas.parentElement.offsetHeight\n\t\t\tif (pw !== app.lastParentWidth || ph !== app.lastParentHeight) {\n\t\t\t\tapp.canvas.width = pw * app.pixelDensity\n\t\t\t\tapp.canvas.height = ph * app.pixelDensity\n\t\t\t\tapp.canvas.style.width = pw + \"px\"\n\t\t\t\tapp.canvas.style.height = ph + \"px\"\n\t\t\t\tconst prevWidth = width()\n\t\t\t\tconst prevHeight = height()\n\t\t\t\t// trigger \"resize\" on frame end so width() and height() will get the updated value\n\t\t\t\tgame.ev.onOnce(\"frameEnd\", () => {\n\t\t\t\t\t// should we also pass window / view size?\n\t\t\t\t\tgame.ev.trigger(\"resize\", prevWidth, prevHeight, width(), height())\n\t\t\t\t})\n\t\t\t}\n\t\t\tapp.lastParentWidth = pw\n\t\t\tapp.lastParentHeight = ph\n\t\t}\n\n\t\t// canvas size\n\t\tconst pd = app.pixelDensity\n\t\tconst cw = gl.drawingBufferWidth / pd\n\t\tconst ch = gl.drawingBufferHeight / pd\n\n\t\tif (isFullscreen()) {\n\t\t\t// TODO: doesn't work with letterbox\n\t\t\tconst ww = window.innerWidth\n\t\t\tconst wh = window.innerHeight\n\t\t\tconst rw = ww / wh\n\t\t\tconst rc = cw / ch\n\t\t\tif (rw > rc) {\n\t\t\t\tconst sw = window.innerHeight * rc\n\t\t\t\tgfx.viewport = {\n\t\t\t\t\tx: (ww - sw) / 2,\n\t\t\t\t\ty: 0,\n\t\t\t\t\twidth: sw,\n\t\t\t\t\theight: wh,\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tconst sh = window.innerWidth / rc\n\t\t\t\tgfx.viewport = {\n\t\t\t\t\tx: 0,\n\t\t\t\t\ty: (wh - sh) / 2,\n\t\t\t\t\twidth: ww,\n\t\t\t\t\theight: sh,\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn\n\t\t}\n\n\t\tif (gopt.letterbox) {\n\n\t\t\tif (!gopt.width || !gopt.height) {\n\t\t\t\tthrow new Error(\"Letterboxing requires width and height defined.\")\n\t\t\t}\n\n\t\t\tconst rc = cw / ch\n\t\t\tconst rg = gopt.width / gopt.height\n\n\t\t\tif (rc > rg) {\n\t\t\t\tif (!gopt.stretch) {\n\t\t\t\t\tgfx.width = ch * rg\n\t\t\t\t\tgfx.height = ch\n\t\t\t\t}\n\t\t\t\tconst sw = ch * rg\n\t\t\t\tconst sh = ch\n\t\t\t\tconst x = (cw - sw) / 2\n\t\t\t\tgl.scissor(x * pd, 0, sw * pd, sh * pd)\n\t\t\t\tgl.viewport(x * pd, 0, sw * pd, ch * pd)\n\t\t\t\tgfx.viewport = {\n\t\t\t\t\tx: x,\n\t\t\t\t\ty: 0,\n\t\t\t\t\twidth: sw,\n\t\t\t\t\theight: ch,\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tif (!gopt.stretch) {\n\t\t\t\t\tgfx.width = cw\n\t\t\t\t\tgfx.height = cw / rg\n\t\t\t\t}\n\t\t\t\tconst sw = cw\n\t\t\t\tconst sh = cw / rg\n\t\t\t\tconst y = (ch - sh) / 2\n\t\t\t\tgl.scissor(0, y * pd, sw * pd, sh * pd)\n\t\t\t\tgl.viewport(0, y * pd, cw * pd, sh * pd)\n\t\t\t\tgfx.viewport = {\n\t\t\t\t\tx: 0,\n\t\t\t\t\ty: y,\n\t\t\t\t\twidth: cw,\n\t\t\t\t\theight: sh,\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn\n\n\t\t}\n\n\t\tif (gopt.stretch) {\n\n\t\t\tif (!gopt.width || !gopt.height) {\n\t\t\t\tthrow new Error(\"Stretching requires width and height defined.\")\n\t\t\t}\n\n\t\t\tgl.viewport(0, 0, cw * pd, ch * pd)\n\n\t\t\tgfx.viewport = {\n\t\t\t\tx: 0,\n\t\t\t\ty: 0,\n\t\t\t\twidth: cw,\n\t\t\t\theight: ch,\n\t\t\t}\n\n\t\t\treturn\n\t\t}\n\n\t\tconst scale = gopt.scale ?? 1\n\n\t\tgfx.width = cw / scale\n\t\tgfx.height = ch / scale\n\t\tgl.viewport(0, 0, cw * pd, ch * pd)\n\n\t\tgfx.viewport = {\n\t\t\tx: 0,\n\t\t\ty: 0,\n\t\t\twidth: cw,\n\t\t\theight: ch,\n\t\t}\n\n\t}\n\n\t// get game width\n\tfunction width(): number {\n\t\treturn gfx.width\n\t}\n\n\t// get game height\n\tfunction height(): number {\n\t\treturn gfx.height\n\t}\n\n\tconst canvasEvents: EventList<HTMLElementEventMap> = {}\n\tconst docEvents: EventList<DocumentEventMap> = {}\n\tconst winEvents: EventList<WindowEventMap> = {}\n\n\t// transform a point from window space to content space\n\tfunction windowToContent(pt: Vec2) {\n\t\treturn vec2(\n\t\t\t(pt.x - gfx.viewport.x) * width() / gfx.viewport.width,\n\t\t\t(pt.y - gfx.viewport.y) * height() / gfx.viewport.height,\n\t\t)\n\t}\n\n\t// transform a point from content space to view space\n\tfunction contentToView(pt: Vec2) {\n\t\treturn vec2(\n\t\t\tpt.x * gfx.viewport.width / gfx.width,\n\t\t\tpt.y * gfx.viewport.height / gfx.height,\n\t\t)\n\t}\n\n\t// set game mouse pos from window mouse pos\n\tfunction setMousePos(x: number, y: number) {\n\t\tconst mpos = windowToContent(vec2(x, y))\n\t\tif (app.mouseStarted) {\n\t\t\tapp.mouseDeltaPos = mpos.sub(app.mousePos)\n\t\t}\n\t\tapp.mousePos = mpos\n\t\tapp.mouseStarted = true\n\t\tapp.isMouseMoved = true\n\t}\n\n\tcanvasEvents.mousemove = (e) => {\n\t\tsetMousePos(e.offsetX, e.offsetY)\n\t}\n\n\tcanvasEvents.mousedown = (e) => {\n\t\tconst m = MOUSE_BUTTONS[e.button]\n\t\tif (m) {\n\t\t\tapp.mouseStates[m] = \"pressed\"\n\t\t}\n\t}\n\n\tcanvasEvents.mouseup = (e) => {\n\t\tconst m = MOUSE_BUTTONS[e.button]\n\t\tif (m) {\n\t\t\tapp.mouseStates[m] = \"released\"\n\t\t}\n\t}\n\n\tcanvasEvents.keydown = (e) => {\n\n\t\tconst k = KEY_ALIAS[e.key] || e.key.toLowerCase()\n\n\t\tif (PREVENT_DEFAULT_KEYS.includes(k)) {\n\t\t\te.preventDefault()\n\t\t}\n\n\t\tif (k.length === 1) {\n\t\t\tapp.charInputted.push(e.key)\n\t\t}\n\n\t\tif (k === \"space\") {\n\t\t\tapp.charInputted.push(\" \")\n\t\t}\n\n\t\t// TODO: record just pressed keys\n\t\tif (e.repeat) {\n\t\t\tapp.isKeyPressedRepeat = true\n\t\t\tapp.keyStates[k] = \"rpressed\"\n\t\t} else {\n\t\t\tapp.isKeyPressed = true\n\t\t\tapp.keyStates[k] = \"pressed\"\n\t\t}\n\n\t\tapp.numKeyDown++\n\n\t}\n\n\tcanvasEvents.keyup = (e: KeyboardEvent) => {\n\t\tconst k = KEY_ALIAS[e.key] || e.key.toLowerCase()\n\t\tapp.keyStates[k] = \"released\"\n\t\tapp.isKeyReleased = true\n\t\tapp.numKeyDown--\n\t}\n\n\tcanvasEvents.touchstart = (e) => {\n\t\t// disable long tap context menu\n\t\te.preventDefault()\n\t\tconst touches = [...e.changedTouches]\n\t\t// TODO: pass touchlist instead of individual touches\n\t\ttouches.forEach((t) => {\n\t\t\tgame.ev.trigger(\n\t\t\t\t\"onTouchStart\",\n\t\t\t\twindowToContent(vec2(t.clientX, t.clientY)),\n\t\t\t\tt,\n\t\t\t)\n\t\t})\n\t\tif (gopt.touchToMouse !== false) {\n\t\t\tsetMousePos(touches[0].clientX, touches[0].clientY)\n\t\t\tapp.mouseStates[\"left\"] = \"pressed\"\n\t\t}\n\t}\n\n\tcanvasEvents.touchmove = (e) => {\n\t\t// disable scrolling\n\t\te.preventDefault()\n\t\tconst touches = [...e.changedTouches]\n\t\ttouches.forEach((t) => {\n\t\t\tgame.ev.trigger(\n\t\t\t\t\"onTouchMove\",\n\t\t\t\twindowToContent(vec2(t.clientX, t.clientY)),\n\t\t\t\tt,\n\t\t\t)\n\t\t})\n\t\tif (gopt.touchToMouse !== false) {\n\t\t\tsetMousePos(touches[0].clientX, touches[0].clientY)\n\t\t}\n\t}\n\n\tcanvasEvents.touchend = (e) => {\n\t\tconst touches = [...e.changedTouches]\n\t\ttouches.forEach((t) => {\n\t\t\tgame.ev.trigger(\n\t\t\t\t\"onTouchEnd\",\n\t\t\t\twindowToContent(vec2(t.clientX, t.clientY)),\n\t\t\t\tt,\n\t\t\t)\n\t\t})\n\t\tif (gopt.touchToMouse !== false) {\n\t\t\tapp.mouseStates[\"left\"] = \"released\"\n\t\t}\n\t}\n\n\tcanvasEvents.touchcancel = () => {\n\t\tif (gopt.touchToMouse !== false) {\n\t\t\tapp.mouseStates[\"left\"] = \"released\"\n\t\t}\n\t}\n\n\tcanvasEvents.contextmenu = function (e) {\n\t\te.preventDefault()\n\t}\n\n\tdocEvents.visibilitychange = () => {\n\t\tswitch (document.visibilityState) {\n\t\t\tcase \"visible\":\n\t\t\t\t// prevent a surge of dt() when switch back after the tab being hidden for a while\n\t\t\t\tapp.skipTime = true\n\t\t\t\tif (!debug.paused) {\n\t\t\t\t\taudio.ctx.resume()\n\t\t\t\t}\n\t\t\t\tbreak\n\t\t\tcase \"hidden\":\n\t\t\t\taudio.ctx.suspend()\n\t\t\t\tbreak\n\t\t}\n\t}\n\n\twinEvents.error = (e) => {\n\t\tif (e.error) {\n\t\t\thandleErr(e.error)\n\t\t} else {\n\t\t\thandleErr(new Error(e.message))\n\t\t}\n\t}\n\n\twinEvents.unhandledrejection = (e) => handleErr(e.reason)\n\n\tfor (const name in canvasEvents) {\n\t\tapp.canvas.addEventListener(name, canvasEvents[name])\n\t}\n\n\tfor (const name in docEvents) {\n\t\tdocument.addEventListener(name, docEvents[name])\n\t}\n\n\tfor (const name in winEvents) {\n\t\twindow.addEventListener(name, winEvents[name])\n\t}\n\n\tfunction mousePos(): Vec2 {\n\t\treturn app.mousePos.clone()\n\t}\n\n\tfunction mouseDeltaPos(): Vec2 {\n\t\treturn app.mouseDeltaPos.clone()\n\t}\n\n\tfunction isMousePressed(m: MouseButton = \"left\"): boolean {\n\t\treturn app.mouseStates[m] === \"pressed\"\n\t}\n\n\tfunction isMouseDown(m: MouseButton = \"left\"): boolean {\n\t\treturn app.mouseStates[m] === \"pressed\" || app.mouseStates[m] === \"down\"\n\t}\n\n\tfunction isMouseReleased(m: MouseButton = \"left\"): boolean {\n\t\treturn app.mouseStates[m] === \"released\"\n\t}\n\n\tfunction isMouseMoved(): boolean {\n\t\treturn app.isMouseMoved\n\t}\n\n\tfunction isKeyPressed(k?: string): boolean {\n\t\tif (k === undefined) {\n\t\t\treturn app.isKeyPressed\n\t\t} else {\n\t\t\treturn app.keyStates[k] === \"pressed\"\n\t\t}\n\t}\n\n\tfunction isKeyPressedRepeat(k?: string): boolean {\n\t\tif (k === undefined) {\n\t\t\treturn app.isKeyPressedRepeat\n\t\t} else {\n\t\t\treturn app.keyStates[k] === \"pressed\" || app.keyStates[k] === \"rpressed\"\n\t\t}\n\t}\n\n\tfunction isKeyDown(k?: string): boolean {\n\t\tif (k === undefined) {\n\t\t\treturn app.numKeyDown > 0\n\t\t} else {\n\t\t\treturn app.keyStates[k] === \"pressed\"\n\t\t\t|| app.keyStates[k] === \"rpressed\"\n\t\t\t|| app.keyStates[k] === \"down\"\n\t\t}\n\t}\n\n\tfunction isKeyReleased(k?: string): boolean {\n\t\tif (k === undefined) {\n\t\t\treturn app.isKeyReleased\n\t\t} else {\n\t\t\treturn app.keyStates[k] === \"released\"\n\t\t}\n\t}\n\n\tfunction isVirtualButtonPressed(btn: VirtualButton): boolean {\n\t\treturn app.virtualButtonStates[btn] === \"pressed\"\n\t}\n\n\tfunction isVirtualButtonDown(btn: VirtualButton): boolean {\n\t\treturn app.virtualButtonStates[btn] === \"pressed\"\n\t\t\t|| app.virtualButtonStates[btn] === \"down\"\n\t}\n\n\tfunction isVirtualButtonReleased(btn: VirtualButton): boolean {\n\t\treturn app.virtualButtonStates[btn] === \"released\"\n\t}\n\n\tfunction charInputted(): string[] {\n\t\treturn [...app.charInputted]\n\t}\n\n\tfunction time(): number {\n\t\treturn app.time\n\t}\n\n\t// get a base64 png image of canvas\n\tfunction screenshot(): string {\n\t\treturn app.canvas.toDataURL()\n\t}\n\n\tfunction setCursor(c?: Cursor): Cursor {\n\t\tif (c) {\n\t\t\tapp.canvas.style.cursor = c\n\t\t}\n\t\treturn app.canvas.style.cursor\n\t}\n\n\tfunction setFullscreen(f: boolean = true) {\n\t\tif (f) {\n\t\t\tenterFullscreen(app.canvas)\n\t\t} else {\n\t\t\texitFullscreen()\n\t\t}\n\t}\n\n\tfunction isFullscreen(): boolean {\n\t\treturn Boolean(getFullscreenElement())\n\t}\n\n\tfunction isTouchScreen() {\n\t\treturn app.isTouchScreen\n\t}\n\n\tconst debug: Debug = {\n\t\tinspect: false,\n\t\ttimeScale: 1,\n\t\tshowLog: true,\n\t\tfps: () => app.fpsCounter.fps,\n\t\tnumFrames: () => app.numFrames,\n\t\tstepFrame: updateFrame,\n\t\tdrawCalls: () => gfx.drawCalls,\n\t\tclearLog: () => game.logs = [],\n\t\tlog: (msg) => {\n\t\t\tconst max = gopt.logMax ?? LOG_MAX\n\t\t\tgame.logs.unshift(`${`[${time().toFixed(2)}].time `}[${msg?.toString ? msg.toString() : msg}].${msg instanceof Error ? \"error\" : \"info\"}`)\n\t\t\tif (game.logs.length > max) {\n\t\t\t\tgame.logs = game.logs.slice(0, max)\n\t\t\t}\n\t\t},\n\t\terror: (msg) => debug.log(new Error(msg.toString ? msg.toString() : msg as string)),\n\t\tcurRecording: null,\n\t\tget paused() {\n\t\t\treturn app.paused\n\t\t},\n\t\tset paused(v) {\n\t\t\tapp.paused = v\n\t\t\tif (v) {\n\t\t\t\taudio.ctx.suspend()\n\t\t\t} else {\n\t\t\t\taudio.ctx.resume()\n\t\t\t}\n\t\t},\n\t}\n\n\tfunction dt() {\n\t\treturn app.dt * debug.timeScale\n\t}\n\n\tfunction camPos(...pos): Vec2 {\n\t\tif (pos.length > 0) {\n\t\t\tgame.cam.pos = vec2(...pos)\n\t\t}\n\t\treturn game.cam.pos ? game.cam.pos.clone() : center()\n\t}\n\n\tfunction camScale(...scale): Vec2 {\n\t\tif (scale.length > 0) {\n\t\t\tgame.cam.scale = vec2(...scale)\n\t\t}\n\t\treturn game.cam.scale.clone()\n\t}\n\n\tfunction camRot(angle: number): number {\n\t\tif (angle !== undefined) {\n\t\t\tgame.cam.angle = angle\n\t\t}\n\t\treturn game.cam.angle\n\t}\n\n\tfunction shake(intensity: number = 12) {\n\t\tgame.cam.shake = intensity\n\t}\n\n\tfunction toScreen(p: Vec2): Vec2 {\n\t\treturn game.cam.transform.multVec2(p)\n\t}\n\n\tfunction toWorld(p: Vec2): Vec2 {\n\t\treturn game.cam.transform.invert().multVec2(p)\n\t}\n\n\tfunction calcTransform(obj: GameObj): Mat4 {\n\t\tlet tr = new Mat4()\n\t\tif (obj.pos) tr = tr.translate(obj.pos)\n\t\tif (obj.scale) tr = tr.scale(obj.scale)\n\t\tif (obj.angle) tr = tr.rotateZ(obj.angle)\n\t\treturn obj.parent ? tr.mult(obj.parent.transform) : tr\n\t}\n\n\tfunction make<T>(comps: CompList<T>): GameObj<T> {\n\n\t\tconst compStates = new Map()\n\t\tconst customState = {}\n\t\tconst ev = new EventHandler()\n\n\t\t// TODO: \"this\" should be typed here\n\t\tconst obj = {\n\n\t\t\tid: uid(),\n\t\t\t// TODO: a nice way to hide / pause when add()-ing\n\t\t\thidden: false,\n\t\t\tpaused: false,\n\t\t\ttransform: new Mat4(),\n\t\t\tchildren: [],\n\t\t\tparent: null,\n\n\t\t\tadd<T2>(a: CompList<T2> | GameObj<T2>): GameObj<T2> {\n\t\t\t\tconst obj = (() => {\n\t\t\t\t\tif (Array.isArray(a)) {\n\t\t\t\t\t\treturn make(a)\n\t\t\t\t\t}\n\t\t\t\t\tif (a.parent) {\n\t\t\t\t\t\tthrow new Error(\"Cannot add a game obj that already has a parent.\")\n\t\t\t\t\t}\n\t\t\t\t\treturn a\n\t\t\t\t})()\n\t\t\t\tobj.parent = this\n\t\t\t\tobj.transform = calcTransform(obj)\n\t\t\t\tthis.children.push(obj)\n\t\t\t\tobj.trigger(\"add\", this)\n\t\t\t\tgame.ev.trigger(\"add\", this)\n\t\t\t\treturn obj\n\t\t\t},\n\n\t\t\treadd(obj: GameObj): GameObj {\n\t\t\t\tconst idx = this.children.indexOf(obj)\n\t\t\t\tif (idx !== -1) {\n\t\t\t\t\tthis.children.splice(idx, 1)\n\t\t\t\t\tthis.children.push(obj)\n\t\t\t\t}\n\t\t\t\treturn obj\n\t\t\t},\n\n\t\t\tremove(obj: GameObj): void {\n\t\t\t\tconst idx = this.children.indexOf(obj)\n\t\t\t\tif (idx !== -1) {\n\t\t\t\t\tobj.parent = null\n\t\t\t\t\tobj.trigger(\"destroy\")\n\t\t\t\t\tgame.ev.trigger(\"destroy\", obj)\n\t\t\t\t\tthis.children.splice(idx, 1)\n\t\t\t\t}\n\t\t\t},\n\n\t\t\tremoveAll(tag: Tag) {\n\t\t\t\tthis.get(tag).forEach((obj) => this.remove(obj))\n\t\t\t},\n\n\t\t\tupdate() {\n\t\t\t\tif (this.paused) return\n\t\t\t\tthis.get().forEach((child) => child.update())\n\t\t\t\tthis.trigger(\"update\")\n\t\t\t},\n\n\t\t\tdraw(this: GameObj<PosComp | ScaleComp | RotateComp>) {\n\t\t\t\tif (this.hidden) return\n\t\t\t\tpushTransform()\n\t\t\t\tpushTranslate(this.pos)\n\t\t\t\tpushScale(this.scale)\n\t\t\t\tpushRotateZ(this.angle)\n\t\t\t\tthis.trigger(\"draw\")\n\t\t\t\tthis.get().forEach((child) => child.draw())\n\t\t\t\tpopTransform()\n\t\t\t},\n\n\t\t\tdrawInspect(this: GameObj<PosComp | ScaleComp | RotateComp>) {\n\t\t\t\tif (this.hidden) return\n\t\t\t\tpushTransform()\n\t\t\t\tpushTranslate(this.pos)\n\t\t\t\tpushScale(this.scale)\n\t\t\t\tpushRotateZ(this.angle)\n\t\t\t\tthis.get().forEach((child) => child.drawInspect())\n\t\t\t\tthis.trigger(\"drawInspect\")\n\t\t\t\tpopTransform()\n\t\t\t},\n\n\t\t\t// use a comp, or tag\n\t\t\tuse(comp: Comp | Tag) {\n\n\t\t\t\tif (!comp) {\n\t\t\t\t\treturn\n\t\t\t\t}\n\n\t\t\t\t// tag\n\t\t\t\tif (typeof comp === \"string\") {\n\t\t\t\t\treturn this.use({\n\t\t\t\t\t\tid: comp,\n\t\t\t\t\t})\n\t\t\t\t}\n\n\t\t\t\t// clear if overwrite\n\t\t\t\tif (comp.id) {\n\t\t\t\t\tthis.unuse(comp.id)\n\t\t\t\t\tcompStates.set(comp.id, {\n\t\t\t\t\t\tcleanups: [],\n\t\t\t\t\t})\n\t\t\t\t}\n\n\t\t\t\t// state source location\n\t\t\t\tconst state = comp.id ? compStates.get(comp.id) : customState\n\t\t\t\tconst cleanups = comp.id ? state.cleanups : []\n\n\t\t\t\t// check for component dependencies\n\t\t\t\tconst checkDeps = () => {\n\t\t\t\t\tif (comp.require) {\n\t\t\t\t\t\tfor (const dep of comp.require) {\n\t\t\t\t\t\t\tif (!this.c(dep)) {\n\t\t\t\t\t\t\t\tthrow new Error(`Component \"${comp.id}\" requires component \"${dep}\"`)\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (comp.destroy) {\n\t\t\t\t\tcleanups.push(comp.destroy)\n\t\t\t\t}\n\n\t\t\t\tif (comp.require && !this.exists() && state.cleanups) {\n\t\t\t\t\tcleanups.push(this.on(\"add\", checkDeps))\n\t\t\t\t}\n\n\t\t\t\tfor (const k in comp) {\n\n\t\t\t\t\tif (COMP_DESC.has(k)) {\n\t\t\t\t\t\tcontinue\n\t\t\t\t\t}\n\n\t\t\t\t\t// event / custom method\n\t\t\t\t\tif (typeof comp[k] === \"function\") {\n\t\t\t\t\t\tconst func = comp[k].bind(this)\n\t\t\t\t\t\tif (COMP_EVENTS.has(k)) {\n\t\t\t\t\t\t\tcleanups.push(this.on(k, func))\n\t\t\t\t\t\t\tstate[k] = func\n\t\t\t\t\t\t\t// don't bind to game object if it's an event\n\t\t\t\t\t\t\tcontinue\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tstate[k] = func\n\t\t\t\t\t\t}\n\t\t\t\t\t} else {\n\t\t\t\t\t\tstate[k] = comp[k]\n\t\t\t\t\t}\n\n\t\t\t\t\tif (this[k] === undefined) {\n\t\t\t\t\t\t// assign comp fields to game obj\n\t\t\t\t\t\tObject.defineProperty(this, k, {\n\t\t\t\t\t\t\tget: () => state[k],\n\t\t\t\t\t\t\tset: (val) => state[k] = val,\n\t\t\t\t\t\t\tconfigurable: true,\n\t\t\t\t\t\t\tenumerable: true,\n\t\t\t\t\t\t})\n\t\t\t\t\t} else {\n\t\t\t\t\t\tthrow new Error(`Duplicate component property: \"${k}\"`)\n\t\t\t\t\t}\n\n\t\t\t\t}\n\n\t\t\t\t// manually trigger add event if object already exist\n\t\t\t\tif (this.exists()) {\n\t\t\t\t\tcheckDeps()\n\t\t\t\t\tif (comp.add) {\n\t\t\t\t\t\tcomp.add.call(this)\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t},\n\n\t\t\tunuse(id: Tag) {\n\t\t\t\tif (compStates.has(id)) {\n\t\t\t\t\tconst comp = compStates.get(id)\n\t\t\t\t\tcomp.cleanups.forEach((e) => e.cancel())\n\t\t\t\t\tfor (const k in comp) {\n\t\t\t\t\t\tdelete comp[k]\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tcompStates.delete(id)\n\t\t\t},\n\n\t\t\tc(id: Tag): Comp {\n\t\t\t\treturn compStates.get(id)\n\t\t\t},\n\n\t\t\t// TODO: cache sorted list? update each frame?\n\t\t\tget(t?: Tag | Tag[]): GameObj[] {\n\t\t\t\treturn this.children\n\t\t\t\t\t.filter((child) => t ? child.is(t) : true)\n\t\t\t\t\t.sort((o1, o2) => (o1.z ?? 0) - (o2.z ?? 0))\n\t\t\t},\n\n\t\t\tgetAll(t?: Tag | Tag[]): GameObj[] {\n\t\t\t\treturn this.children\n\t\t\t\t\t.sort((o1, o2) => (o1.z ?? 0) - (o2.z ?? 0))\n\t\t\t\t\t.flatMap((child) => [child, ...child.getAll(t)])\n\t\t\t\t\t.filter((child) => t ? child.is(t) : true)\n\t\t\t},\n\n\t\t\tisAncestorOf(obj: GameObj) {\n\t\t\t\tif (!obj.parent) {\n\t\t\t\t\treturn false\n\t\t\t\t}\n\t\t\t\treturn obj.parent === this || this.isAncestorOf(obj.parent)\n\t\t\t},\n\n\t\t\texists(): boolean {\n\t\t\t\treturn game.root.isAncestorOf(this)\n\t\t\t},\n\n\t\t\tis(tag: Tag | Tag[]): boolean {\n\t\t\t\tif (tag === \"*\") {\n\t\t\t\t\treturn true\n\t\t\t\t}\n\t\t\t\tif (Array.isArray(tag)) {\n\t\t\t\t\tfor (const t of tag) {\n\t\t\t\t\t\tif (!this.c(t)) {\n\t\t\t\t\t\t\treturn false\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\treturn true\n\t\t\t\t} else {\n\t\t\t\t\treturn this.c(tag) != null\n\t\t\t\t}\n\t\t\t},\n\n\t\t\ton(name: string, action: (...args) => void): EventController {\n\t\t\t\treturn ev.on(name, action.bind(this))\n\t\t\t},\n\n\t\t\ttrigger(name: string, ...args): void {\n\t\t\t\tev.trigger(name, ...args)\n\t\t\t\tgame.objEvents.trigger(name, this, ...args)\n\t\t\t},\n\n\t\t\tdestroy() {\n\t\t\t\tif (this.parent) {\n\t\t\t\t\tthis.parent.remove(this)\n\t\t\t\t}\n\t\t\t},\n\n\t\t\tinspect() {\n\t\t\t\tconst info = {}\n\t\t\t\tfor (const [tag, comp] of compStates) {\n\t\t\t\t\tinfo[tag] = comp.inspect ? comp.inspect() : null\n\t\t\t\t}\n\t\t\t\treturn info\n\t\t\t},\n\n\t\t\tonAdd(cb: () => void): EventController {\n\t\t\t\treturn this.on(\"add\", cb)\n\t\t\t},\n\n\t\t\tonUpdate(cb: () => void): EventController {\n\t\t\t\treturn this.on(\"update\", cb)\n\t\t\t},\n\n\t\t\tonDraw(cb: () => void): EventController {\n\t\t\t\treturn this.on(\"draw\", cb)\n\t\t\t},\n\n\t\t\tonDestroy(action: () => void): EventController {\n\t\t\t\treturn this.on(\"destroy\", action)\n\t\t\t},\n\n\t\t\tclearEvents() {\n\t\t\t\tev.clear()\n\t\t\t},\n\n\t\t}\n\n\t\tfor (const comp of comps) {\n\t\t\tobj.use(comp)\n\t\t}\n\n\t\treturn obj as unknown as GameObj<T>\n\n\t}\n\n\t// add an event to a tag\n\tfunction on(event: string, tag: Tag, cb: (obj: GameObj, ...args) => void): EventController {\n\t\tif (!game.objEvents[event]) {\n\t\t\tgame.objEvents[event] = new IDList()\n\t\t}\n\t\treturn game.objEvents.on(event, (obj, ...args) => {\n\t\t\tif (obj.is(tag)) {\n\t\t\t\tcb(obj, ...args)\n\t\t\t}\n\t\t})\n\t}\n\n\tfunction promisifyEvent(event: (action: () => void) => EventController): Promise<void> {\n\t\treturn new Promise((res) => {\n\t\t\tconst ev = event(() => {\n\t\t\t\tev.cancel()\n\t\t\t\tres()\n\t\t\t})\n\t\t})\n\t}\n\n\t// add update event to a tag or global update\n\tconst onUpdate = ((tag: Tag | (() => void), action?: (obj: GameObj) => void) => {\n\t\tif (typeof tag === \"function\" && action === undefined) {\n\t\t\tconst obj = add([{ update: tag }])\n\t\t\treturn {\n\t\t\t\tget paused() {\n\t\t\t\t\treturn obj.paused\n\t\t\t\t},\n\t\t\t\tset paused(p) {\n\t\t\t\t\tobj.paused = p\n\t\t\t\t},\n\t\t\t\tcancel: () => obj.destroy(),\n\t\t\t}\n\t\t} else if (typeof tag === \"string\") {\n\t\t\treturn on(\"update\", tag, action)\n\t\t} else if (tag === undefined && action === undefined) {\n\t\t\treturn promisifyEvent(onUpdate)\n\t\t}\n\t}) as KaboomCtx[\"onUpdate\"]\n\n\t// add draw event to a tag or global draw\n\tconst onDraw = ((tag: Tag | (() => void), action?: (obj: GameObj) => void) => {\n\t\tif (typeof tag === \"function\" && action === undefined) {\n\t\t\tconst obj = add([{ draw: tag }])\n\t\t\treturn {\n\t\t\t\tget paused() {\n\t\t\t\t\treturn obj.hidden\n\t\t\t\t},\n\t\t\t\tset paused(p) {\n\t\t\t\t\tobj.hidden = p\n\t\t\t\t},\n\t\t\t\tcancel: () => obj.destroy(),\n\t\t\t}\n\t\t} else if (typeof tag === \"string\") {\n\t\t\treturn on(\"draw\", tag, action)\n\t\t} else if (tag === undefined && action === undefined) {\n\t\t\treturn promisifyEvent(onDraw)\n\t\t}\n\t}) as KaboomCtx[\"onDraw\"]\n\n\tfunction onAdd(tag: Tag | ((obj: GameObj) => void), action?: (obj: GameObj) => void) {\n\t\tif (typeof tag === \"function\" && action === undefined) {\n\t\t\treturn game.ev.on(\"add\", tag)\n\t\t} else if (typeof tag === \"string\") {\n\t\t\treturn on(\"add\", tag, action)\n\t\t}\n\t}\n\n\tfunction onDestroy(tag: Tag | ((obj: GameObj) => void), action?: (obj: GameObj) => void) {\n\t\tif (typeof tag === \"function\" && action === undefined) {\n\t\t\treturn game.ev.on(\"destroy\", tag)\n\t\t} else if (typeof tag === \"string\") {\n\t\t\treturn on(\"destroy\", tag, action)\n\t\t}\n\t}\n\n\t// add an event that runs with objs with t1 collides with objs with t2\n\tfunction onCollide(\n\t\tt1: Tag,\n\t\tt2: Tag,\n\t\tf: (a: GameObj, b: GameObj, col?: Collision) => void,\n\t): EventController {\n\t\treturn on(\"collide\", t1, (a, b, col) => b.is(t2) && f(a, b, col))\n\t}\n\n\tfunction forAllCurrentAndFuture(t: Tag, action: (obj: GameObj) => void) {\n\t\tget(t).forEach(action)\n\t\tonAdd(t, action)\n\t}\n\n\t// add an event that runs when objs with tag t is clicked\n\tfunction onClick(tag: Tag | (() => void), action?: (obj: GameObj) => void): EventController {\n\t\tif (typeof tag === \"function\") {\n\t\t\treturn onMousePress(tag)\n\t\t} else {\n\t\t\tconst events = []\n\t\t\tforAllCurrentAndFuture(tag, (obj) => {\n\t\t\t\tif (!obj.area)\n\t\t\t\t\tthrow new Error(\"onClick() requires the object to have area() component\")\n\t\t\t\tevents.push(obj.onClick(() => action(obj)))\n\t\t\t})\n\t\t\treturn joinEventControllers(events)\n\t\t}\n\t}\n\n\t// add an event that runs once when objs with tag t is hovered\n\tfunction onHover(t: Tag, action: (obj: GameObj) => void): EventController {\n\t\tconst events = []\n\t\tforAllCurrentAndFuture(t, (obj) => {\n\t\t\tif (!obj.area)\n\t\t\t\tthrow new Error(\"onHover() requires the object to have area() component\")\n\t\t\tevents.push(obj.onHover(() => action(obj)))\n\t\t})\n\t\treturn joinEventControllers(events)\n\t}\n\n\t// add an event that runs once when objs with tag t is hovered\n\tfunction onHoverUpdate(t: Tag, action: (obj: GameObj) => void): EventController {\n\t\tconst events = []\n\t\tforAllCurrentAndFuture(t, (obj) => {\n\t\t\tif (!obj.area)\n\t\t\t\tthrow new Error(\"onHoverUpdate() requires the object to have area() component\")\n\t\t\tevents.push(obj.onHoverUpdate(() => action(obj)))\n\t\t})\n\t\treturn joinEventControllers(events)\n\t}\n\n\t// add an event that runs once when objs with tag t is unhovered\n\tfunction onHoverEnd(t: Tag, action: (obj: GameObj) => void): EventController {\n\t\tconst events = []\n\t\tforAllCurrentAndFuture(t, (obj) => {\n\t\t\tif (!obj.area)\n\t\t\t\tthrow new Error(\"onHoverEnd() requires the object to have area() component\")\n\t\t\tevents.push(obj.onHoverEnd(() => action(obj)))\n\t\t})\n\t\treturn joinEventControllers(events)\n\t}\n\n\t// TODO: use PromiseLike?\n\t// add an event that'd be run after t\n\tfunction wait(time: number, action?: () => void): TimerController {\n\t\tlet t = 0\n\t\tconst actions = []\n\t\tif (action) actions.push(action)\n\t\tconst ev = onUpdate(() => {\n\t\t\tt += dt()\n\t\t\tif (t >= time) {\n\t\t\t\tev.cancel()\n\t\t\t\tactions.forEach((action) => action())\n\t\t\t}\n\t\t})\n\t\treturn {\n\t\t\tpaused: ev.paused,\n\t\t\tcancel: ev.cancel,\n\t\t\tonFinish(action) {\n\t\t\t\tactions.push(action)\n\t\t\t},\n\t\t\tthen(action) {\n\t\t\t\tthis.onFinish(action)\n\t\t\t\treturn this\n\t\t\t},\n\t\t}\n\t}\n\n\t// add an event that's run every t seconds\n\tfunction loop(t: number, f: () => void): EventController {\n\n\t\tlet curTimer: null | TimerController = null\n\n\t\tconst newF = () => {\n\t\t\t// TODO: should f be execute right away as loop() is called?\n\t\t\tf()\n\t\t\tcurTimer = wait(t, newF)\n\t\t}\n\n\t\tnewF()\n\n\t\treturn {\n\t\t\tget paused() {\n\t\t\t\treturn curTimer.paused\n\t\t\t},\n\t\t\tset paused(p) {\n\t\t\t\tcurTimer.paused = p\n\t\t\t},\n\t\t\tcancel: () => curTimer.cancel(),\n\t\t}\n\n\t}\n\n\tfunction joinEventControllers(events: EventController[]): EventController {\n\t\treturn {\n\t\t\tget paused() {\n\t\t\t\treturn events[0].paused\n\t\t\t},\n\t\t\tset paused(p) {\n\t\t\t\tevents.forEach((e) => e.paused = p)\n\t\t\t},\n\t\t\tcancel: () => events.forEach((e) => e.cancel()),\n\t\t}\n\t}\n\n\t// input callbacks\n\tfunction onKeyDown(k: Key, f: () => void): EventController {\n\t\treturn game.ev.on(\"input\", () => isKeyDown(k) && f())\n\t}\n\n\tconst onKeyPress = ((\n\t\tk?: Key | ((k: Key) => void),\n\t\tf?: (k: Key) => void,\n\t) => {\n\t\tif (typeof k === \"function\") {\n\t\t\t// TODO: pass the pressed key\n\t\t\t// @ts-ignore\n\t\t\treturn game.ev.on(\"input\", () => isKeyPressed() && k())\n\t\t} else if (typeof k === \"string\" && typeof f === \"function\") {\n\t\t\treturn game.ev.on(\"input\", () => isKeyPressed(k) && f(k))\n\t\t} else if (typeof k === \"string\" && f === undefined) {\n\t\t\treturn promisifyEvent(onKeyPress.bind(undefined, k))\n\t\t} else if (typeof k === undefined && f === undefined) {\n\t\t\treturn promisifyEvent(onKeyPress)\n\t\t}\n\t}) as KaboomCtx[\"onKeyPress\"]\n\n\tconst onKeyPressRepeat = ((\n\t\tk?: Key | ((k: Key) => void),\n\t\tf?: (k: Key) => void,\n\t) => {\n\t\tif (typeof k === \"function\") {\n\t\t\t// TODO: pass the pressed key\n\t\t\t// @ts-ignore\n\t\t\treturn game.ev.on(\"input\", () => isKeyPressedRepeat() && k())\n\t\t} else if (typeof k === \"string\" && typeof f === \"function\") {\n\t\t\treturn game.ev.on(\"input\", () => isKeyPressedRepeat(k) && f(k))\n\t\t} else if (typeof k === \"string\" && f === undefined) {\n\t\t\treturn promisifyEvent(onKeyPressRepeat.bind(undefined, k))\n\t\t} else if (typeof k === undefined && f === undefined) {\n\t\t\treturn promisifyEvent(onKeyPressRepeat)\n\t\t}\n\t}) as KaboomCtx[\"onKeyPressRepeat\"]\n\n\tconst onKeyRelease = ((\n\t\tk?: Key | ((k: Key) => void),\n\t\tf?: (k: Key) => void,\n\t) => {\n\t\tif (typeof k === \"function\") {\n\t\t\t// TODO: pass the pressed key\n\t\t\t// @ts-ignore\n\t\t\treturn game.ev.on(\"input\", () => isKeyReleased() && k())\n\t\t} else if (typeof k === \"string\" && typeof f === \"function\") {\n\t\t\treturn game.ev.on(\"input\", () => isKeyReleased(k) && f(k))\n\t\t} else if (typeof k === \"string\" && f === undefined) {\n\t\t\treturn promisifyEvent(onKeyRelease.bind(undefined, k))\n\t\t} else if (typeof k === undefined && f === undefined) {\n\t\t\treturn promisifyEvent(onKeyRelease)\n\t\t}\n\t}) as KaboomCtx[\"onKeyRelease\"]\n\n\tfunction onMouseDown(\n\t\tm: MouseButton | ((pos?: Vec2) => void),\n\t\taction?: (pos?: Vec2) => void,\n\t): EventController {\n\t\tif (typeof m === \"function\") {\n\t\t\treturn game.ev.on(\"input\", () => isMouseDown() && m(mousePos()))\n\t\t} else {\n\t\t\treturn game.ev.on(\"input\", () => isMouseDown(m) && action(mousePos()))\n\t\t}\n\t}\n\n\tfunction onMousePress(\n\t\tm: MouseButton | ((pos?: Vec2) => void),\n\t\taction?: (pos?: Vec2) => void,\n\t): EventController {\n\t\tif (typeof m === \"function\") {\n\t\t\treturn game.ev.on(\"input\", () => isMousePressed() && m(mousePos()))\n\t\t} else {\n\t\t\treturn game.ev.on(\"input\", () => isMousePressed(m) && action(mousePos()))\n\t\t}\n\t}\n\n\tfunction onMouseRelease(\n\t\tm: MouseButton | ((pos?: Vec2) => void),\n\t\taction?: (pos?: Vec2) => void,\n\t): EventController {\n\t\tif (typeof m === \"function\") {\n\t\t\treturn game.ev.on(\"input\", () => isMouseReleased() && m(mousePos()))\n\t\t} else {\n\t\t\treturn game.ev.on(\"input\", () => isMouseReleased(m) && action(mousePos()))\n\t\t}\n\t}\n\n\tfunction onMouseMove(f: (pos: Vec2, dpos: Vec2) => void): EventController {\n\t\treturn game.ev.on(\"input\", () => isMouseMoved() && f(mousePos(), mouseDeltaPos()))\n\t}\n\n\tfunction onCharInput(f: (ch: string) => void): EventController {\n\t\treturn game.ev.on(\"input\", () => charInputted().forEach((ch) => f(ch)))\n\t}\n\n\tfunction onTouchStart(f: (pos: Vec2, t: Touch) => void): EventController {\n\t\treturn game.ev.on(\"onTouchStart\", f)\n\t}\n\n\tfunction onTouchMove(f: (pos: Vec2, t: Touch) => void): EventController {\n\t\treturn game.ev.on(\"onTouchMove\", f)\n\t}\n\n\tfunction onTouchEnd(f: (pos: Vec2, t: Touch) => void): EventController {\n\t\treturn game.ev.on(\"onTouchEnd\", f)\n\t}\n\n\tfunction onVirtualButtonPress(btn: VirtualButton, action: () => void): EventController {\n\t\treturn game.ev.on(\"input\", () => isVirtualButtonPressed(btn) && action())\n\t}\n\n\tfunction onVirtualButtonDown(btn: VirtualButton, action: () => void): EventController {\n\t\treturn game.ev.on(\"input\", () => isVirtualButtonDown(btn) && action())\n\t}\n\n\tfunction onVirtualButtonRelease(btn: VirtualButton, action: () => void): EventController {\n\t\treturn game.ev.on(\"input\", () => isVirtualButtonReleased(btn) && action())\n\t}\n\n\tfunction enterDebugMode() {\n\n\t\tonKeyPress(\"f1\", () => {\n\t\t\tdebug.inspect = !debug.inspect\n\t\t})\n\n\t\tonKeyPress(\"f2\", () => {\n\t\t\tdebug.clearLog()\n\t\t})\n\n\t\tonKeyPress(\"f8\", () => {\n\t\t\tdebug.paused = !debug.paused\n\t\t})\n\n\t\tonKeyPress(\"f7\", () => {\n\t\t\tdebug.timeScale = toFixed(clamp(debug.timeScale - 0.2, 0, 2), 1)\n\t\t})\n\n\t\tonKeyPress(\"f9\", () => {\n\t\t\tdebug.timeScale = toFixed(clamp(debug.timeScale + 0.2, 0, 2), 1)\n\t\t})\n\n\t\tonKeyPress(\"f10\", () => {\n\t\t\tdebug.stepFrame()\n\t\t})\n\n\t}\n\n\tfunction enterBurpMode() {\n\t\tonKeyPress(\"b\", () => burp())\n\t}\n\n\t// get / set gravity\n\tfunction gravity(g?: number): number {\n\t\tif (g !== undefined) {\n\t\t\tgame.gravity = g\n\t\t}\n\t\treturn game.gravity\n\t}\n\n\t// TODO: manage global velocity here?\n\tfunction pos(...args): PosComp {\n\n\t\treturn {\n\n\t\t\tid: \"pos\",\n\t\t\tpos: vec2(...args),\n\n\t\t\tmoveBy(...args) {\n\t\t\t\tthis.pos = this.pos.add(vec2(...args))\n\t\t\t},\n\n\t\t\t// move with velocity (pixels per second)\n\t\t\tmove(...args) {\n\t\t\t\tthis.moveBy(vec2(...args).scale(dt()))\n\t\t\t},\n\n\t\t\t// move to a destination, with optional speed\n\t\t\tmoveTo(...args) {\n\t\t\t\tif (typeof args[0] === \"number\" && typeof args[1] === \"number\") {\n\t\t\t\t\treturn this.moveTo(vec2(args[0], args[1]), args[2])\n\t\t\t\t}\n\t\t\t\tconst dest = args[0]\n\t\t\t\tconst speed = args[1]\n\t\t\t\tif (speed === undefined) {\n\t\t\t\t\tthis.pos = vec2(dest)\n\t\t\t\t\treturn\n\t\t\t\t}\n\t\t\t\tconst diff = dest.sub(this.pos)\n\t\t\t\tif (diff.len() <= speed * dt()) {\n\t\t\t\t\tthis.pos = vec2(dest)\n\t\t\t\t\treturn\n\t\t\t\t}\n\t\t\t\tthis.move(diff.unit().scale(speed))\n\t\t\t},\n\n\t\t\tworldPos(this: GameObj<PosComp>): Vec2 {\n\t\t\t\treturn this.parent\n\t\t\t\t\t? this.parent.transform.multVec2(this.pos)\n\t\t\t\t\t: this.pos\n\t\t\t},\n\n\t\t\t// get the screen position (transformed by camera)\n\t\t\tscreenPos(this: GameObj<PosComp | FixedComp>): Vec2 {\n\t\t\t\treturn this.fixed\n\t\t\t\t\t? this.pos\n\t\t\t\t\t: toScreen(this.pos)\n\t\t\t},\n\n\t\t\tinspect() {\n\t\t\t\treturn `(${Math.round(this.pos.x)}, ${Math.round(this.pos.y)})`\n\t\t\t},\n\n\t\t\tdrawInspect() {\n\t\t\t\tdrawCircle({\n\t\t\t\t\tcolor: rgb(255, 0, 0),\n\t\t\t\t\tradius: 4 / getViewportScale(),\n\t\t\t\t})\n\t\t\t},\n\n\t\t}\n\n\t}\n\n\t// TODO: allow single number assignment\n\tfunction scale(...args): ScaleComp {\n\t\tif (args.length === 0) {\n\t\t\treturn scale(1)\n\t\t}\n\t\treturn {\n\t\t\tid: \"scale\",\n\t\t\tscale: vec2(...args),\n\t\t\tscaleTo(...args) {\n\t\t\t\tthis.scale = vec2(...args)\n\t\t\t},\n\t\t\tinspect() {\n\t\t\t\tif (typeof this.scale === \"number\") {\n\t\t\t\t\treturn `${toFixed(this.scale, 2)}`\n\t\t\t\t} else {\n\t\t\t\t\treturn `(${toFixed(this.scale.x, 2)}, ${toFixed(this.scale.y, 2)})`\n\t\t\t\t}\n\t\t\t},\n\t\t}\n\t}\n\n\tfunction rotate(r: number): RotateComp {\n\t\treturn {\n\t\t\tid: \"rotate\",\n\t\t\tangle: r ?? 0,\n\t\t\trotate(angle: number) {\n\t\t\t\tthis.rotateBy(angle * dt())\n\t\t\t},\n\t\t\trotateBy(angle: number) {\n\t\t\t\tthis.angle += angle\n\t\t\t},\n\t\t\tinspect() {\n\t\t\t\treturn `${Math.round(this.angle)}`\n\t\t\t},\n\t\t}\n\t}\n\n\tfunction color(...args): ColorComp {\n\t\treturn {\n\t\t\tid: \"color\",\n\t\t\tcolor: rgb(...args),\n\t\t\tinspect() {\n\t\t\t\treturn this.color.toString()\n\t\t\t},\n\t\t}\n\t}\n\n\tfunction toFixed(n: number, f: number) {\n\t\treturn Number(n.toFixed(f))\n\t}\n\n\t// TODO: fadeIn here?\n\tfunction opacity(a: number): OpacityComp {\n\t\treturn {\n\t\t\tid: \"opacity\",\n\t\t\topacity: a ?? 1,\n\t\t\tinspect() {\n\t\t\t\treturn `${toFixed(this.opacity, 1)}`\n\t\t\t},\n\t\t\tfadeOut(time, easeFunc = easings.linear) {\n\t\t\t\treturn tween(this.opacity, 0, time, (a) => this.opacity = a, easeFunc)\n\t\t\t},\n\t\t}\n\t}\n\n\tfunction anchor(o: Anchor | Vec2): AnchorComp {\n\t\tif (!o) {\n\t\t\tthrow new Error(\"Please define an anchor\")\n\t\t}\n\t\treturn {\n\t\t\tid: \"anchor\",\n\t\t\tanchor: o,\n\t\t\tinspect() {\n\t\t\t\tif (typeof this.anchor === \"string\") {\n\t\t\t\t\treturn this.anchor\n\t\t\t\t} else {\n\t\t\t\t\treturn this.anchor.toString()\n\t\t\t\t}\n\t\t\t},\n\t\t}\n\t}\n\n\tfunction z(z: number): ZComp {\n\t\treturn {\n\t\t\tid: \"z\",\n\t\t\tz: z,\n\t\t\tinspect() {\n\t\t\t\treturn `${this.z}`\n\t\t\t},\n\t\t}\n\t}\n\n\tfunction follow(obj: GameObj, offset?: Vec2): FollowComp {\n\t\treturn {\n\t\t\tid: \"follow\",\n\t\t\trequire: [ \"pos\" ],\n\t\t\tfollow: {\n\t\t\t\tobj: obj,\n\t\t\t\toffset: offset ?? vec2(0),\n\t\t\t},\n\t\t\tadd(this: GameObj<FollowComp | PosComp>) {\n\t\t\t\tif (obj.exists()) {\n\t\t\t\t\tthis.pos = this.follow.obj.pos.add(this.follow.offset)\n\t\t\t\t}\n\t\t\t},\n\t\t\tupdate(this: GameObj<FollowComp | PosComp>) {\n\t\t\t\tif (obj.exists()) {\n\t\t\t\t\tthis.pos = this.follow.obj.pos.add(this.follow.offset)\n\t\t\t\t}\n\t\t\t},\n\t\t}\n\t}\n\n\tfunction move(dir: number | Vec2, speed: number): MoveComp {\n\t\tconst d = typeof dir === \"number\" ? Vec2.fromAngle(dir) : dir.unit()\n\t\treturn {\n\t\t\tid: \"move\",\n\t\t\trequire: [ \"pos\" ],\n\t\t\tupdate(this: GameObj<PosComp>) {\n\t\t\t\tthis.move(d.scale(speed))\n\t\t\t},\n\t\t}\n\t}\n\n\tconst DEF_OFFSCREEN_DIS = 200\n\n\tfunction offscreen(opt: OffScreenCompOpt = {}): OffScreenComp {\n\t\tconst distance = opt.distance ?? DEF_OFFSCREEN_DIS\n\t\tlet isOut = false\n\t\treturn {\n\t\t\tid: \"offscreen\",\n\t\t\trequire: [ \"pos\" ],\n\t\t\tisOffScreen(this: GameObj<PosComp>): boolean {\n\t\t\t\tconst pos = toScreen(this.pos)\n\t\t\t\tconst screenRect = new Rect(vec2(0), width(), height())\n\t\t\t\treturn !testRectPoint(screenRect, pos)\n\t\t\t\t\t&& screenRect.distToPoint(pos) > distance\n\t\t\t},\n\t\t\tonExitScreen(this: GameObj, action: () => void): EventController {\n\t\t\t\treturn this.on(\"exitView\", action)\n\t\t\t},\n\t\t\tonEnterScreen(this: GameObj, action: () => void): EventController {\n\t\t\t\treturn this.on(\"enterView\", action)\n\t\t\t},\n\t\t\tupdate(this: GameObj) {\n\t\t\t\tif (this.isOffScreen()) {\n\t\t\t\t\tif (!isOut) {\n\t\t\t\t\t\tthis.trigger(\"exitView\")\n\t\t\t\t\t\tisOut = true\n\t\t\t\t\t}\n\t\t\t\t\tif (opt.hide) this.hidden = true\n\t\t\t\t\tif (opt.pause) this.paused = true\n\t\t\t\t\tif (opt.destroy) this.destroy()\n\t\t\t\t} else {\n\t\t\t\t\tif (isOut) {\n\t\t\t\t\t\tthis.trigger(\"enterView\")\n\t\t\t\t\t\tisOut = false\n\t\t\t\t\t}\n\t\t\t\t\tif (opt.hide) this.hidden = false\n\t\t\t\t\tif (opt.pause) this.paused = false\n\t\t\t\t}\n\t\t\t},\n\t\t\tinspect() {\n\t\t\t\treturn `${this.isOffScreen()}`\n\t\t\t},\n\t\t}\n\t}\n\n\tfunction area(opt: AreaCompOpt = {}): AreaComp {\n\n\t\tconst events: Array<EventController> = []\n\n\t\treturn {\n\n\t\t\tid: \"area\",\n\t\t\tcolliding: {},\n\t\t\tcollisionIgnore: opt.collisionIgnore ?? [],\n\n\t\t\tadd(this: GameObj<AreaComp>) {\n\n\t\t\t\tif (this.area.cursor) {\n\t\t\t\t\tevents.push(this.onHover(() => setCursor(this.area.cursor)))\n\t\t\t\t}\n\n\t\t\t\tevents.push(this.onCollideUpdate((obj, col) => {\n\t\t\t\t\tif (!this.colliding[obj.id]) {\n\t\t\t\t\t\tthis.trigger(\"collide\", obj, col)\n\t\t\t\t\t}\n\t\t\t\t\tthis.colliding[obj.id] = col\n\t\t\t\t}))\n\n\t\t\t},\n\n\t\t\tupdate(this: GameObj) {\n\t\t\t\tfor (const id in this.colliding) {\n\t\t\t\t\tconst col = this.colliding[id]\n\t\t\t\t\tif (!this.checkCollision(col.target as GameObj<AreaComp>)) {\n\t\t\t\t\t\tdelete this.colliding[id]\n\t\t\t\t\t\tthis.trigger(\"collideEnd\", col.target, col)\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t},\n\n\t\t\tdrawInspect(this: GameObj<AreaComp | AnchorComp | FixedComp>) {\n\n\t\t\t\tconst a = this.localArea()\n\n\t\t\t\tpushTransform()\n\t\t\t\tpushScale(this.area.scale)\n\t\t\t\tpushTranslate(this.area.offset)\n\n\t\t\t\tconst opts = {\n\t\t\t\t\toutline: {\n\t\t\t\t\t\twidth: 4 / getViewportScale(),\n\t\t\t\t\t\tcolor: rgb(0, 0, 255),\n\t\t\t\t\t},\n\t\t\t\t\tanchor: this.anchor,\n\t\t\t\t\tfill: false,\n\t\t\t\t\tfixed: this.fixed,\n\t\t\t\t}\n\n\t\t\t\tif (a instanceof Rect) {\n\t\t\t\t\tdrawRect({\n\t\t\t\t\t\t...opts,\n\t\t\t\t\t\tpos: a.pos,\n\t\t\t\t\t\twidth: a.width,\n\t\t\t\t\t\theight: a.height,\n\t\t\t\t\t})\n\t\t\t\t} else if (a instanceof Polygon) {\n\t\t\t\t\tdrawPolygon({\n\t\t\t\t\t\t...opts,\n\t\t\t\t\t\tpts: a.pts,\n\t\t\t\t\t})\n\t\t\t\t} else if (a instanceof Circle) {\n\t\t\t\t\tdrawCircle({\n\t\t\t\t\t\t...opts,\n\t\t\t\t\t\tpos: a.center,\n\t\t\t\t\t\tradius: a.radius,\n\t\t\t\t\t})\n\t\t\t\t}\n\n\t\t\t\tpopTransform()\n\n\t\t\t},\n\n\t\t\tdestroy() {\n\t\t\t\tevents.forEach((e) => e.cancel())\n\t\t\t},\n\n\t\t\tarea: {\n\t\t\t\tshape: opt.shape ?? null,\n\t\t\t\tscale: opt.scale ?? vec2(1),\n\t\t\t\toffset: opt.offset ?? vec2(0),\n\t\t\t\tcursor: opt.cursor ?? null,\n\t\t\t},\n\n\t\t\tisClicked(): boolean {\n\t\t\t\treturn isMousePressed() && this.isHovering()\n\t\t\t},\n\n\t\t\tisHovering(this: GameObj) {\n\t\t\t\tconst mpos = this.fixed ? mousePos() : toWorld(mousePos())\n\t\t\t\treturn this.hasPoint(mpos)\n\t\t\t},\n\n\t\t\tcheckCollision(this: GameObj, other: GameObj<AreaComp>) {\n\t\t\t\tif (this === other || !other.area || !other.exists()) {\n\t\t\t\t\treturn null\n\t\t\t\t}\n\t\t\t\t// if (this.colliding[other.id]) {\n\t\t\t\t\t// return this.colliding[other.id]\n\t\t\t\t// }\n\t\t\t\tconst a1 = this.worldArea()\n\t\t\t\tconst a2 = other.worldArea()\n\t\t\t\treturn sat(a1, a2)\n\t\t\t},\n\n\t\t\tisColliding(other: GameObj<AreaComp>) {\n\t\t\t\tconst res = this.checkCollision(other)\n\t\t\t\treturn res && !res.isZero()\n\t\t\t},\n\n\t\t\tisTouching(other) {\n\t\t\t\treturn Boolean(this.checkCollision(other))\n\t\t\t},\n\n\t\t\tonClick(this: GameObj, f: () => void): EventController {\n\t\t\t\treturn this.onUpdate(() => {\n\t\t\t\t\tif (this.isClicked()) {\n\t\t\t\t\t\tf()\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t},\n\n\t\t\tonHover(this: GameObj, action: () => void): EventController {\n\t\t\t\tlet hovering = false\n\t\t\t\treturn this.onUpdate(() => {\n\t\t\t\t\tif (!hovering) {\n\t\t\t\t\t\tif (this.isHovering()) {\n\t\t\t\t\t\t\thovering = true\n\t\t\t\t\t\t\taction()\n\t\t\t\t\t\t}\n\t\t\t\t\t} else {\n\t\t\t\t\t\thovering = this.isHovering()\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t},\n\n\t\t\tonHoverUpdate(this: GameObj, onHover: () => void): EventController {\n\t\t\t\treturn this.onUpdate(() => {\n\t\t\t\t\tif (this.isHovering()) {\n\t\t\t\t\t\tonHover()\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t},\n\n\t\t\tonHoverEnd(this: GameObj, action: () => void): EventController {\n\t\t\t\tlet hovering = false\n\t\t\t\treturn this.onUpdate(() => {\n\t\t\t\t\tif (hovering) {\n\t\t\t\t\t\tif (!this.isHovering()) {\n\t\t\t\t\t\t\thovering = false\n\t\t\t\t\t\t\taction()\n\t\t\t\t\t\t}\n\t\t\t\t\t} else {\n\t\t\t\t\t\thovering = this.isHovering()\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t},\n\n\t\t\tonCollide(\n\t\t\t\tthis: GameObj,\n\t\t\t\ttag: Tag | ((obj: GameObj, col?: Collision) => void),\n\t\t\t\tcb?: (obj: GameObj, col?: Collision) => void,\n\t\t\t): EventController {\n\t\t\t\tif (typeof tag === \"function\" && cb === undefined) {\n\t\t\t\t\treturn this.on(\"collide\", tag)\n\t\t\t\t} else if (typeof tag === \"string\") {\n\t\t\t\t\treturn this.onCollide((obj, col) => {\n\t\t\t\t\t\tif (obj.is(tag)) {\n\t\t\t\t\t\t\tcb(obj, col)\n\t\t\t\t\t\t}\n\t\t\t\t\t})\n\t\t\t\t}\n\t\t\t},\n\n\t\t\tonCollideUpdate(\n\t\t\t\tthis: GameObj<AreaComp>,\n\t\t\t\ttag: Tag | ((obj: GameObj, col?: Collision) => void),\n\t\t\t\tcb?: (obj: GameObj, col?: Collision) => void,\n\t\t\t): EventController {\n\t\t\t\tif (typeof tag === \"function\" && cb === undefined) {\n\t\t\t\t\treturn this.on(\"collideUpdate\", tag)\n\t\t\t\t} else if (typeof tag === \"string\") {\n\t\t\t\t\treturn this.on(\"collideUpdate\", (obj, col) => obj.is(tag) && cb(obj, col))\n\t\t\t\t}\n\t\t\t},\n\n\t\t\tonCollideEnd(\n\t\t\t\tthis: GameObj<AreaComp>,\n\t\t\t\ttag: Tag | ((obj: GameObj) => void),\n\t\t\t\tcb?: (obj: GameObj) => void,\n\t\t\t): EventController {\n\t\t\t\tif (typeof tag === \"function\" && cb === undefined) {\n\t\t\t\t\treturn this.on(\"collideEnd\", tag)\n\t\t\t\t} else if (typeof tag === \"string\") {\n\t\t\t\t\treturn this.on(\"collideEnd\", (obj) => obj.is(tag) && cb(obj))\n\t\t\t\t}\n\t\t\t},\n\n\t\t\thasPoint(pt: Vec2): boolean {\n\t\t\t\treturn testPolygonPoint(this.worldArea(), pt)\n\t\t\t},\n\n\t\t\t// push an obj out of another if they're overlapped\n\t\t\tpushOut(this: GameObj<AreaComp | PosComp>, obj: GameObj<AreaComp>) {\n\t\t\t\tconst res = this.checkCollision(obj)\n\t\t\t\tif (res) {\n\t\t\t\t\tthis.pos = this.pos.add(res)\n\t\t\t\t}\n\t\t\t},\n\n\t\t\t// TODO: recursive\n\t\t\t// push object out of other solid objects\n\t\t\tpushOutAll() {\n\t\t\t\tgame.root.getAll().forEach(this.pushOut)\n\t\t\t},\n\n\t\t\tlocalArea(this: GameObj<AreaComp | { renderArea(): Shape }>): Shape {\n\t\t\t\treturn this.area.shape\n\t\t\t\t\t? this.area.shape\n\t\t\t\t\t: this.renderArea()\n\t\t\t},\n\n\t\t\t// TODO: cache\n\t\t\tworldArea(this: GameObj<AreaComp | AnchorComp>): Polygon {\n\n\t\t\t\tconst localArea = this.localArea()\n\n\t\t\t\tif (!(localArea instanceof Polygon || localArea instanceof Rect)) {\n\t\t\t\t\tthrow new Error(\"Only support polygon and rect shapes for now\")\n\t\t\t\t}\n\n\t\t\t\tlet transform = this.transform\n\t\t\t\t\t.scale(vec2(this.area.scale ?? 1))\n\t\t\t\t\t.translate(this.area.offset)\n\n\t\t\t\tif (localArea instanceof Rect) {\n\t\t\t\t\tconst bbox = localArea.bbox()\n\t\t\t\t\tconst offset = anchorPt(this.anchor || DEF_ANCHOR)\n\t\t\t\t\t\t.add(1, 1)\n\t\t\t\t\t\t.scale(-0.5)\n\t\t\t\t\t\t.scale(bbox.width, bbox.height)\n\t\t\t\t\ttransform = transform.translate(offset)\n\t\t\t\t}\n\n\t\t\t\treturn localArea.transform(transform) as Polygon\n\n\t\t\t},\n\n\t\t\tscreenArea(this: GameObj<AreaComp | FixedComp>): Polygon {\n\t\t\t\tconst area = this.worldArea()\n\t\t\t\tif (this.fixed) {\n\t\t\t\t\treturn area\n\t\t\t\t} else {\n\t\t\t\t\treturn area.transform(game.cam.transform)\n\t\t\t\t}\n\t\t\t},\n\n\t\t}\n\n\t}\n\n\t// make the list of common render properties from the \"pos\", \"scale\", \"color\", \"opacity\", \"rotate\", \"anchor\", \"outline\", and \"shader\" components of a game object\n\tfunction getRenderProps(obj: GameObj<any>) {\n\t\treturn {\n\t\t\tcolor: obj.color,\n\t\t\topacity: obj.opacity,\n\t\t\tanchor: obj.anchor,\n\t\t\toutline: obj.outline,\n\t\t\tfixed: obj.fixed,\n\t\t\tshader: obj.shader,\n\t\t\tuniform: obj.uniform,\n\t\t}\n\t}\n\n\t// TODO: clean\n\tfunction sprite(\n\t\tsrc: string | SpriteData | Asset<SpriteData>,\n\t\topt: SpriteCompOpt = {},\n\t): SpriteComp {\n\n\t\tlet spriteData: SpriteData | null = null\n\t\tlet curAnim: SpriteCurAnim | null = null\n\n\t\tif (!src) {\n\t\t\tthrow new Error(\"Please pass the resource name or data to sprite()\")\n\t\t}\n\n\t\tconst calcTexScale = (tex: Texture, q: Quad, w?: number, h?: number): Vec2 => {\n\t\t\tconst scale = vec2(1, 1)\n\t\t\tif (w && h) {\n\t\t\t\tscale.x = w / (tex.width * q.w)\n\t\t\t\tscale.y = h / (tex.height * q.h)\n\t\t\t} else if (w) {\n\t\t\t\tscale.x = w / (tex.width * q.w)\n\t\t\t\tscale.y = scale.x\n\t\t\t} else if (h) {\n\t\t\t\tscale.y = h / (tex.height * q.h)\n\t\t\t\tscale.x = scale.y\n\t\t\t}\n\t\t\treturn scale\n\t\t}\n\n\t\treturn {\n\n\t\t\tid: \"sprite\",\n\t\t\t// TODO: allow update\n\t\t\twidth: 0,\n\t\t\theight: 0,\n\t\t\tframe: opt.frame || 0,\n\t\t\tquad: opt.quad || new Quad(0, 0, 1, 1),\n\t\t\tanimSpeed: opt.animSpeed ?? 1,\n\n\t\t\tdraw(this: GameObj<SpriteComp>) {\n\t\t\t\tif (!spriteData) return\n\t\t\t\tdrawSprite({\n\t\t\t\t\t...getRenderProps(this),\n\t\t\t\t\tsprite: spriteData,\n\t\t\t\t\tframe: this.frame,\n\t\t\t\t\tquad: this.quad,\n\t\t\t\t\tflipX: opt.flipX,\n\t\t\t\t\tflipY: opt.flipY,\n\t\t\t\t\ttiled: opt.tiled,\n\t\t\t\t\twidth: opt.width,\n\t\t\t\t\theight: opt.height,\n\t\t\t\t})\n\t\t\t},\n\n\t\t\tupdate(this: GameObj<SpriteComp>) {\n\n\t\t\t\tif (!spriteData) {\n\n\t\t\t\t\tconst spr = resolveSprite(src)\n\n\t\t\t\t\tif (!spr || !spr.data) {\n\t\t\t\t\t\treturn\n\t\t\t\t\t}\n\n\t\t\t\t\tlet q = spr.data.frames[0].clone()\n\n\t\t\t\t\tif (opt.quad) {\n\t\t\t\t\t\tq = q.scale(opt.quad)\n\t\t\t\t\t}\n\n\t\t\t\t\tconst scale = calcTexScale(spr.data.tex, q, opt.width, opt.height)\n\n\t\t\t\t\tthis.width = spr.data.tex.width * q.w * scale.x\n\t\t\t\t\tthis.height = spr.data.tex.height * q.h * scale.y\n\n\t\t\t\t\tif (opt.anim) {\n\t\t\t\t\t\tthis.play(opt.anim)\n\t\t\t\t\t}\n\n\t\t\t\t\tspriteData = spr.data\n\t\t\t\t\tthis.trigger(\"spriteLoaded\", spriteData)\n\n\t\t\t\t}\n\n\t\t\t\tif (!curAnim) {\n\t\t\t\t\treturn\n\t\t\t\t}\n\n\t\t\t\tconst anim = spriteData.anims[curAnim.name]\n\n\t\t\t\tif (typeof anim === \"number\") {\n\t\t\t\t\tthis.frame = anim\n\t\t\t\t\treturn\n\t\t\t\t}\n\n\t\t\t\tif (anim.speed === 0) {\n\t\t\t\t\tthrow new Error(\"Sprite anim speed cannot be 0\")\n\t\t\t\t}\n\n\t\t\t\tcurAnim.timer += dt() * this.animSpeed\n\n\t\t\t\tif (curAnim.timer >= (1 / curAnim.speed)) {\n\t\t\t\t\tcurAnim.timer = 0\n\t\t\t\t\t// TODO: clean up\n\t\t\t\t\tif (anim.from > anim.to) {\n\t\t\t\t\t\tthis.frame--\n\t\t\t\t\t\tif (this.frame < anim.to) {\n\t\t\t\t\t\t\tif (curAnim.loop) {\n\t\t\t\t\t\t\t\tthis.frame = anim.from\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tthis.frame++\n\t\t\t\t\t\t\t\tcurAnim.onEnd()\n\t\t\t\t\t\t\t\tthis.stop()\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t} else {\n\t\t\t\t\t\tthis.frame++\n\t\t\t\t\t\tif (this.frame > anim.to) {\n\t\t\t\t\t\t\tif (curAnim.loop) {\n\t\t\t\t\t\t\t\tthis.frame = anim.from\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tthis.frame--\n\t\t\t\t\t\t\t\tcurAnim.onEnd()\n\t\t\t\t\t\t\t\tthis.stop()\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t},\n\n\t\t\tplay(this: GameObj<SpriteComp>, name: string, opt: SpriteAnimPlayOpt = {}) {\n\n\t\t\t\tif (!spriteData) {\n\t\t\t\t\tthis.on(\"spriteLoaded\", () => {\n\t\t\t\t\t\tthis.play(name, opt)\n\t\t\t\t\t})\n\t\t\t\t\treturn\n\t\t\t\t}\n\n\t\t\t\tconst anim = spriteData.anims[name]\n\n\t\t\t\tif (!anim) {\n\t\t\t\t\tthrow new Error(`Anim not found: ${name}`)\n\t\t\t\t}\n\n\t\t\t\tif (curAnim) {\n\t\t\t\t\tthis.stop()\n\t\t\t\t}\n\n\t\t\t\tcurAnim = typeof anim === \"number\"\n\t\t\t\t\t? {\n\t\t\t\t\t\tname: name,\n\t\t\t\t\t\ttimer: 0,\n\t\t\t\t\t\tloop: false,\n\t\t\t\t\t\tpingpong: false,\n\t\t\t\t\t\tspeed: 0,\n\t\t\t\t\t\tonEnd: () => {},\n\t\t\t\t\t}\n\t\t\t\t\t: {\n\t\t\t\t\t\tname: name,\n\t\t\t\t\t\ttimer: 0,\n\t\t\t\t\t\tloop: opt.loop ?? anim.loop ?? false,\n\t\t\t\t\t\tpingpong: opt.pingpong ?? anim.pingpong ?? false,\n\t\t\t\t\t\tspeed: opt.speed ?? anim.speed ?? 10,\n\t\t\t\t\t\tonEnd: opt.onEnd ?? (() => {}),\n\t\t\t\t\t}\n\n\t\t\t\tthis.frame = typeof anim === \"number\"\n\t\t\t\t\t? anim\n\t\t\t\t\t: anim.from\n\n\t\t\t\tthis.trigger(\"animStart\", name)\n\n\t\t\t},\n\n\t\t\tstop(this: GameObj<SpriteComp>) {\n\t\t\t\tif (!curAnim) {\n\t\t\t\t\treturn\n\t\t\t\t}\n\t\t\t\tconst prevAnim = curAnim.name\n\t\t\t\tcurAnim = null\n\t\t\t\tthis.trigger(\"animEnd\", prevAnim)\n\t\t\t},\n\n\t\t\tnumFrames() {\n\t\t\t\tif (!spriteData) {\n\t\t\t\t\treturn 0\n\t\t\t\t}\n\t\t\t\treturn spriteData.frames.length\n\t\t\t},\n\n\t\t\tcurAnim() {\n\t\t\t\treturn curAnim?.name\n\t\t\t},\n\n\t\t\tflipX(b: boolean) {\n\t\t\t\topt.flipX = b\n\t\t\t},\n\n\t\t\tflipY(b: boolean) {\n\t\t\t\topt.flipY = b\n\t\t\t},\n\n\t\t\tonAnimEnd(\n\t\t\t\tthis: GameObj<SpriteComp>,\n\t\t\t\tname: string,\n\t\t\t\taction: () => void,\n\t\t\t): EventController {\n\t\t\t\treturn this.on(\"animEnd\", (anim) => {\n\t\t\t\t\tif (anim === name) {\n\t\t\t\t\t\taction()\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t},\n\n\t\t\tonAnimStart(\n\t\t\t\tthis: GameObj<SpriteComp>,\n\t\t\t\tname: string,\n\t\t\t\taction: () => void,\n\t\t\t): EventController {\n\t\t\t\treturn this.on(\"animStart\", (anim) => {\n\t\t\t\t\tif (anim === name) {\n\t\t\t\t\t\taction()\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t},\n\n\t\t\trenderArea() {\n\t\t\t\treturn new Rect(vec2(0), this.width, this.height)\n\t\t\t},\n\n\t\t\tinspect() {\n\t\t\t\tif (typeof src === \"string\") {\n\t\t\t\t\treturn `\"${src}\"`\n\t\t\t\t}\n\t\t\t},\n\n\t\t}\n\n\t}\n\n\tfunction text(t: string, opt: TextCompOpt = {}): TextComp {\n\n\t\tfunction update(obj: GameObj<TextComp | any>) {\n\n\t\t\tconst ftext = formatText({\n\t\t\t\t...getRenderProps(obj),\n\t\t\t\ttext: obj.text + \"\",\n\t\t\t\tsize: obj.textSize,\n\t\t\t\tfont: obj.font,\n\t\t\t\twidth: opt.width && obj.width,\n\t\t\t\talign: obj.align,\n\t\t\t\tletterSpacing: obj.letterSpacing,\n\t\t\t\tlineSpacing: obj.lineSpacing,\n\t\t\t\ttransform: obj.textTransform,\n\t\t\t\tstyles: obj.textStyles,\n\t\t\t})\n\n\t\t\tif (!opt.width) {\n\t\t\t\tobj.width = ftext.width / (obj.scale?.x || 1)\n\t\t\t}\n\n\t\t\tobj.height = ftext.height / (obj.scale?.y || 1)\n\n\t\t\treturn ftext\n\n\t\t}\n\n\t\treturn {\n\n\t\t\tid: \"text\",\n\t\t\ttext: t,\n\t\t\ttextSize: opt.size ?? DEF_TEXT_SIZE,\n\t\t\tfont: opt.font,\n\t\t\twidth: opt.width,\n\t\t\theight: 0,\n\t\t\talign: opt.align,\n\t\t\tlineSpacing: opt.lineSpacing,\n\t\t\tletterSpacing: opt.letterSpacing,\n\t\t\ttextTransform: opt.transform,\n\t\t\ttextStyles: opt.styles,\n\n\t\t\tadd(this: GameObj<TextComp>) {\n\t\t\t\tonLoad(() => update(this))\n\t\t\t},\n\n\t\t\tdraw(this: GameObj<TextComp>) {\n\t\t\t\tdrawFormattedText(update(this))\n\t\t\t},\n\n\t\t\trenderArea() {\n\t\t\t\treturn new Rect(vec2(0), this.width, this.height)\n\t\t\t},\n\n\t\t}\n\n\t}\n\n\tfunction rect(w: number, h: number, opt: RectCompOpt = {}): RectComp {\n\t\treturn {\n\t\t\tid: \"rect\",\n\t\t\twidth: w,\n\t\t\theight: h,\n\t\t\tradius: opt.radius || 0,\n\t\t\tdraw(this: GameObj<RectComp>) {\n\t\t\t\tdrawRect({\n\t\t\t\t\t...getRenderProps(this),\n\t\t\t\t\twidth: this.width,\n\t\t\t\t\theight: this.height,\n\t\t\t\t\tradius: this.radius,\n\t\t\t\t})\n\t\t\t},\n\t\t\trenderArea() {\n\t\t\t\treturn new Rect(vec2(0), this.width, this.height)\n\t\t\t},\n\t\t\tinspect() {\n\t\t\t\treturn `${Math.ceil(this.width)}, ${Math.ceil(this.height)}`\n\t\t\t},\n\t\t}\n\t}\n\n\tfunction uvquad(w: number, h: number): UVQuadComp {\n\t\treturn {\n\t\t\tid: \"rect\",\n\t\t\twidth: w,\n\t\t\theight: h,\n\t\t\tdraw(this: GameObj<UVQuadComp>) {\n\t\t\t\tdrawUVQuad({\n\t\t\t\t\t...getRenderProps(this),\n\t\t\t\t\twidth: this.width,\n\t\t\t\t\theight: this.height,\n\t\t\t\t})\n\t\t\t},\n\t\t\trenderArea() {\n\t\t\t\treturn new Rect(vec2(0), this.width, this.height)\n\t\t\t},\n\t\t\tinspect() {\n\t\t\t\treturn `${Math.ceil(this.width)}, ${Math.ceil(this.height)}`\n\t\t\t},\n\t\t}\n\t}\n\n\tfunction circle(radius: number): CircleComp {\n\t\treturn {\n\t\t\tid: \"circle\",\n\t\t\tradius: radius,\n\t\t\tdraw(this: GameObj<CircleComp>) {\n\t\t\t\tdrawCircle({\n\t\t\t\t\t...getRenderProps(this),\n\t\t\t\t\tradius: this.radius,\n\t\t\t\t})\n\t\t\t},\n\t\t\trenderArea() {\n\t\t\t\treturn new Circle(vec2(0), this.radius)\n\t\t\t},\n\t\t\tinspect() {\n\t\t\t\treturn `${Math.ceil(this.radius)}`\n\t\t\t},\n\t\t}\n\t}\n\n\tfunction outline(width: number = 1, color: Color = rgb(0, 0, 0)): OutlineComp {\n\t\treturn {\n\t\t\tid: \"outline\",\n\t\t\toutline: {\n\t\t\t\twidth,\n\t\t\t\tcolor,\n\t\t\t},\n\t\t}\n\t}\n\n\tfunction timer(time?: number, action?: () => void): TimerComp {\n\t\tconst timers: IDList<Timer> = new IDList()\n\t\tif (time && action) {\n\t\t\ttimers.pushd(new Timer(time, action))\n\t\t}\n\t\treturn {\n\t\t\tid: \"timer\",\n\t\t\twait(time: number, action: () => void): EventController {\n\t\t\t\tconst timer = new Timer(time, action)\n\t\t\t\tconst cancel = timers.pushd(timer)\n\t\t\t\treturn {\n\t\t\t\t\tget paused() {\n\t\t\t\t\t\treturn timer.paused\n\t\t\t\t\t},\n\t\t\t\t\tset paused(p) {\n\t\t\t\t\t\ttimer.paused = p\n\t\t\t\t\t},\n\t\t\t\t\tcancel: cancel,\n\t\t\t\t}\n\t\t\t},\n\t\t\tupdate() {\n\t\t\t\ttimers.forEach((timer, id) => {\n\t\t\t\t\tif (timer.tick(dt())) {\n\t\t\t\t\t\ttimers.delete(id)\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t},\n\t\t}\n\t}\n\n\t// maximum y velocity with body()\n\tconst DEF_JUMP_FORCE = 640\n\tconst MAX_VEL = 65536\n\n\t// TODO: land on wall\n\tfunction body(opt: BodyCompOpt = {}): BodyComp {\n\n\t\tlet velY = 0\n\t\tlet curPlatform: GameObj<PosComp | AreaComp | BodyComp> | null = null\n\t\tlet lastPlatformPos = null\n\t\tlet wantFall = false\n\t\tconst events: Array<EventController> = []\n\n\t\treturn {\n\n\t\t\tid: \"body\",\n\t\t\trequire: [ \"pos\", \"area\" ],\n\t\t\tjumpForce: opt.jumpForce ?? DEF_JUMP_FORCE,\n\t\t\tgravityScale: opt.gravityScale ?? 1,\n\t\t\tisStatic: opt.isStatic ?? false,\n\t\t\tmass: opt.mass ?? 0,\n\n\t\t\tadd(this: GameObj<BodyComp | AreaComp>) {\n\n\t\t\t\t// TODO\n\t\t\t\t// static vs static: don't resolve\n\t\t\t\t// static vs non-static: always resolve non-static\n\t\t\t\t// non-static vs non-static: resolve the first one\n\t\t\t\tevents.push(this.onCollideUpdate((other, col) => {\n\n\t\t\t\t\tif (!other.is(\"body\")) {\n\t\t\t\t\t\treturn\n\t\t\t\t\t}\n\n\t\t\t\t\tif (col.resolved) {\n\t\t\t\t\t\treturn\n\t\t\t\t\t}\n\n\t\t\t\t\tif (this.isStatic && other.isStatic) {\n\t\t\t\t\t\treturn\n\t\t\t\t\t}\n\n\t\t\t\t\t// TODO: if both not static, use mass, or use velocity?\n\n\t\t\t\t\t// resolve the non static one\n\t\t\t\t\tconst col2 = (!this.isStatic && other.isStatic) ? col : col.reverse()\n\t\t\t\t\tcol2.source.trigger(\"beforePhysicsResolve\", col2)\n\t\t\t\t\tcol2.target.trigger(\"beforePhysicsResolve\", col2.reverse())\n\n\t\t\t\t\t// user can mark 'resolved' in beforePhysicsResolve to stop a resolution\n\t\t\t\t\tif (col.resolved) {\n\t\t\t\t\t\treturn\n\t\t\t\t\t}\n\n\t\t\t\t\tcol2.source.pos = col2.source.pos.add(col2.displacement)\n\t\t\t\t\t// TODO: update all children transform?\n\t\t\t\t\tcol2.source.transform = calcTransform(col2.source)\n\t\t\t\t\tcol.resolved = true\n\t\t\t\t\tcol2.source.trigger(\"physicsResolve\", col2)\n\t\t\t\t\tcol2.target.trigger(\"physicsResolve\", col2.reverse())\n\n\t\t\t\t}))\n\n\t\t\t\tevents.push(this.onPhysicsResolve((col) => {\n\t\t\t\t\tif (game.gravity) {\n\t\t\t\t\t\tif (col.isBottom() && this.isFalling()) {\n\t\t\t\t\t\t\tvelY = 0\n\t\t\t\t\t\t\tcurPlatform = col.target as GameObj<PosComp | BodyComp | AreaComp>\n\t\t\t\t\t\t\tlastPlatformPos = col.target.pos\n\t\t\t\t\t\t\tif (wantFall) {\n\t\t\t\t\t\t\t\twantFall = false\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tthis.trigger(\"ground\", curPlatform)\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else if (col.isTop() && this.isJumping()) {\n\t\t\t\t\t\t\tvelY = 0\n\t\t\t\t\t\t\tthis.trigger(\"headbutt\", col.target)\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}))\n\n\t\t\t},\n\n\t\t\tupdate(this: GameObj<PosComp | BodyComp | AreaComp>) {\n\n\t\t\t\tif (!game.gravity) {\n\t\t\t\t\treturn\n\t\t\t\t}\n\n\t\t\t\tif (this.isStatic) {\n\t\t\t\t\treturn\n\t\t\t\t}\n\n\t\t\t\tif (wantFall) {\n\t\t\t\t\tcurPlatform = null\n\t\t\t\t\tlastPlatformPos = null\n\t\t\t\t\tthis.trigger(\"fallOff\")\n\t\t\t\t\twantFall = false\n\t\t\t\t}\n\n\t\t\t\tif (curPlatform) {\n\t\t\t\t\tif (\n\t\t\t\t\t\t!this.isTouching(curPlatform)\n\t\t\t\t\t\t|| !curPlatform.exists()\n\t\t\t\t\t\t|| !curPlatform.is(\"body\")\n\t\t\t\t\t) {\n\t\t\t\t\t\twantFall = true\n\t\t\t\t\t} else {\n\t\t\t\t\t\tif (\n\t\t\t\t\t\t\t!curPlatform.pos.eq(lastPlatformPos)\n\t\t\t\t\t\t\t&& opt.stickToPlatform !== false\n\t\t\t\t\t\t) {\n\t\t\t\t\t\t\tthis.moveBy(curPlatform.pos.sub(lastPlatformPos))\n\t\t\t\t\t\t}\n\t\t\t\t\t\tlastPlatformPos = curPlatform.pos\n\t\t\t\t\t\treturn\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tconst prevVelY = velY\n\t\t\t\tvelY += game.gravity * this.gravityScale * dt()\n\t\t\t\tvelY = Math.min(velY, opt.maxVelocity ?? MAX_VEL)\n\t\t\t\tif (prevVelY < 0 && velY >= 0) {\n\t\t\t\t\tthis.trigger(\"fall\")\n\t\t\t\t}\n\t\t\t\tthis.move(0, velY)\n\n\t\t\t},\n\n\t\t\tdestroy() {\n\t\t\t\tevents.forEach((e) => e.cancel())\n\t\t\t},\n\n\t\t\tonPhysicsResolve(this: GameObj, action) {\n\t\t\t\treturn this.on(\"physicsResolve\", action)\n\t\t\t},\n\n\t\t\tonBeforePhysicsResolve(this: GameObj, action) {\n\t\t\t\treturn this.on(\"beforePhysicsResolve\", action)\n\t\t\t},\n\n\t\t\tcurPlatform(): GameObj | null {\n\t\t\t\treturn curPlatform\n\t\t\t},\n\n\t\t\tisGrounded() {\n\t\t\t\treturn curPlatform !== null\n\t\t\t},\n\n\t\t\tisFalling(): boolean {\n\t\t\t\treturn velY > 0\n\t\t\t},\n\n\t\t\tisJumping(): boolean {\n\t\t\t\treturn velY < 0\n\t\t\t},\n\n\t\t\tjump(force: number) {\n\t\t\t\tcurPlatform = null\n\t\t\t\tlastPlatformPos = null\n\t\t\t\tvelY = -force || -this.jumpForce\n\t\t\t},\n\n\t\t\tonGround(this: GameObj, action: () => void): EventController {\n\t\t\t\treturn this.on(\"ground\", action)\n\t\t\t},\n\n\t\t\tonFall(this: GameObj, action: () => void): EventController {\n\t\t\t\treturn this.on(\"fall\", action)\n\t\t\t},\n\n\t\t\tonFallOff(this: GameObj, action: () => void): EventController {\n\t\t\t\treturn this.on(\"fallOff\", action)\n\t\t\t},\n\n\t\t\tonHeadbutt(this: GameObj, action: () => void): EventController {\n\t\t\t\treturn this.on(\"headbutt\", action)\n\t\t\t},\n\n\t\t}\n\n\t}\n\n\tfunction doubleJump(numJumps: number = 2): DoubleJumpComp {\n\t\tlet jumpsLeft = numJumps\n\t\tconst events = []\n\t\treturn {\n\t\t\tid: \"doubleJump\",\n\t\t\trequire: [ \"body\" ],\n\t\t\tnumJumps: numJumps,\n\t\t\tadd(this: GameObj<BodyComp | DoubleJumpComp>) {\n\t\t\t\tevents.push(this.onGround(() => {\n\t\t\t\t\tjumpsLeft = this.numJumps\n\t\t\t\t}))\n\t\t\t},\n\t\t\tdestroy() {\n\t\t\t\tevents.forEach((e) => e.cancel())\n\t\t\t},\n\t\t\tdoubleJump(this: GameObj<BodyComp | DoubleJumpComp>, force?: number) {\n\t\t\t\tif (jumpsLeft <= 0) {\n\t\t\t\t\treturn\n\t\t\t\t}\n\t\t\t\tif (jumpsLeft < this.numJumps) {\n\t\t\t\t\tthis.trigger(\"doubleJump\")\n\t\t\t\t}\n\t\t\t\tjumpsLeft--\n\t\t\t\tthis.jump(force)\n\t\t\t},\n\t\t\tonDoubleJump(this: GameObj, action: () => void): EventController {\n\t\t\t\treturn this.on(\"doubleJump\", action)\n\t\t\t},\n\t\t\tinspect(this: GameObj<BodyComp | DoubleJumpComp>) {\n\t\t\t\treturn `${jumpsLeft}`\n\t\t\t},\n\t\t}\n\t}\n\n\tfunction shader(id: string, uniform: Uniform = {}): ShaderComp {\n\t\treturn {\n\t\t\tid: \"shader\",\n\t\t\tshader: id,\n\t\t\tuniform: uniform,\n\t\t}\n\t}\n\n\t// TODO: all children should be fixed\n\tfunction fixed(): FixedComp {\n\t\treturn {\n\t\t\tid: \"fixed\",\n\t\t\tfixed: true,\n\t\t}\n\t}\n\n\tfunction stay(scenesToStay?: string[]): StayComp {\n\t\treturn {\n\t\t\tid: \"stay\",\n\t\t\tstay: true,\n\t\t\tscenesToStay: scenesToStay,\n\t\t}\n\t}\n\n\tfunction health(hp: number): HealthComp {\n\t\tif (hp == null) {\n\t\t\tthrow new Error(\"health() requires the initial amount of hp\")\n\t\t}\n\t\treturn {\n\t\t\tid: \"health\",\n\t\t\thurt(this: GameObj, n: number = 1) {\n\t\t\t\tthis.setHP(hp - n)\n\t\t\t\tthis.trigger(\"hurt\")\n\t\t\t},\n\t\t\theal(this: GameObj, n: number = 1) {\n\t\t\t\tthis.setHP(hp + n)\n\t\t\t\tthis.trigger(\"heal\")\n\t\t\t},\n\t\t\thp(): number {\n\t\t\t\treturn hp\n\t\t\t},\n\t\t\tsetHP(this: GameObj, n: number) {\n\t\t\t\thp = n\n\t\t\t\tif (hp <= 0) {\n\t\t\t\t\tthis.trigger(\"death\")\n\t\t\t\t}\n\t\t\t},\n\t\t\tonHurt(this: GameObj, action: () => void): EventController {\n\t\t\t\treturn this.on(\"hurt\", action)\n\t\t\t},\n\t\t\tonHeal(this: GameObj, action: () => void): EventController {\n\t\t\t\treturn this.on(\"heal\", action)\n\t\t\t},\n\t\t\tonDeath(this: GameObj, action: () => void): EventController {\n\t\t\t\treturn this.on(\"death\", action)\n\t\t\t},\n\t\t\tinspect() {\n\t\t\t\treturn `${hp}`\n\t\t\t},\n\t\t}\n\t}\n\n\tfunction lifespan(time: number, opt: LifespanCompOpt = {}): LifespanComp {\n\t\tif (time == null) {\n\t\t\tthrow new Error(\"lifespan() requires time\")\n\t\t}\n\t\tconst fade = opt.fade ?? 0\n\t\treturn {\n\t\t\tid: \"lifespan\",\n\t\t\tasync add(this: GameObj<OpacityComp>) {\n\t\t\t\tawait wait(time)\n\t\t\t\t// TODO: this secretively requires opacity comp, make opacity on every game obj?\n\t\t\t\tif (fade > 0 && this.opacity) {\n\t\t\t\t\tawait tween(this.opacity, 0, fade, (a) => this.opacity = a, easings.linear)\n\t\t\t\t}\n\t\t\t\tthis.destroy()\n\t\t\t},\n\t\t}\n\t}\n\n\tfunction state(\n\t\tinitState: string,\n\t\tstateList?: string[],\n\t\ttransitions?: Record<string, string | string[]>,\n\t): StateComp {\n\n\t\tif (!initState) {\n\t\t\tthrow new Error(\"state() requires an initial state\")\n\t\t}\n\n\t\tconst events = {}\n\n\t\tfunction initStateEvents(state: string) {\n\t\t\tif (!events[state]) {\n\t\t\t\tevents[state] = {\n\t\t\t\t\tenter: new Event(),\n\t\t\t\t\tend: new Event(),\n\t\t\t\t\tupdate: new Event(),\n\t\t\t\t\tdraw: new Event(),\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tfunction on(event, state, action) {\n\t\t\tinitStateEvents(state)\n\t\t\treturn events[state][event].add(action)\n\t\t}\n\n\t\tfunction trigger(event, state, ...args) {\n\t\t\tinitStateEvents(state)\n\t\t\tevents[state][event].trigger(...args)\n\t\t}\n\n\t\tlet didFirstEnter = false\n\n\t\treturn {\n\n\t\t\tid: \"state\",\n\t\t\tstate: initState,\n\n\t\t\tenterState(state: string, ...args) {\n\n\t\t\t\tdidFirstEnter = true\n\n\t\t\t\tif (stateList && !stateList.includes(state)) {\n\t\t\t\t\tthrow new Error(`State not found: ${state}`)\n\t\t\t\t}\n\n\t\t\t\tconst oldState = this.state\n\n\t\t\t\tif (transitions) {\n\n\t\t\t\t\t// check if the transition is legal, if transition graph is defined\n\t\t\t\t\tif (!transitions?.[oldState]) {\n\t\t\t\t\t\treturn\n\t\t\t\t\t}\n\n\t\t\t\t\tconst available = typeof transitions[oldState] === \"string\"\n\t\t\t\t\t\t? [transitions[oldState]]\n\t\t\t\t\t\t: transitions[oldState] as string[]\n\n\t\t\t\t\tif (!available.includes(state)) {\n\t\t\t\t\t\tthrow new Error(`Cannot transition state from \"${oldState}\" to \"${state}\". Available transitions: ${available.map((s) => `\"${s}\"`).join(\", \")}`)\n\t\t\t\t\t}\n\n\t\t\t\t}\n\n\t\t\t\ttrigger(\"end\", oldState, ...args)\n\t\t\t\tthis.state = state\n\t\t\t\ttrigger(\"enter\", state, ...args)\n\t\t\t\ttrigger(\"enter\", `${oldState} -> ${state}`, ...args)\n\n\t\t\t},\n\n\t\t\tonStateTransition(from: string, to: string, action: () => void): EventController {\n\t\t\t\treturn on(\"enter\", `${from} -> ${to}`, action)\n\t\t\t},\n\n\t\t\tonStateEnter(state: string, action: () => void): EventController {\n\t\t\t\treturn on(\"enter\", state, action)\n\t\t\t},\n\n\t\t\tonStateUpdate(state: string, action: () => void): EventController {\n\t\t\t\treturn on(\"update\", state, action)\n\t\t\t},\n\n\t\t\tonStateDraw(state: string, action: () => void): EventController {\n\t\t\t\treturn on(\"draw\", state, action)\n\t\t\t},\n\n\t\t\tonStateEnd(state: string, action: () => void): EventController {\n\t\t\t\treturn on(\"end\", state, action)\n\t\t\t},\n\n\t\t\tupdate() {\n\t\t\t// execute the enter event for initState\n\t\t\t\tif (!didFirstEnter) {\n\t\t\t\t\ttrigger(\"enter\", initState)\n\t\t\t\t\tdidFirstEnter = true\n\t\t\t\t}\n\t\t\t\ttrigger(\"update\", this.state)\n\t\t\t},\n\n\t\t\tdraw() {\n\t\t\t\ttrigger(\"draw\", this.state)\n\t\t\t},\n\n\t\t\tinspect() {\n\t\t\t\treturn this.state\n\t\t\t},\n\n\t\t}\n\n\t}\n\n\tfunction fadeIn(time: number = 1): Comp {\n\t\tlet t = 0\n\t\tlet done = false\n\t\treturn {\n\t\t\trequire: [ \"opacity\" ],\n\t\t\tadd(this: GameObj<OpacityComp>) {\n\t\t\t\tthis.opacity = 0\n\t\t\t},\n\t\t\tupdate(this: GameObj<OpacityComp>) {\n\t\t\t\tif (done) return\n\t\t\t\tt += dt()\n\t\t\t\tthis.opacity = map(t, 0, time, 0, 1)\n\t\t\t\tif (t >= time) {\n\t\t\t\t\tthis.opacity = 1\n\t\t\t\t\tdone = true\n\t\t\t\t}\n\t\t\t},\n\t\t}\n\t}\n\n\tfunction onLoad(cb: () => void): void {\n\t\tif (assets.loaded) {\n\t\t\tcb()\n\t\t} else {\n\t\t\tgame.ev.on(\"load\", cb)\n\t\t}\n\t}\n\n\tfunction scene(id: SceneID, def: SceneDef) {\n\t\tgame.scenes[id] = def\n\t}\n\n\tfunction go(id: SceneID, ...args) {\n\n\t\tif (!game.scenes[id]) {\n\t\t\tthrow new Error(`Scene not found: ${id}`)\n\t\t}\n\n\t\tgame.ev.onOnce(\"frameEnd\", () => {\n\n\t\t\tgame.ev = new EventHandler()\n\t\t\tgame.objEvents = new EventHandler()\n\n\t\t\tgame.root.get().forEach((obj) => {\n\t\t\t\tif (\n\t\t\t\t\t!obj.stay\n\t\t\t\t\t|| (obj.scenesToStay && !obj.scenesToStay.includes(id))\n\t\t\t\t) {\n\t\t\t\t\tgame.root.remove(obj)\n\t\t\t\t}\n\t\t\t})\n\n\t\t\tgame.root.clearEvents()\n\n\t\t\t// cam\n\t\t\tgame.cam = {\n\t\t\t\tpos: null,\n\t\t\t\tscale: vec2(1),\n\t\t\t\tangle: 0,\n\t\t\t\tshake: 0,\n\t\t\t\ttransform: new Mat4(),\n\t\t\t}\n\n\t\t\tgame.gravity = 0\n\t\t\tgame.scenes[id](...args)\n\n\t\t\tif (gopt.debug !== false) {\n\t\t\t\tenterDebugMode()\n\t\t\t}\n\n\t\t\tif (gopt.burp) {\n\t\t\t\tenterBurpMode()\n\t\t\t}\n\n\t\t})\n\n\t}\n\n\tfunction getData<T>(key: string, def?: T): T {\n\t\ttry {\n\t\t\treturn JSON.parse(window.localStorage[key])\n\t\t} catch {\n\t\t\tif (def) {\n\t\t\t\tsetData(key, def)\n\t\t\t\treturn def\n\t\t\t} else {\n\t\t\t\treturn null\n\t\t\t}\n\t\t}\n\t}\n\n\tfunction setData(key: string, data: any) {\n\t\twindow.localStorage[key] = JSON.stringify(data)\n\t}\n\n\tfunction plug<T>(plugin: KaboomPlugin<T>): MergeObj<T> & KaboomCtx {\n\t\tconst funcs = plugin(ctx)\n\t\tfor (const k in funcs) {\n\t\t\t// @ts-ignore\n\t\t\tctx[k] = funcs[k]\n\t\t\tif (gopt.global !== false) {\n\t\t\t\t// @ts-ignore\n\t\t\t\twindow[k] = funcs[k]\n\t\t\t}\n\t\t}\n\t\treturn ctx as unknown as MergeObj<T> & KaboomCtx\n\t}\n\n\tfunction center(): Vec2 {\n\t\treturn vec2(width() / 2, height() / 2)\n\t}\n\n\tinterface GridComp extends Comp {\n\t\tgridPos: Vec2,\n\t\tsetGridPos(...args),\n\t\tmoveLeft(),\n\t\tmoveRight(),\n\t\tmoveUp(),\n\t\tmoveDown(),\n\t}\n\n\tfunction grid(level: GameObj<LevelComp>, p: Vec2): GridComp {\n\n\t\treturn {\n\n\t\t\tid: \"grid\",\n\t\t\tgridPos: p.clone(),\n\n\t\t\tsetGridPos(this: GameObj<GridComp | PosComp>, ...args) {\n\t\t\t\tconst p = vec2(...args)\n\t\t\t\tthis.gridPos = p.clone()\n\t\t\t\tthis.pos = vec2(\n\t\t\t\t\tthis.gridPos.x * level.gridWidth(),\n\t\t\t\t\tthis.gridPos.y * level.gridHeight(),\n\t\t\t\t)\n\t\t\t},\n\n\t\t\tmoveLeft() {\n\t\t\t\tthis.setGridPos(this.gridPos.add(vec2(-1, 0)))\n\t\t\t},\n\n\t\t\tmoveRight() {\n\t\t\t\tthis.setGridPos(this.gridPos.add(vec2(1, 0)))\n\t\t\t},\n\n\t\t\tmoveUp() {\n\t\t\t\tthis.setGridPos(this.gridPos.add(vec2(0, -1)))\n\t\t\t},\n\n\t\t\tmoveDown() {\n\t\t\t\tthis.setGridPos(this.gridPos.add(vec2(0, 1)))\n\t\t\t},\n\n\t\t}\n\n\t}\n\n\tfunction addLevel(map: string[], opt: LevelOpt): GameObj<PosComp | LevelComp> {\n\n\t\tif (!opt.width || !opt.height) {\n\t\t\tthrow new Error(\"Must provide level grid width & height.\")\n\t\t}\n\n\t\tconst level = add([\n\t\t\tpos(opt.pos ?? vec2(0)),\n\t\t])\n\n\t\tlet maxRowLen = 0\n\n\t\tconst levelComp: LevelComp = {\n\n\t\t\tid: \"level\",\n\n\t\t\tgridWidth() {\n\t\t\t\treturn opt.width\n\t\t\t},\n\n\t\t\tgridHeight() {\n\t\t\t\treturn opt.height\n\t\t\t},\n\n\t\t\tgetPos(...args): Vec2 {\n\t\t\t\tconst p = vec2(...args)\n\t\t\t\treturn vec2(\n\t\t\t\t\tp.x * opt.width,\n\t\t\t\t\tp.y * opt.height,\n\t\t\t\t)\n\t\t\t},\n\n\t\t\tspawn(this: GameObj<LevelComp>, key: string, ...args): GameObj {\n\n\t\t\t\tconst p = vec2(...args)\n\n\t\t\t\tconst comps = (() => {\n\t\t\t\t\tif (opt[key]) {\n\t\t\t\t\t\tif (typeof opt[key] !== \"function\") {\n\t\t\t\t\t\t\tthrow new Error(\"Level symbol def must be a function returning a component list\")\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn opt[key](p)\n\t\t\t\t\t} else if (opt.any) {\n\t\t\t\t\t\treturn opt.any(key, p)\n\t\t\t\t\t}\n\t\t\t\t})()\n\n\t\t\t\tif (!comps) {\n\t\t\t\t\treturn\n\t\t\t\t}\n\n\t\t\t\tconst posComp = vec2(\n\t\t\t\t\tp.x * opt.width,\n\t\t\t\t\tp.y * opt.height,\n\t\t\t\t)\n\n\t\t\t\tfor (const comp of comps) {\n\t\t\t\t\tif (comp.id === \"pos\") {\n\t\t\t\t\t\tposComp.x += comp.pos.x\n\t\t\t\t\t\tposComp.y += comp.pos.y\n\t\t\t\t\t\tbreak\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tcomps.push(pos(posComp))\n\t\t\t\tcomps.push(grid(this, p))\n\n\t\t\t\treturn level.add(comps)\n\n\t\t\t},\n\n\t\t\tlevelWidth() {\n\t\t\t\treturn maxRowLen * opt.width\n\t\t\t},\n\n\t\t\tlevelHeight() {\n\t\t\t\treturn map.length * opt.height\n\t\t\t},\n\n\t\t}\n\n\t\tlevel.use(levelComp)\n\n\t\tmap.forEach((row, i) => {\n\n\t\t\tconst keys = row.split(\"\")\n\n\t\t\tmaxRowLen = Math.max(keys.length, maxRowLen)\n\n\t\t\tkeys.forEach((key, j) => {\n\t\t\t\tlevel.spawn(key, vec2(j, i))\n\t\t\t})\n\n\t\t})\n\n\t\treturn level\n\n\t}\n\n\tfunction record(frameRate?): Recording {\n\n\t\tconst stream = app.canvas.captureStream(frameRate)\n\t\tconst audioDest = audio.ctx.createMediaStreamDestination()\n\n\t\taudio.masterNode.connect(audioDest)\n\n\t\t// TODO: Enabling audio results in empty video if no audio received\n\t\t// const audioStream = audioDest.stream\n\t\t// const [firstAudioTrack] = audioStream.getAudioTracks()\n\n\t\t// stream.addTrack(firstAudioTrack);\n\n\t\tconst recorder = new MediaRecorder(stream)\n\t\tconst chunks = []\n\n\t\trecorder.ondataavailable = (e) => {\n\t\t\tif (e.data.size > 0) {\n\t\t\t\tchunks.push(e.data)\n\t\t\t}\n\t\t}\n\n\t\trecorder.onerror = () => {\n\t\t\taudio.masterNode.disconnect(audioDest)\n\t\t\tstream.getTracks().forEach(t => t.stop())\n\t\t}\n\n\t\trecorder.start()\n\n\t\treturn {\n\n\t\t\tresume() {\n\t\t\t\trecorder.resume()\n\t\t\t},\n\n\t\t\tpause() {\n\t\t\t\trecorder.pause()\n\t\t\t},\n\n\t\t\tstop(): Promise<Blob> {\n\t\t\t\trecorder.stop()\n\t\t\t\t// cleanup\n\t\t\t\taudio.masterNode.disconnect(audioDest)\n\t\t\t\tstream.getTracks().forEach(t => t.stop())\n\t\t\t\treturn new Promise((resolve) => {\n\t\t\t\t\trecorder.onstop = () => {\n\t\t\t\t\t\tresolve(new Blob(chunks, {\n\t\t\t\t\t\t\ttype: \"video/mp4\",\n\t\t\t\t\t\t}))\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t},\n\n\t\t\tdownload(filename = \"kaboom.mp4\") {\n\t\t\t\tthis.stop().then((blob) => downloadBlob(filename, blob))\n\t\t\t},\n\n\t\t}\n\n\t}\n\n\tfunction isFocused(): boolean {\n\t\treturn document.activeElement === app.canvas\n\t}\n\n\tfunction destroy(obj: GameObj) {\n\t\tobj.destroy()\n\t}\n\n\t// aliases for root game obj operations\n\tconst add = game.root.add.bind(game.root)\n\tconst readd = game.root.readd.bind(game.root)\n\tconst destroyAll = game.root.removeAll.bind(game.root)\n\tconst get = game.root.get.bind(game.root)\n\tconst getAll = game.root.getAll.bind(game.root)\n\n\t// TODO: expose this\n\tfunction boom(speed: number = 2, size: number = 1): Comp {\n\t\tlet time = 0\n\t\treturn {\n\t\t\tid: \"boom\",\n\t\t\trequire: [ \"scale\" ],\n\t\t\tupdate(this: GameObj<ScaleComp>) {\n\t\t\t\tconst s = Math.sin(time * speed) * size\n\t\t\t\tif (s < 0) {\n\t\t\t\t\tthis.destroy()\n\t\t\t\t}\n\t\t\t\tthis.scale = vec2(s)\n\t\t\t\ttime += dt()\n\t\t\t},\n\t\t}\n\t}\n\n\tconst kaSprite = loadSprite(null, kaSpriteSrc)\n\tconst boomSprite = loadSprite(null, boomSpriteSrc)\n\n\tfunction addKaboom(p: Vec2, opt: BoomOpt = {}): GameObj {\n\n\t\tconst kaboom = add([\n\t\t\tpos(p),\n\t\t\tstay(),\n\t\t])\n\n\t\tconst speed = (opt.speed || 1) * 5\n\t\tconst s = opt.scale || 1\n\n\t\tkaboom.add([\n\t\t\tsprite(boomSprite),\n\t\t\tscale(0),\n\t\t\tanchor(\"center\"),\n\t\t\tboom(speed, s),\n\t\t\t...opt.comps ?? [],\n\t\t])\n\n\t\tconst ka = kaboom.add([\n\t\t\tsprite(kaSprite),\n\t\t\tscale(0),\n\t\t\tanchor(\"center\"),\n\t\t\ttimer(0.4 / speed, () => ka.use(boom(speed, s))),\n\t\t\t...opt.comps ?? [],\n\t\t])\n\n\t\tka.onDestroy(() => kaboom.destroy())\n\n\t\treturn kaboom\n\n\t}\n\n\tfunction updateFrame() {\n\n\t\t// update every obj\n\t\tgame.root.update()\n\n\t}\n\n\tconst DEF_HASH_GRID_SIZE = 64\n\n\tclass Collision {\n\t\tsource: GameObj\n\t\ttarget: GameObj\n\t\tdisplacement: Vec2\n\t\tresolved: boolean = false\n\t\tconstructor(source: GameObj, target: GameObj, dis: Vec2, resolved = false) {\n\t\t\tthis.source = source\n\t\t\tthis.target = target\n\t\t\tthis.displacement = dis\n\t\t\tthis.resolved = resolved\n\t\t}\n\t\treverse() {\n\t\t\treturn new Collision(\n\t\t\t\tthis.target,\n\t\t\t\tthis.source,\n\t\t\t\tthis.displacement.scale(-1),\n\t\t\t\tthis.resolved,\n\t\t\t)\n\t\t}\n\t\tisLeft() {\n\t\t\treturn this.displacement.x > 0\n\t\t}\n\t\tisRight() {\n\t\t\treturn this.displacement.x < 0\n\t\t}\n\t\tisTop() {\n\t\t\treturn this.displacement.y > 0\n\t\t}\n\t\tisBottom() {\n\t\t\treturn this.displacement.y < 0\n\t\t}\n\t\tpreventResolve() {\n\t\t\tthis.resolved = true\n\t\t}\n\t}\n\n\tfunction checkFrame() {\n\n\t\t// TODO: persistent grid?\n\t\t// start a spatial hash grid for more efficient collision detection\n\t\tconst grid: Record<number, Record<number, GameObj<AreaComp>[]>> = {}\n\t\tconst cellSize = gopt.hashGridSize || DEF_HASH_GRID_SIZE\n\n\t\t// current transform\n\t\tlet tr = new Mat4()\n\n\t\t// a local transform stack\n\t\tconst stack = []\n\n\t\tfunction checkObj(obj: GameObj) {\n\n\t\t\tstack.push(tr)\n\n\t\t\t// Update object transform here. This will be the transform later used in rendering.\n\t\t\tif (obj.pos) tr = tr.translate(obj.pos)\n\t\t\tif (obj.scale) tr = tr.scale(obj.scale)\n\t\t\tif (obj.angle) tr = tr.rotateZ(obj.angle)\n\t\t\tobj.transform = tr.clone()\n\n\t\t\tif (obj.c(\"area\") && !obj.paused) {\n\n\t\t\t\t// TODO: only update worldArea if transform changed\n\t\t\t\tconst aobj = obj as GameObj<AreaComp>\n\t\t\t\tconst area = aobj.worldArea()\n\t\t\t\tconst bbox = area.bbox()\n\n\t\t\t\t// Get spatial hash grid coverage\n\t\t\t\tconst xmin = Math.floor(bbox.pos.x / cellSize)\n\t\t\t\tconst ymin = Math.floor(bbox.pos.y / cellSize)\n\t\t\t\tconst xmax = Math.ceil((bbox.pos.x + bbox.width) / cellSize)\n\t\t\t\tconst ymax = Math.ceil((bbox.pos.y + bbox.height) / cellSize)\n\n\t\t\t\t// Cache objs that are already checked\n\t\t\t\tconst checked = new Set()\n\n\t\t\t\t// insert & check against all covered grids\n\t\t\t\tfor (let x = xmin; x <= xmax; x++) {\n\t\t\t\t\tfor (let y = ymin; y <= ymax; y++) {\n\t\t\t\t\t\tif(!grid[x]) {\n\t\t\t\t\t\t\tgrid[x] = {}\n\t\t\t\t\t\t\tgrid[x][y] = [aobj]\n\t\t\t\t\t\t} else if(!grid[x][y]) {\n\t\t\t\t\t\t\tgrid[x][y] = [aobj]\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tconst cell = grid[x][y]\n\t\t\t\t\t\t\tfor (const other of cell) {\n\t\t\t\t\t\t\t\tif (!other.exists()) {\n\t\t\t\t\t\t\t\t\tcontinue\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tif (checked.has(other.id)) {\n\t\t\t\t\t\t\t\t\tcontinue\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t// TODO: is this too slow\n\t\t\t\t\t\t\t\tfor (const tag of aobj.collisionIgnore) {\n\t\t\t\t\t\t\t\t\tif (other.is(tag)) {\n\t\t\t\t\t\t\t\t\t\tcontinue\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tfor (const tag of other.collisionIgnore) {\n\t\t\t\t\t\t\t\t\tif (aobj.is(tag)) {\n\t\t\t\t\t\t\t\t\t\tcontinue\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tconst res = aobj.checkCollision(other)\n\t\t\t\t\t\t\t\tif (res && !res.isZero()) {\n\t\t\t\t\t\t\t\t\t// TODO: rehash if the object position is changed after resolution?\n\t\t\t\t\t\t\t\t\tconst col1 = new Collision(aobj, other, res)\n\t\t\t\t\t\t\t\t\taobj.trigger(\"collideUpdate\", other, col1)\n\t\t\t\t\t\t\t\t\tconst col2 = col1.reverse()\n\t\t\t\t\t\t\t\t\t// resolution only has to happen once\n\t\t\t\t\t\t\t\t\tcol2.resolved = col1.resolved\n\t\t\t\t\t\t\t\t\tother.trigger(\"collideUpdate\", aobj, col2)\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tchecked.add(other.id)\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tcell.push(aobj)\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\tobj.get().forEach(checkObj)\n\t\t\ttr = stack.pop()\n\n\t\t}\n\n\t\tcheckObj(game.root)\n\n\t}\n\n\tfunction drawFrame() {\n\n\t\t// calculate camera matrix\n\t\tconst cam = game.cam\n\t\tconst shake = Vec2.fromAngle(rand(0, 360)).scale(cam.shake)\n\n\t\tcam.shake = lerp(cam.shake, 0, 5 * dt())\n\t\tcam.transform = new Mat4()\n\t\t\t.translate(center())\n\t\t\t.scale(cam.scale)\n\t\t\t.rotateZ(cam.angle)\n\t\t\t.translate((cam.pos ?? center()).scale(-1).add(shake))\n\n\t\tgame.root.draw()\n\t\tflush()\n\n\t}\n\n\tfunction drawLoadScreen() {\n\n\t\tconst progress = loadProgress()\n\n\t\tdrawUnscaled(() => {\n\n\t\t\tconst w = width() / 2\n\t\t\tconst h = 24\n\t\t\tconst pos = vec2(width() / 2, height() / 2).sub(vec2(w / 2, h / 2))\n\n\t\t\tdrawRect({\n\t\t\t\tpos: vec2(0),\n\t\t\t\twidth: width(),\n\t\t\t\theight: height(),\n\t\t\t\tcolor: rgb(0, 0, 0),\n\t\t\t})\n\n\t\t\tdrawRect({\n\t\t\t\tpos: pos,\n\t\t\t\twidth: w,\n\t\t\t\theight: h,\n\t\t\t\tfill: false,\n\t\t\t\toutline: {\n\t\t\t\t\twidth: 4,\n\t\t\t\t},\n\t\t\t})\n\n\t\t\tdrawRect({\n\t\t\t\tpos: pos,\n\t\t\t\twidth: w * progress,\n\t\t\t\theight: h,\n\t\t\t})\n\n\t\t})\n\n\t\tgame.ev.trigger(\"loading\", progress)\n\n\t}\n\n\tfunction drawInspectText(pos, txt) {\n\n\t\tdrawUnscaled(() => {\n\n\t\t\tconst pad = vec2(8)\n\n\t\t\tpushTransform()\n\t\t\tpushTranslate(pos)\n\n\t\t\tconst ftxt = formatText({\n\t\t\t\ttext: txt,\n\t\t\t\tfont: DBG_FONT,\n\t\t\t\tsize: 16,\n\t\t\t\tpos: pad,\n\t\t\t\tcolor: rgb(255, 255, 255),\n\t\t\t\tfixed: true,\n\t\t\t})\n\n\t\t\tconst bw = ftxt.width + pad.x * 2\n\t\t\tconst bh = ftxt.height + pad.x * 2\n\n\t\t\tif (pos.x + bw >= width()) {\n\t\t\t\tpushTranslate(vec2(-bw, 0))\n\t\t\t}\n\n\t\t\tif (pos.y + bh >= height()) {\n\t\t\t\tpushTranslate(vec2(0, -bh))\n\t\t\t}\n\n\t\t\tdrawRect({\n\t\t\t\twidth: bw,\n\t\t\t\theight: bh,\n\t\t\t\tcolor: rgb(0, 0, 0),\n\t\t\t\tradius: 4,\n\t\t\t\topacity: 0.8,\n\t\t\t\tfixed: true,\n\t\t\t})\n\n\t\t\tdrawFormattedText(ftxt)\n\t\t\tpopTransform()\n\n\t\t})\n\n\t}\n\n\tfunction drawDebug() {\n\n\t\tif (debug.inspect) {\n\n\t\t\tlet inspecting = null\n\n\t\t\tfor (const obj of getAll()) {\n\t\t\t\tif (obj.c(\"area\") && obj.isHovering()) {\n\t\t\t\t\tinspecting = obj\n\t\t\t\t\tbreak\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tgame.root.drawInspect()\n\n\t\t\tif (inspecting) {\n\n\t\t\t\tconst lines = []\n\t\t\t\tconst data = inspecting.inspect()\n\n\t\t\t\tfor (const tag in data) {\n\t\t\t\t\tif (data[tag]) {\n\t\t\t\t\t\tlines.push(`${tag}: ${data[tag]}`)\n\t\t\t\t\t} else {\n\t\t\t\t\t\tlines.push(`${tag}`)\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tdrawInspectText(contentToView(mousePos()), lines.join(\"\\n\"))\n\n\t\t\t}\n\n\t\t\tdrawInspectText(vec2(8), `FPS: ${debug.fps()}`)\n\n\t\t}\n\n\t\tif (debug.paused) {\n\n\t\t\tdrawUnscaled(() => {\n\n\t\t\t\t// top right corner\n\t\t\t\tpushTransform()\n\t\t\t\tpushTranslate(width(), 0)\n\t\t\t\tpushTranslate(-8, 8)\n\n\t\t\t\tconst size = 32\n\n\t\t\t\t// bg\n\t\t\t\tdrawRect({\n\t\t\t\t\twidth: size,\n\t\t\t\t\theight: size,\n\t\t\t\t\tanchor: \"topright\",\n\t\t\t\t\tcolor: rgb(0, 0, 0),\n\t\t\t\t\topacity: 0.8,\n\t\t\t\t\tradius: 4,\n\t\t\t\t\tfixed: true,\n\t\t\t\t})\n\n\t\t\t\t// pause icon\n\t\t\t\tfor (let i = 1; i <= 2; i++) {\n\t\t\t\t\tdrawRect({\n\t\t\t\t\t\twidth: 4,\n\t\t\t\t\t\theight: size * 0.6,\n\t\t\t\t\t\tanchor: \"center\",\n\t\t\t\t\t\tpos: vec2(-size / 3 * i, size * 0.5),\n\t\t\t\t\t\tcolor: rgb(255, 255, 255),\n\t\t\t\t\t\tradius: 2,\n\t\t\t\t\t\tfixed: true,\n\t\t\t\t\t})\n\t\t\t\t}\n\n\t\t\t\tpopTransform()\n\n\t\t\t})\n\n\t\t}\n\n\t\tif (debug.timeScale !== 1) {\n\n\t\t\tdrawUnscaled(() => {\n\n\t\t\t\t// bottom right corner\n\t\t\t\tpushTransform()\n\t\t\t\tpushTranslate(width(), height())\n\t\t\t\tpushTranslate(-8, -8)\n\n\t\t\t\tconst pad = 8\n\n\t\t\t\t// format text first to get text size\n\t\t\t\tconst ftxt = formatText({\n\t\t\t\t\ttext: debug.timeScale.toFixed(1),\n\t\t\t\t\tfont: DBG_FONT,\n\t\t\t\t\tsize: 16,\n\t\t\t\t\tcolor: rgb(255, 255, 255),\n\t\t\t\t\tpos: vec2(-pad),\n\t\t\t\t\tanchor: \"botright\",\n\t\t\t\t\tfixed: true,\n\t\t\t\t})\n\n\t\t\t\t// bg\n\t\t\t\tdrawRect({\n\t\t\t\t\twidth: ftxt.width + pad * 2 + pad * 4,\n\t\t\t\t\theight: ftxt.height + pad * 2,\n\t\t\t\t\tanchor: \"botright\",\n\t\t\t\t\tcolor: rgb(0, 0, 0),\n\t\t\t\t\topacity: 0.8,\n\t\t\t\t\tradius: 4,\n\t\t\t\t\tfixed: true,\n\t\t\t\t})\n\n\t\t\t\t// fast forward / slow down icon\n\t\t\t\tfor (let i = 0; i < 2; i++) {\n\t\t\t\t\tconst flipped = debug.timeScale < 1\n\t\t\t\t\tdrawTriangle({\n\t\t\t\t\t\tp1: vec2(-ftxt.width - pad * (flipped ? 2 : 3.5), -pad),\n\t\t\t\t\t\tp2: vec2(-ftxt.width - pad * (flipped ? 2 : 3.5), -pad - ftxt.height),\n\t\t\t\t\t\tp3: vec2(-ftxt.width - pad * (flipped ? 3.5 : 2), -pad - ftxt.height / 2),\n\t\t\t\t\t\tpos: vec2(-i * pad * 1 + (flipped ? -pad * 0.5 : 0), 0),\n\t\t\t\t\t\tcolor: rgb(255, 255, 255),\n\t\t\t\t\t\tfixed: true,\n\t\t\t\t\t})\n\t\t\t\t}\n\n\t\t\t\t// text\n\t\t\t\tdrawFormattedText(ftxt)\n\n\t\t\t\tpopTransform()\n\n\t\t\t})\n\n\t\t}\n\n\t\tif (debug.curRecording) {\n\n\t\t\tdrawUnscaled(() => {\n\n\t\t\t\tpushTransform()\n\t\t\t\tpushTranslate(0, height())\n\t\t\t\tpushTranslate(24, -24)\n\n\t\t\t\tdrawCircle({\n\t\t\t\t\tradius: 12,\n\t\t\t\t\tcolor: rgb(255, 0, 0),\n\t\t\t\t\topacity: wave(0, 1, time() * 4),\n\t\t\t\t\tfixed: true,\n\t\t\t\t})\n\n\t\t\t\tpopTransform()\n\n\t\t\t})\n\n\t\t}\n\n\t\tif (debug.showLog && game.logs.length > 0) {\n\n\t\t\tdrawUnscaled(() => {\n\n\t\t\t\tpushTransform()\n\t\t\t\tpushTranslate(0, height())\n\t\t\t\tpushTranslate(8, -8)\n\n\t\t\t\tconst pad = 8\n\n\t\t\t\tconst ftext = formatText({\n\t\t\t\t\ttext: game.logs.join(\"\\n\"),\n\t\t\t\t\tfont: DBG_FONT,\n\t\t\t\t\tpos: vec2(pad, -pad),\n\t\t\t\t\tanchor: \"botleft\",\n\t\t\t\t\tsize: 16,\n\t\t\t\t\twidth: width() * 0.6,\n\t\t\t\t\tlineSpacing: pad / 2,\n\t\t\t\t\tfixed: true,\n\t\t\t\t\tstyles: {\n\t\t\t\t\t\t\"time\": { color: rgb(127, 127, 127) },\n\t\t\t\t\t\t\"info\": { color: rgb(255, 255, 255) },\n\t\t\t\t\t\t\"error\": { color: rgb(255, 0, 127) },\n\t\t\t\t\t},\n\t\t\t\t})\n\n\t\t\t\tdrawRect({\n\t\t\t\t\twidth: ftext.width + pad * 2,\n\t\t\t\t\theight: ftext.height + pad * 2,\n\t\t\t\t\tanchor: \"botleft\",\n\t\t\t\t\tcolor: rgb(0, 0, 0),\n\t\t\t\t\tradius: 4,\n\t\t\t\t\topacity: 0.8,\n\t\t\t\t\tfixed: true,\n\t\t\t\t})\n\n\t\t\t\tdrawFormattedText(ftext)\n\t\t\t\tpopTransform()\n\n\t\t\t})\n\n\t\t}\n\n\t}\n\n\tfunction drawVirtualControls() {\n\n\t\t// TODO: mousePos incorrect in \"stretch\" mode\n\t\tconst mpos = mousePos()\n\n\t\tconst drawCircleButton = (pos: Vec2, btn: VirtualButton, text?: string) => {\n\n\t\t\tconst size = 80\n\n\t\t\tdrawCircle({\n\t\t\t\tradius: size / 2,\n\t\t\t\tpos: pos,\n\t\t\t\toutline: { width: 4, color: rgb(0, 0, 0) },\n\t\t\t\topacity: 0.5,\n\t\t\t})\n\n\t\t\tif (text) {\n\t\t\t\tdrawText({\n\t\t\t\t\ttext: text,\n\t\t\t\t\tpos: pos,\n\t\t\t\t\tcolor: rgb(0, 0, 0),\n\t\t\t\t\tsize: 40,\n\t\t\t\t\tanchor: \"center\",\n\t\t\t\t\topacity: 0.5,\n\t\t\t\t})\n\t\t\t}\n\n\t\t\t// TODO: touch\n\t\t\tif (isMousePressed(\"left\")) {\n\t\t\t\tif (testCirclePoint(new Circle(pos, size / 2), mpos)) {\n\t\t\t\t\tgame.ev.onOnce(\"frameEnd\", () => {\n\t\t\t\t\t\tapp.virtualButtonStates[btn] = \"pressed\"\n\t\t\t\t\t\t// TODO: caller specify another value as connected key?\n\t\t\t\t\t\tapp.keyStates[btn] = \"pressed\"\n\t\t\t\t\t})\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (isMouseReleased(\"left\")) {\n\t\t\t\tgame.ev.onOnce(\"frameEnd\", () => {\n\t\t\t\t\tapp.virtualButtonStates[btn] = \"released\"\n\t\t\t\t\tapp.keyStates[btn] = \"released\"\n\t\t\t\t})\n\t\t\t}\n\n\t\t}\n\n\t\tconst drawSquareButton = (pos: Vec2, btn: VirtualButton, text?: string) => {\n\n\t\t\t// TODO: mousePos incorrect in \"stretch\" mode\n\t\t\tconst size = 64\n\n\t\t\tdrawRect({\n\t\t\t\twidth: size,\n\t\t\t\theight: size,\n\t\t\t\tpos: pos,\n\t\t\t\toutline: { width: 4, color: rgb(0, 0, 0) },\n\t\t\t\tradius: 4,\n\t\t\t\tanchor: \"center\",\n\t\t\t\topacity: 0.5,\n\t\t\t})\n\n\t\t\tif (text) {\n\t\t\t\tdrawText({\n\t\t\t\t\ttext: text,\n\t\t\t\t\tpos: pos,\n\t\t\t\t\tcolor: rgb(0, 0, 0),\n\t\t\t\t\tsize: 40,\n\t\t\t\t\tanchor: \"center\",\n\t\t\t\t\topacity: 0.5,\n\t\t\t\t})\n\t\t\t}\n\n\t\t\t// TODO: touch\n\t\t\tif (isMousePressed(\"left\")) {\n\t\t\t\tif (testRectPoint(new Rect(pos.add(-size / 2, -size / 2), size, size), mpos)) {\n\t\t\t\t\tgame.ev.onOnce(\"frameEnd\", () => {\n\t\t\t\t\t\tapp.virtualButtonStates[btn] = \"pressed\"\n\t\t\t\t\t\tapp.keyStates[btn] = \"pressed\"\n\t\t\t\t\t})\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (isMouseReleased(\"left\")) {\n\t\t\t\tgame.ev.onOnce(\"frameEnd\", () => {\n\t\t\t\t\tapp.virtualButtonStates[btn] = \"released\"\n\t\t\t\t\tapp.keyStates[btn] = \"released\"\n\t\t\t\t})\n\t\t\t}\n\n\t\t}\n\n\t\tdrawUnscaled(() => {\n\t\t\tdrawCircleButton(vec2(width() - 80, height() - 160), \"a\")\n\t\t\tdrawCircleButton(vec2(width() - 160, height() - 80), \"b\")\n\t\t\tdrawSquareButton(vec2(60, height() - 124), \"left\")\n\t\t\tdrawSquareButton(vec2(188, height() - 124), \"right\")\n\t\t\tdrawSquareButton(vec2(124, height() - 188), \"up\")\n\t\t\tdrawSquareButton(vec2(124, height() - 60), \"down\")\n\t\t})\n\n\t}\n\n\tif (gopt.debug !== false) {\n\t\tenterDebugMode()\n\t}\n\n\tif (gopt.burp) {\n\t\tenterBurpMode()\n\t}\n\n\tfunction onLoadUpdate(action: (err: Error) => void) {\n\t\tgame.ev.on(\"loading\", action)\n\t}\n\n\tfunction onResize(action: (\n\t\tprevWidth: number,\n\t\tprevHeight: number,\n\t\tcurWidth: number,\n\t\tcurHeight: number,\n\t) => void) {\n\t\tgame.ev.on(\"resize\", action)\n\t}\n\n\tfunction onError(action: (err: Error) => void) {\n\t\tgame.ev.on(\"error\", action)\n\t}\n\n\tfunction handleErr(err: Error) {\n\n\t\t// TODO: this should only run once\n\t\trun(() => {\n\n\t\t\tdrawUnscaled(() => {\n\n\t\t\t\tconst pad = 32\n\t\t\t\tconst gap = 16\n\t\t\t\tconst gw = width()\n\t\t\t\tconst gh = height()\n\n\t\t\t\tconst textStyle = {\n\t\t\t\t\tsize: 36,\n\t\t\t\t\twidth: gw - pad * 2,\n\t\t\t\t\tletterSpacing: 4,\n\t\t\t\t\tlineSpacing: 4,\n\t\t\t\t\tfont: DBG_FONT,\n\t\t\t\t\tfixed: true,\n\t\t\t\t}\n\n\t\t\t\tdrawRect({\n\t\t\t\t\twidth: gw,\n\t\t\t\t\theight: gh,\n\t\t\t\t\tcolor: rgb(0, 0, 255),\n\t\t\t\t\tfixed: true,\n\t\t\t\t})\n\n\t\t\t\tconst title = formatText({\n\t\t\t\t\t...textStyle,\n\t\t\t\t\ttext: err.name,\n\t\t\t\t\tpos: vec2(pad),\n\t\t\t\t\tcolor: rgb(255, 128, 0),\n\t\t\t\t\tfixed: true,\n\t\t\t\t})\n\n\t\t\t\tdrawFormattedText(title)\n\n\t\t\t\tdrawText({\n\t\t\t\t\t...textStyle,\n\t\t\t\t\ttext: err.message,\n\t\t\t\t\tpos: vec2(pad, pad + title.height + gap),\n\t\t\t\t\tfixed: true,\n\t\t\t\t})\n\n\t\t\t\tpopTransform()\n\t\t\t\tgame.ev.trigger(\"error\", err)\n\n\t\t\t})\n\n\t\t})\n\n\t}\n\n\tfunction resetInputState() {\n\n\t\tfor (const k in app.keyStates) {\n\t\t\tapp.keyStates[k] = processButtonState(app.keyStates[k])\n\t\t}\n\n\t\tfor (const m in app.mouseStates) {\n\t\t\tapp.mouseStates[m] = processButtonState(app.mouseStates[m])\n\t\t}\n\n\t\tfor (const b in app.virtualButtonStates) {\n\t\t\tapp.virtualButtonStates[b] = processButtonState(app.virtualButtonStates[b])\n\t\t}\n\n\t\tapp.charInputted = []\n\t\tapp.isMouseMoved = false\n\t\tapp.isKeyPressed = false\n\t\tapp.isKeyPressedRepeat = false\n\t\tapp.isKeyReleased = false\n\n\t}\n\n\tfunction run(f: () => void) {\n\n\t\tif (app.loopID !== null) {\n\t\t\tcancelAnimationFrame(app.loopID)\n\t\t}\n\n\t\tconst frame = (t: number) => {\n\n\t\t\tif (app.stopped) return\n\n\t\t\tif (document.visibilityState !== \"visible\") {\n\t\t\t\tapp.loopID = requestAnimationFrame(frame)\n\t\t\t\treturn\n\t\t\t}\n\n\t\t\tconst realTime = t / 1000\n\t\t\tconst realDt = realTime - app.realTime\n\n\t\t\tapp.realTime = realTime\n\n\t\t\tif (!app.skipTime) {\n\t\t\t\tapp.dt = realDt\n\t\t\t\tapp.time += dt()\n\t\t\t\tapp.fpsCounter.tick(app.dt)\n\t\t\t}\n\n\t\t\tapp.skipTime = false\n\t\t\tapp.numFrames++\n\n\t\t\tframeStart()\n\t\t\tf()\n\t\t\tframeEnd()\n\n\t\t\tresetInputState()\n\t\t\tgame.ev.trigger(\"frameEnd\")\n\t\t\tapp.loopID = requestAnimationFrame(frame)\n\n\t\t}\n\n\t\tframe(0)\n\n\t}\n\n\tfunction quit() {\n\n\t\tgame.ev.onOnce(\"frameEnd\", () => {\n\n\t\t\t// stop the loop\n\t\t\tapp.stopped = true\n\n\t\t\t// clear canvas\n\t\t\tgl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT | gl.STENCIL_BUFFER_BIT)\n\n\t\t\t// unbind everything\n\t\t\tconst numTextureUnits = gl.getParameter(gl.MAX_TEXTURE_IMAGE_UNITS)\n\n\t\t\tfor (let unit = 0; unit < numTextureUnits; unit++) {\n\t\t\t\tgl.activeTexture(gl.TEXTURE0 + unit)\n\t\t\t\tgl.bindTexture(gl.TEXTURE_2D, null)\n\t\t\t\tgl.bindTexture(gl.TEXTURE_CUBE_MAP, null)\n\t\t\t}\n\n\t\t\tgl.bindBuffer(gl.ARRAY_BUFFER, null)\n\t\t\tgl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, null)\n\t\t\tgl.bindRenderbuffer(gl.RENDERBUFFER, null)\n\t\t\tgl.bindFramebuffer(gl.FRAMEBUFFER, null)\n\n\t\t\t// run all scattered gc events\n\t\t\tgc.forEach((f) => f())\n\n\t\t\t// delete webgl buffers\n\t\t\tgl.deleteBuffer(gfx.vbuf)\n\t\t\tgl.deleteBuffer(gfx.ibuf)\n\n\t\t\t// unregister events\n\t\t\tfor (const name in canvasEvents) {\n\t\t\t\tapp.canvas.removeEventListener(name, canvasEvents[name])\n\t\t\t}\n\n\t\t\tfor (const name in docEvents) {\n\t\t\t\tdocument.removeEventListener(name, docEvents[name])\n\t\t\t}\n\n\t\t\tfor (const name in winEvents) {\n\t\t\t\twindow.removeEventListener(name, winEvents[name])\n\t\t\t}\n\n\t\t})\n\n\t}\n\n\t// TODO: tween vec2\n\tfunction tween(\n\t\tmin: number,\n\t\tmax: number,\n\t\tduration: number,\n\t\tsetValue: (value: number) => void,\n\t\teaseFunc = easings.linear,\n\t): TweenController {\n\t\tlet curTime = 0\n\t\tconst onFinishEvents: Array<() => void> = []\n\t\tconst ev = onUpdate(() => {\n\t\t\tcurTime += dt()\n\t\t\tconst t = Math.min(curTime / duration, 1)\n\t\t\tsetValue(lerp(min, max, easeFunc(t)))\n\t\t\tif (t === 1) {\n\t\t\t\tev.cancel()\n\t\t\t\tsetValue(max)\n\t\t\t\tonFinishEvents.forEach((action) => action())\n\t\t\t}\n\t\t})\n\t\treturn {\n\t\t\tget paused() {\n\t\t\t\treturn ev.paused\n\t\t\t},\n\t\t\tset paused(p) {\n\t\t\t\tev.paused = p\n\t\t\t},\n\t\t\tonFinish(action: () => void) {\n\t\t\t\tonFinishEvents.push(action)\n\t\t\t},\n\t\t\tthen(action: () => void) {\n\t\t\t\tthis.onFinish(action)\n\t\t\t\treturn this\n\t\t\t},\n\t\t\tcancel() {\n\t\t\t\tev.cancel()\n\t\t\t},\n\t\t\tfinish() {\n\t\t\t\tev.cancel()\n\t\t\t\tsetValue(max)\n\t\t\t\tonFinishEvents.forEach((action) => action())\n\t\t\t},\n\t\t}\n\t}\n\n\tloadBitmapFont(\n\t\t\"happy\",\n\t\thappyFontSrc,\n\t\t28,\n\t\t36,\n\t)\n\n\t// main game loop\n\trun(() => {\n\n\t\tif (!assets.loaded) {\n\t\t\tif (loadProgress() === 1) {\n\t\t\t\tassets.loaded = true\n\t\t\t\tgame.ev.trigger(\"load\")\n\t\t\t}\n\t\t}\n\n\t\tif (!assets.loaded && gopt.loadingScreen !== false) {\n\n\t\t\t// TODO: Currently if assets are not initially loaded no updates or timers will be run, however they will run if loadingScreen is set to false. What's the desired behavior or should we make them consistent?\n\t\t\tdrawLoadScreen()\n\n\t\t} else {\n\n\t\t\tgame.ev.trigger(\"input\")\n\n\t\t\tif (!debug.paused) {\n\t\t\t\tupdateFrame()\n\t\t\t}\n\n\t\t\tcheckFrame()\n\t\t\tdrawFrame()\n\n\t\t\tif (gopt.debug !== false) {\n\t\t\t\tdrawDebug()\n\t\t\t}\n\n\t\t\tif (gopt.virtualControls && isTouchScreen()) {\n\t\t\t\tdrawVirtualControls()\n\t\t\t}\n\n\t\t}\n\n\t})\n\n\t// the exported ctx handle\n\tconst ctx: KaboomCtx = {\n\t\tVERSION,\n\t\t// asset load\n\t\tloadRoot,\n\t\tloadProgress,\n\t\tloadSprite,\n\t\tloadSpriteAtlas,\n\t\tloadSound,\n\t\tloadBitmapFont,\n\t\tloadFont,\n\t\tloadShader,\n\t\tloadAseprite,\n\t\tloadPedit,\n\t\tloadBean,\n\t\tload,\n\t\tgetSprite,\n\t\tgetSound,\n\t\tgetFont,\n\t\tgetBitmapFont,\n\t\tgetShader,\n\t\tAsset,\n\t\tSpriteData,\n\t\tSoundData,\n\t\t// query\n\t\twidth,\n\t\theight,\n\t\tcenter,\n\t\tdt,\n\t\ttime,\n\t\tscreenshot,\n\t\trecord,\n\t\tisFocused,\n\t\tsetCursor,\n\t\tsetFullscreen,\n\t\tisFullscreen,\n\t\tisTouchScreen,\n\t\tonLoad,\n\t\tonLoadUpdate,\n\t\tonResize,\n\t\tonError,\n\t\t// misc\n\t\tcamPos,\n\t\tcamScale,\n\t\tcamRot,\n\t\tshake,\n\t\ttoScreen,\n\t\ttoWorld,\n\t\tgravity,\n\t\t// obj\n\t\tadd,\n\t\tdestroy,\n\t\tdestroyAll,\n\t\tget,\n\t\tgetAll,\n\t\treadd,\n\t\t// comps\n\t\tpos,\n\t\tscale,\n\t\trotate,\n\t\tcolor,\n\t\topacity,\n\t\tanchor,\n\t\tarea,\n\t\tsprite,\n\t\ttext,\n\t\trect,\n\t\tcircle,\n\t\tuvquad,\n\t\toutline,\n\t\tbody,\n\t\tdoubleJump,\n\t\tshader,\n\t\ttimer,\n\t\tfixed,\n\t\tstay,\n\t\thealth,\n\t\tlifespan,\n\t\tz,\n\t\tmove,\n\t\toffscreen,\n\t\tfollow,\n\t\tstate,\n\t\tfadeIn,\n\t\t// group events\n\t\ton,\n\t\tonUpdate,\n\t\tonDraw,\n\t\tonAdd,\n\t\tonDestroy,\n\t\tonCollide,\n\t\tonClick,\n\t\tonHover,\n\t\tonHoverUpdate,\n\t\tonHoverEnd,\n\t\t// input\n\t\tonKeyDown,\n\t\tonKeyPress,\n\t\tonKeyPressRepeat,\n\t\tonKeyRelease,\n\t\tonMouseDown,\n\t\tonMousePress,\n\t\tonMouseRelease,\n\t\tonMouseMove,\n\t\tonCharInput,\n\t\tonTouchStart,\n\t\tonTouchMove,\n\t\tonTouchEnd,\n\t\tonVirtualButtonPress,\n\t\tonVirtualButtonDown,\n\t\tonVirtualButtonRelease,\n\t\tmousePos,\n\t\tmouseDeltaPos,\n\t\tisKeyDown,\n\t\tisKeyPressed,\n\t\tisKeyPressedRepeat,\n\t\tisKeyReleased,\n\t\tisMouseDown,\n\t\tisMousePressed,\n\t\tisMouseReleased,\n\t\tisMouseMoved,\n\t\tisVirtualButtonPressed,\n\t\tisVirtualButtonDown,\n\t\tisVirtualButtonReleased,\n\t\t// timer\n\t\tloop,\n\t\twait,\n\t\t// audio\n\t\tplay,\n\t\tvolume,\n\t\tburp,\n\t\taudioCtx: audio.ctx,\n\t\t// math\n\t\tTimer,\n\t\tLine,\n\t\tRect,\n\t\tCircle,\n\t\tPolygon,\n\t\tVec2,\n\t\tColor,\n\t\tMat4,\n\t\tQuad,\n\t\tRNG,\n\t\trand,\n\t\trandi,\n\t\trandSeed,\n\t\tvec2,\n\t\trgb,\n\t\thsl2rgb,\n\t\tquad,\n\t\tchoose,\n\t\tchance,\n\t\tlerp,\n\t\ttween,\n\t\teasings,\n\t\tmap,\n\t\tmapc,\n\t\twave,\n\t\tdeg2rad,\n\t\trad2deg,\n\t\ttestLineLine,\n\t\ttestRectRect,\n\t\ttestRectLine,\n\t\ttestRectPoint,\n\t\t// raw draw\n\t\tdrawSprite,\n\t\tdrawText,\n\t\tformatText,\n\t\tdrawRect,\n\t\tdrawLine,\n\t\tdrawLines,\n\t\tdrawTriangle,\n\t\tdrawCircle,\n\t\tdrawEllipse,\n\t\tdrawUVQuad,\n\t\tdrawPolygon,\n\t\tdrawFormattedText,\n\t\tdrawMasked,\n\t\tdrawSubtracted,\n\t\tpushTransform,\n\t\tpopTransform,\n\t\tpushTranslate,\n\t\tpushScale,\n\t\tpushRotate,\n\t\tpushRotateX,\n\t\tpushRotateY,\n\t\tpushRotateZ,\n\t\tpushMatrix,\n\t\t// debug\n\t\tdebug,\n\t\t// scene\n\t\tscene,\n\t\tgo,\n\t\t// level\n\t\taddLevel,\n\t\t// storage\n\t\tgetData,\n\t\tsetData,\n\t\tdownload,\n\t\tdownloadJSON,\n\t\tdownloadText,\n\t\tdownloadBlob,\n\t\t// plugin\n\t\tplug,\n\t\t// char sets\n\t\tASCII_CHARS,\n\t\t// dom\n\t\tcanvas: app.canvas,\n\t\t// misc\n\t\taddKaboom,\n\t\t// dirs\n\t\tLEFT: Vec2.LEFT,\n\t\tRIGHT: Vec2.RIGHT,\n\t\tUP: Vec2.UP,\n\t\tDOWN: Vec2.DOWN,\n\t\t// colors\n\t\tRED: Color.RED,\n\t\tGREEN: Color.GREEN,\n\t\tBLUE: Color.BLUE,\n\t\tYELLOW: Color.YELLOW,\n\t\tMAGENTA: Color.MAGENTA,\n\t\tCYAN: Color.CYAN,\n\t\tWHITE: Color.WHITE,\n\t\tBLACK: Color.BLACK,\n\t\tquit,\n\t\t// helpers\n\t\tEvent,\n\t\tEventHandler,\n\t}\n\n\tif (gopt.plugins) {\n\t\tgopt.plugins.forEach(plug)\n\t}\n\n\t// export everything to window if global is set\n\tif (gopt.global !== false) {\n\t\tfor (const k in ctx) {\n\t\t\twindow[k] = ctx[k]\n\t\t}\n\t}\n\n\tapp.canvas.focus()\n\n\treturn ctx\n\n}\n", "import {\n\tVec4,\n\tPoint,\n\tRNGValue,\n} from \"./types\"\n\nexport function deg2rad(deg: number): number {\n\treturn deg * Math.PI / 180\n}\n\nexport function rad2deg(rad: number): number {\n\treturn rad * 180 / Math.PI\n}\n\nexport function clamp(\n\tval: number,\n\tmin: number,\n\tmax: number,\n): number {\n\tif (min > max) {\n\t\treturn clamp(val, max, min)\n\t}\n\treturn Math.min(Math.max(val, min), max)\n}\n\nexport function lerp(\n\ta: number,\n\tb: number,\n\tt: number,\n): number {\n\treturn a + (b - a) * t\n}\n\nexport function map(\n\tv: number,\n\tl1: number,\n\th1: number,\n\tl2: number,\n\th2: number,\n): number {\n\treturn l2 + (v - l1) / (h1 - l1) * (h2 - l2)\n}\n\nexport function mapc(\n\tv: number,\n\tl1: number,\n\th1: number,\n\tl2: number,\n\th2: number,\n): number {\n\treturn clamp(map(v, l1, h1, l2, h2), l2, h2)\n}\n\nexport class Vec2 {\n\tx: number = 0\n\ty: number = 0\n\tconstructor(x: number = 0, y: number = x) {\n\t\tthis.x = x\n\t\tthis.y = y\n\t}\n\tstatic fromAngle(deg: number) {\n\t\tconst angle = deg2rad(deg)\n\t\treturn new Vec2(Math.cos(angle), Math.sin(angle))\n\t}\n\tstatic LEFT = new Vec2(-1, 0)\n\tstatic RIGHT = new Vec2(1, 0)\n\tstatic UP = new Vec2(0, -1)\n\tstatic DOWN = new Vec2(0, 1)\n\tclone(): Vec2 {\n\t\treturn new Vec2(this.x, this.y)\n\t}\n\tadd(...args): Vec2 {\n\t\tconst p2 = vec2(...args)\n\t\treturn new Vec2(this.x + p2.x, this.y + p2.y)\n\t}\n\tsub(...args): Vec2 {\n\t\tconst p2 = vec2(...args)\n\t\treturn new Vec2(this.x - p2.x, this.y - p2.y)\n\t}\n\tscale(...args): Vec2 {\n\t\tconst s = vec2(...args)\n\t\treturn new Vec2(this.x * s.x, this.y * s.y)\n\t}\n\tdist(...args): number {\n\t\tconst p2 = vec2(...args)\n\t\treturn Math.sqrt(\n\t\t\t(this.x - p2.x) * (this.x - p2.x)\n\t\t\t+ (this.y - p2.y) * (this.y - p2.y),\n\t\t)\n\t}\n\tlen(): number {\n\t\treturn this.dist(new Vec2(0, 0))\n\t}\n\tunit(): Vec2 {\n\t\tconst len = this.len()\n\t\treturn len === 0 ? new Vec2(0) : this.scale(1 / len)\n\t}\n\tnormal(): Vec2 {\n\t\treturn new Vec2(this.y, -this.x)\n\t}\n\tdot(p2: Vec2): number {\n\t\treturn this.x * p2.x + this.y * p2.y\n\t}\n\tangle(...args): number {\n\t\tconst p2 = vec2(...args)\n\t\treturn rad2deg(Math.atan2(this.y - p2.y, this.x - p2.x))\n\t}\n\tlerp(p2: Vec2, t: number): Vec2 {\n\t\treturn new Vec2(lerp(this.x, p2.x, t), lerp(this.y, p2.y, t))\n\t}\n\tisZero(): boolean {\n\t\treturn this.x === 0 && this.y === 0\n\t}\n\ttoFixed(n: number): Vec2 {\n\t\treturn new Vec2(Number(this.x.toFixed(n)), Number(this.y.toFixed(n)))\n\t}\n\teq(other: Vec2): boolean {\n\t\treturn this.x === other.x && this.y === other.y\n\t}\n\ttoString(): string {\n\t\treturn `vec2(${this.x.toFixed(2)}, ${this.y.toFixed(2)})`\n\t}\n}\n\nexport function vec2(...args): Vec2 {\n\tif (args.length === 1) {\n\t\tif (args[0] instanceof Vec2) {\n\t\t\treturn vec2(args[0].x, args[0].y)\n\t\t} else if (Array.isArray(args[0]) && args[0].length === 2) {\n\t\t\treturn vec2(...args[0])\n\t\t}\n\t}\n\treturn new Vec2(...args)\n}\n\nexport class Vec3 {\n\tx: number = 0\n\ty: number = 0\n\tz: number = 0\n\tconstructor(x: number, y: number, z: number) {\n\t\tthis.x = x\n\t\tthis.y = y\n\t\tthis.z = z\n\t}\n\txy() {\n\t\treturn vec2(this.x, this.y)\n\t}\n}\n\nexport const vec3 = (x, y, z) => new Vec3(x, y, z)\n\nexport class Color {\n\n\tr: number = 255\n\tg: number = 255\n\tb: number = 255\n\n\tconstructor(r: number, g: number, b: number) {\n\t\tthis.r = clamp(r, 0, 255)\n\t\tthis.g = clamp(g, 0, 255)\n\t\tthis.b = clamp(b, 0, 255)\n\t}\n\n\tstatic fromArray(arr: number[]) {\n\t\treturn new Color(arr[0], arr[1], arr[2])\n\t}\n\n\tstatic fromHex(hex: string | number) {\n\t\tif (typeof hex === \"number\") {\n\t\t\treturn new Color(\n\t\t\t\t(hex >> 16) & 0xff,\n\t\t\t\t(hex >> 8) & 0xff,\n\t\t\t\t(hex >> 0) & 0xff,\n\t\t\t)\n\t\t} else {\n\t\t\tconst result = /^#?([a-f\\d]{2})([a-f\\d]{2})([a-f\\d]{2})$/i.exec(hex)\n\t\t\treturn new Color(\n\t\t\t\tparseInt(result[1], 16),\n\t\t\t\tparseInt(result[2], 16),\n\t\t\t\tparseInt(result[3], 16),\n\t\t\t)\n\t\t}\n\t}\n\n\tstatic fromHSL(h: number, s: number, l: number) {\n\n\t\tif (s == 0){\n\t\t\treturn rgb(255 * l, 255 * l, 255 * l)\n\t\t}\n\n\t\tconst hue2rgb = (p, q, t) => {\n\t\t\tif (t < 0) t += 1\n\t\t\tif (t > 1) t -= 1\n\t\t\tif (t < 1 / 6) return p + (q - p) * 6 * t\n\t\t\tif (t < 1 / 2) return q\n\t\t\tif (t < 2 / 3) return p + (q - p) * (2/3 - t) * 6\n\t\t\treturn p\n\t\t}\n\n\t\tconst q = l < 0.5 ? l * (1 + s) : l + s - l * s\n\t\tconst p = 2 * l - q\n\t\tconst r = hue2rgb(p, q, h + 1 / 3)\n\t\tconst g = hue2rgb(p, q, h)\n\t\tconst b = hue2rgb(p, q, h - 1 / 3)\n\n\t\treturn new Color(Math.round(r * 255), Math.round(g * 255), Math.round(b * 255))\n\n\t}\n\n\tstatic RED = rgb(255, 0, 0)\n\tstatic GREEN = rgb(0, 255, 0)\n\tstatic BLUE = rgb(0, 0, 255)\n\tstatic YELLOW = rgb(255, 255, 0)\n\tstatic MAGENTA = rgb(255, 0, 255)\n\tstatic CYAN = rgb(0, 255, 255)\n\tstatic WHITE = rgb(255, 255, 255)\n\tstatic BLACK = rgb(0, 0, 0)\n\n\tclone(): Color {\n\t\treturn new Color(this.r, this.g, this.b)\n\t}\n\n\tlighten(a: number): Color {\n\t\treturn new Color(this.r + a, this.g + a, this.b + a)\n\t}\n\n\tdarken(a: number): Color {\n\t\treturn this.lighten(-a)\n\t}\n\n\tinvert(): Color {\n\t\treturn new Color(255 - this.r, 255 - this.g, 255 - this.b)\n\t}\n\n\tmult(other: Color): Color {\n\t\treturn new Color(\n\t\t\tthis.r * other.r / 255,\n\t\t\tthis.g * other.g / 255,\n\t\t\tthis.b * other.b / 255,\n\t\t)\n\t}\n\n\teq(other: Color): boolean {\n\t\treturn this.r === other.r\n\t\t\t&& this.g === other.g\n\t\t\t&& this.b === other.b\n\n\t}\n\n\ttoString(): string {\n\t\treturn `rgb(${this.r}, ${this.g}, ${this.b})`\n\t}\n\n\ttoHex(): string {\n\t\treturn \"#\" + ((1 << 24) + (this.r << 16) + (this.g << 8) + this.b).toString(16).slice(1)\n\t}\n\n}\n\nexport function rgb(...args): Color {\n\tif (args.length === 0) {\n\t\treturn new Color(255, 255, 255)\n\t} else if (args.length === 1) {\n\t\tif (args[0] instanceof Color) {\n\t\t\treturn args[0].clone()\n\t\t} else if (Array.isArray(args[0]) && args[0].length === 3) {\n\t\t\treturn Color.fromArray(args[0])\n\t\t}\n\t}\n\t// @ts-ignore\n\treturn new Color(...args)\n}\n\nexport const hsl2rgb = (h, s, l) => Color.fromHSL(h, s, l)\n\nexport class Quad {\n\tx: number = 0\n\ty: number = 0\n\tw: number = 1\n\th: number = 1\n\tconstructor(x: number, y: number, w: number, h: number) {\n\t\tthis.x = x\n\t\tthis.y = y\n\t\tthis.w = w\n\t\tthis.h = h\n\t}\n\tscale(other: Quad): Quad {\n\t\treturn new Quad(\n\t\t\tthis.x + this.w * other.x,\n\t\t\tthis.y + this.h * other.y,\n\t\t\tthis.w * other.w,\n\t\t\tthis.h * other.h,\n\t\t)\n\t}\n\tclone(): Quad {\n\t\treturn new Quad(this.x, this.y, this.w, this.h)\n\t}\n\teq(other: Quad): boolean {\n\t\treturn this.x === other.x\n\t\t\t&& this.y === other.y\n\t\t\t&& this.w === other.w\n\t\t\t&& this.h === other.h\n\t}\n\ttoString(): string {\n\t\treturn `quad(${this.x}, ${this.y}, ${this.w}, ${this.h})`\n\t}\n}\n\nexport function quad(x: number, y: number, w: number, h: number): Quad {\n\treturn new Quad(x, y, w, h)\n}\n\nexport class Mat4 {\n\n\tm: number[] = [\n\t\t1, 0, 0, 0,\n\t\t0, 1, 0, 0,\n\t\t0, 0, 1, 0,\n\t\t0, 0, 0, 1,\n\t]\n\n\tconstructor(m?: number[]) {\n\t\tif (m) {\n\t\t\tthis.m = m\n\t\t}\n\t}\n\n\tstatic translate(p: Vec2): Mat4 {\n\t\treturn new Mat4([\n\t\t\t1, 0, 0, 0,\n\t\t\t0, 1, 0, 0,\n\t\t\t0, 0, 1, 0,\n\t\t\tp.x, p.y, 0, 1,\n\t\t])\n\t}\n\n\tstatic scale(s: Vec2): Mat4 {\n\t\treturn new Mat4([\n\t\t\ts.x, 0, 0, 0,\n\t\t\t0, s.y, 0, 0,\n\t\t\t0, 0, 1, 0,\n\t\t\t0, 0, 0, 1,\n\t\t])\n\t}\n\n\tstatic rotateX(a: number): Mat4 {\n\t\ta = deg2rad(-a)\n\t\treturn new Mat4([\n\t\t\t1, 0, 0, 0,\n\t\t\t0, Math.cos(a), -Math.sin(a), 0,\n\t\t\t0, Math.sin(a), Math.cos(a), 0,\n\t\t\t0, 0, 0, 1,\n\t\t])\n\t}\n\n\tstatic rotateY(a: number): Mat4 {\n\t\ta = deg2rad(-a)\n\t\treturn new Mat4([\n\t\t\tMath.cos(a), 0, Math.sin(a), 0,\n\t\t\t0, 1, 0, 0,\n\t\t\t-Math.sin(a), 0, Math.cos(a), 0,\n\t\t\t0, 0, 0, 1,\n\t\t])\n\t}\n\n\tstatic rotateZ(a: number): Mat4 {\n\t\ta = deg2rad(-a)\n\t\treturn new Mat4([\n\t\t\tMath.cos(a), -Math.sin(a), 0, 0,\n\t\t\tMath.sin(a), Math.cos(a), 0, 0,\n\t\t\t0, 0, 1, 0,\n\t\t\t0, 0, 0, 1,\n\t\t])\n\t}\n\n\ttranslate(p: Vec2): Mat4 {\n\t\treturn this.mult(Mat4.translate(p))\n\t}\n\n\tscale(s: Vec2): Mat4 {\n\t\treturn this.mult(Mat4.scale(s))\n\t}\n\n\trotateX(a: number): Mat4 {\n\t\treturn this.mult(Mat4.rotateX(a))\n\t}\n\n\trotateY(a: number): Mat4 {\n\t\treturn this.mult(Mat4.rotateY(a))\n\t}\n\n\trotateZ(a: number): Mat4 {\n\t\treturn this.mult(Mat4.rotateZ(a))\n\t}\n\n\tmult(other: Mat4): Mat4 {\n\n\t\tconst out = []\n\n\t\tfor (let i = 0; i < 4; i++) {\n\t\t\tfor (let j = 0; j < 4; j++) {\n\t\t\t\tout[i * 4 + j] =\n\t\t\t\t\tthis.m[0 * 4 + j] * other.m[i * 4 + 0] +\n\t\t\t\t\tthis.m[1 * 4 + j] * other.m[i * 4 + 1] +\n\t\t\t\t\tthis.m[2 * 4 + j] * other.m[i * 4 + 2] +\n\t\t\t\t\tthis.m[3 * 4 + j] * other.m[i * 4 + 3]\n\t\t\t}\n\t\t}\n\n\t\treturn new Mat4(out)\n\n\t}\n\n\tmultVec4(p: Vec4): Vec4 {\n\t\treturn {\n\t\t\tx: p.x * this.m[0] + p.y * this.m[4] + p.z * this.m[8] + p.w * this.m[12],\n\t\t\ty: p.x * this.m[1] + p.y * this.m[5] + p.z * this.m[9] + p.w * this.m[13],\n\t\t\tz: p.x * this.m[2] + p.y * this.m[6] + p.z * this.m[10] + p.w * this.m[14],\n\t\t\tw: p.x * this.m[3] + p.y * this.m[7] + p.z * this.m[11] + p.w * this.m[15],\n\t\t}\n\t}\n\n\tmultVec3(p: Vec3): Vec3 {\n\t\tconst p4 = this.multVec4({\n\t\t\tx: p.x,\n\t\t\ty: p.y,\n\t\t\tz: p.z,\n\t\t\tw: 1.0,\n\t\t})\n\t\treturn vec3(p4.x, p4.y, p4.z)\n\t}\n\n\tmultVec2(p: Vec2): Vec2 {\n\t\treturn vec2(\n\t\t\tp.x * this.m[0] + p.y * this.m[4] + 0 * this.m[8] + 1 * this.m[12],\n\t\t\tp.x * this.m[1] + p.y * this.m[5] + 0 * this.m[9] + 1 * this.m[13],\n\t\t)\n\t}\n\n\tinvert(): Mat4 {\n\n\t\tconst out = []\n\n\t\tconst f00 = this.m[10] * this.m[15] - this.m[14] * this.m[11]\n\t\tconst f01 = this.m[9] * this.m[15] - this.m[13] * this.m[11]\n\t\tconst f02 = this.m[9] * this.m[14] - this.m[13] * this.m[10]\n\t\tconst f03 = this.m[8] * this.m[15] - this.m[12] * this.m[11]\n\t\tconst f04 = this.m[8] * this.m[14] - this.m[12] * this.m[10]\n\t\tconst f05 = this.m[8] * this.m[13] - this.m[12] * this.m[9]\n\t\tconst f06 = this.m[6] * this.m[15] - this.m[14] * this.m[7]\n\t\tconst f07 = this.m[5] * this.m[15] - this.m[13] * this.m[7]\n\t\tconst f08 = this.m[5] * this.m[14] - this.m[13] * this.m[6]\n\t\tconst f09 = this.m[4] * this.m[15] - this.m[12] * this.m[7]\n\t\tconst f10 = this.m[4] * this.m[14] - this.m[12] * this.m[6]\n\t\tconst f11 = this.m[5] * this.m[15] - this.m[13] * this.m[7]\n\t\tconst f12 = this.m[4] * this.m[13] - this.m[12] * this.m[5]\n\t\tconst f13 = this.m[6] * this.m[11] - this.m[10] * this.m[7]\n\t\tconst f14 = this.m[5] * this.m[11] - this.m[9] * this.m[7]\n\t\tconst f15 = this.m[5] * this.m[10] - this.m[9] * this.m[6]\n\t\tconst f16 = this.m[4] * this.m[11] - this.m[8] * this.m[7]\n\t\tconst f17 = this.m[4] * this.m[10] - this.m[8] * this.m[6]\n\t\tconst f18 = this.m[4] * this.m[9] - this.m[8] * this.m[5]\n\n\t\tout[0] = this.m[5] * f00 - this.m[6] * f01 + this.m[7] * f02\n\t\tout[4] = -(this.m[4] * f00 - this.m[6] * f03 + this.m[7] * f04)\n\t\tout[8] = this.m[4] * f01 - this.m[5] * f03 + this.m[7] * f05\n\t\tout[12] = -(this.m[4] * f02 - this.m[5] * f04 + this.m[6] * f05)\n\n\t\tout[1] = -(this.m[1] * f00 - this.m[2] * f01 + this.m[3] * f02)\n\t\tout[5] = this.m[0] * f00 - this.m[2] * f03 + this.m[3] * f04\n\t\tout[9] = -(this.m[0] * f01 - this.m[1] * f03 + this.m[3] * f05)\n\t\tout[13] = this.m[0] * f02 - this.m[1] * f04 + this.m[2] * f05\n\n\t\tout[2] = this.m[1] * f06 - this.m[2] * f07 + this.m[3] * f08\n\t\tout[6] = -(this.m[0] * f06 - this.m[2] * f09 + this.m[3] * f10)\n\t\tout[10] = this.m[0] * f11 - this.m[1] * f09 + this.m[3] * f12\n\t\tout[14] = -(this.m[0] * f08 - this.m[1] * f10 + this.m[2] * f12)\n\n\t\tout[3] = -(this.m[1] * f13 - this.m[2] * f14 + this.m[3] * f15)\n\t\tout[7] = this.m[0] * f13 - this.m[2] * f16 + this.m[3] * f17\n\t\tout[11] = -(this.m[0] * f14 - this.m[1] * f16 + this.m[3] * f18)\n\t\tout[15] = this.m[0] * f15 - this.m[1] * f17 + this.m[2] * f18\n\n\t\tconst det =\n\t\t\tthis.m[0] * out[0] +\n\t\t\tthis.m[1] * out[4] +\n\t\t\tthis.m[2] * out[8] +\n\t\t\tthis.m[3] * out[12]\n\n\t\tfor (let i = 0; i < 4; i++) {\n\t\t\tfor (let j = 0; j < 4; j++) {\n\t\t\t\tout[i * 4 + j] *= (1.0 / det)\n\t\t\t}\n\t\t}\n\n\t\treturn new Mat4(out)\n\n\t}\n\n\tclone(): Mat4 {\n\t\treturn new Mat4(this.m)\n\t}\n\n\ttoString(): string {\n\t\treturn this.m.toString()\n\t}\n\n}\n\nexport function wave(lo: number, hi: number, t: number, f = Math.sin): number {\n\treturn lo + (f(t) + 1) / 2 * (hi - lo)\n}\n\n// basic ANSI C LCG\nconst A = 1103515245\nconst C = 12345\nconst M = 2147483648\n\nexport class RNG {\n\tseed: number\n\tconstructor(seed: number) {\n\t\tthis.seed = seed\n\t}\n\tgen(): number {\n\t\tthis.seed = (A * this.seed + C) % M\n\t\treturn this.seed / M\n\t}\n\tgenNumber(a: number, b: number): number {\n\t\treturn a + this.gen() * (b - a)\n\t}\n\tgenVec2(a: Vec2, b?: Vec2): Vec2 {\n\t\treturn new Vec2(\n\t\t\tthis.genNumber(a.x, b.x),\n\t\t\tthis.genNumber(a.y, b.y),\n\t\t)\n\t}\n\tgenColor(a: Color, b: Color): Color {\n\t\treturn new Color(\n\t\t\tthis.genNumber(a.r, b.r),\n\t\t\tthis.genNumber(a.g, b.g),\n\t\t\tthis.genNumber(a.b, b.b),\n\t\t)\n\t}\n\tgenAny<T extends RNGValue>(...args: T[]): T {\n\t\tif (args.length === 0) {\n\t\t\treturn this.gen() as T\n\t\t} else if (args.length === 1) {\n\t\t\tif (typeof args[0] === \"number\") {\n\t\t\t\treturn this.genNumber(0, args[0]) as T\n\t\t\t} else if (args[0] instanceof Vec2) {\n\t\t\t\treturn this.genVec2(vec2(0, 0), args[0]) as T\n\t\t\t} else if (args[0] instanceof Color) {\n\t\t\t\treturn this.genColor(rgb(0, 0, 0), args[0]) as T\n\t\t\t}\n\t\t} else if (args.length === 2) {\n\t\t\tif (typeof args[0] === \"number\" && typeof args[1] === \"number\") {\n\t\t\t\treturn this.genNumber(args[0], args[1]) as T\n\t\t\t} else if (args[0] instanceof Vec2 && args[1] instanceof Vec2) {\n\t\t\t\treturn this.genVec2(args[0], args[1]) as T\n\t\t\t} else if (args[0] instanceof Color && args[1] instanceof Color) {\n\t\t\t\treturn this.genColor(args[0], args[1]) as T\n\t\t\t}\n\t\t}\n\t}\n}\n\n// TODO: let user pass seed\nconst defRNG = new RNG(Date.now())\n\nexport function randSeed(seed?: number): number {\n\tif (seed != null) {\n\t\tdefRNG.seed = seed\n\t}\n\treturn defRNG.seed\n}\n\nexport function rand(...args) {\n\t// @ts-ignore\n\treturn defRNG.genAny(...args)\n}\n\n// TODO: randi() to return 0 / 1?\nexport function randi(...args: number[]) {\n\treturn Math.floor(rand(...args))\n}\n\nexport function chance(p: number): boolean {\n\treturn rand() <= p\n}\n\nexport function choose<T>(list: T[]): T {\n\treturn list[randi(list.length)]\n}\n\n// TODO: better name\nexport function testRectRect2(r1: Rect, r2: Rect): boolean {\n\treturn r1.pos.x + r1.width >= r2.pos.x\n\t\t&& r1.pos.x <= r2.pos.x + r2.width\n\t\t&& r1.pos.y + r1.height >= r2.pos.y\n\t\t&& r1.pos.y <= r2.pos.y + r2.height\n}\n\nexport function testRectRect(r1: Rect, r2: Rect): boolean {\n\treturn r1.pos.x + r1.width > r2.pos.x\n\t\t&& r1.pos.x < r2.pos.x + r2.width\n\t\t&& r1.pos.y + r1.height > r2.pos.y\n\t\t&& r1.pos.y < r2.pos.y + r2.height\n}\n\n// TODO: better name\nexport function testLineLineT(l1: Line, l2: Line): number | null {\n\n\tif ((l1.p1.x === l1.p2.x && l1.p1.y === l1.p2.y) || (l2.p1.x === l2.p2.x && l2.p1.y === l2.p2.y)) {\n\t\treturn null\n\t}\n\n\tconst denom = ((l2.p2.y - l2.p1.y) * (l1.p2.x - l1.p1.x) - (l2.p2.x - l2.p1.x) * (l1.p2.y - l1.p1.y))\n\n\t// parallel\n\tif (denom === 0) {\n\t\treturn null\n\t}\n\n\tconst ua = ((l2.p2.x - l2.p1.x) * (l1.p1.y - l2.p1.y) - (l2.p2.y - l2.p1.y) * (l1.p1.x - l2.p1.x)) / denom\n\tconst ub = ((l1.p2.x - l1.p1.x) * (l1.p1.y - l2.p1.y) - (l1.p2.y - l1.p1.y) * (l1.p1.x - l2.p1.x)) / denom\n\n\t// is the intersection on the segments\n\tif (ua < 0 || ua > 1 || ub < 0 || ub > 1) {\n\t\treturn null\n\t}\n\n\treturn ua\n\n}\n\nexport function testLineLine(l1: Line, l2: Line): Vec2 | null {\n\tconst t = testLineLineT(l1, l2)\n\tif (!t) return null\n\treturn vec2(\n\t\tl1.p1.x + t * (l1.p2.x - l1.p1.x),\n\t\tl1.p1.y + t * (l1.p2.y - l1.p1.y),\n\t)\n}\n\nexport function testRectLine(r: Rect, l: Line): boolean {\n\tif (testRectPoint(r, l.p1) || testRectPoint(r, l.p2)) {\n\t\treturn true\n\t}\n\tconst pts = r.points()\n\treturn !!testLineLine(l, new Line(pts[0], pts[1]))\n\t\t|| !!testLineLine(l, new Line(pts[1], pts[2]))\n\t\t|| !!testLineLine(l, new Line(pts[2], pts[3]))\n\t\t|| !!testLineLine(l, new Line(pts[3], pts[0]))\n}\n\nexport function testRectPoint2(r: Rect, pt: Point): boolean {\n\treturn pt.x >= r.pos.x\n\t\t&& pt.x <= r.pos.x + r.width\n\t\t&& pt.y >= r.pos.y\n\t\t&& pt.y <= r.pos.y + r.height\n}\n\nexport function testRectPoint(r: Rect, pt: Point): boolean {\n\treturn pt.x > r.pos.x\n\t\t&& pt.x < r.pos.x + r.width\n\t\t&& pt.y > r.pos.y\n\t\t&& pt.y < r.pos.y + r.height\n}\n\nexport function testRectCircle(r: Rect, c: Circle): boolean {\n\tconst nx = Math.max(r.pos.x, Math.min(c.center.x, r.pos.x + r.width))\n\tconst ny = Math.max(r.pos.y, Math.min(c.center.y, r.pos.y + r.height))\n\tconst nearestPoint = vec2(nx, ny)\n\treturn nearestPoint.dist(c.center) <= c.radius\n}\n\nexport function testRectPolygon(r: Rect, p: Polygon): boolean {\n\treturn testPolygonPolygon(p, new Polygon(r.points()))\n}\n\n// TODO\nexport function testLinePoint(l: Line, pt: Vec2): boolean {\n\treturn false\n}\n\n// TODO\nexport function testLineCircle(l: Line, c: Circle): boolean {\n\treturn false\n}\n\nexport function testLinePolygon(l: Line, p: Polygon): boolean {\n\n\t// test if line is inside\n\tif (testPolygonPoint(p, l.p1) || testPolygonPoint(p, l.p2)) {\n\t\treturn true\n\t}\n\n\t// test each line\n\tfor (let i = 0; i < p.pts.length; i++) {\n\t\tconst p1 = p.pts[i]\n\t\tconst p2 = p.pts[(i + 1) % p.pts.length]\n\t\tif (testLineLine(l, new Line(p1, p2))) {\n\t\t\treturn true\n\t\t}\n\t}\n\n\treturn false\n\n}\n\nexport function testCirclePoint(c: Circle, p: Point): boolean {\n\treturn c.center.dist(p) < c.radius\n}\n\nexport function testCircleCircle(c1: Circle, c2: Circle): boolean {\n\treturn c1.center.dist(c2.center) < c1.radius + c2.radius\n}\n\n// TODO\nexport function testCirclePolygon(c: Circle, p: Polygon): boolean {\n\treturn false\n}\n\nexport function testPolygonPolygon(p1: Polygon, p2: Polygon): boolean {\n\tfor (let i = 0; i < p1.pts.length; i++) {\n\t\tif (testLinePolygon(new Line(p1.pts[i], p1.pts[(i + 1) % p1.pts.length]), p2)) {\n\t\t\treturn true\n\t\t}\n\t}\n\treturn false\n}\n\n// https://wrf.ecse.rpi.edu/Research/Short_Notes/pnpoly.html\nexport function testPolygonPoint(poly: Polygon, pt: Point): boolean {\n\n\tlet c = false\n\tconst p = poly.pts\n\n\tfor (let i = 0, j = p.length - 1; i < p.length; j = i++) {\n\t\tif (\n\t\t\t((p[i].y > pt.y) != (p[j].y > pt.y))\n\t\t\t&& (pt.x < (p[j].x - p[i].x) * (pt.y - p[i].y) / (p[j].y - p[i].y) + p[i].x)\n\t\t) {\n\t\t\tc = !c\n\t\t}\n\t}\n\n\treturn c\n\n}\n\nexport function testPointPoint(p1: Point, p2: Point): boolean {\n\treturn p1.x === p2.x && p1.y === p2.y\n}\n\nexport class Line {\n\tp1: Vec2\n\tp2: Vec2\n\tconstructor(p1: Vec2, p2: Vec2) {\n\t\tthis.p1 = p1\n\t\tthis.p2 = p2\n\t}\n\ttransform(m: Mat4): Line {\n\t\treturn new Line(m.multVec2(this.p1), m.multVec2(this.p2))\n\t}\n\tbbox(): Rect {\n\t\treturn Rect.fromPoints(this.p1, this.p2)\n\t}\n}\n\nexport class Rect {\n\tpos: Vec2\n\twidth: number\n\theight: number\n\tconstructor(pos: Vec2, width: number, height: number) {\n\t\tthis.pos = pos\n\t\tthis.width = width\n\t\tthis.height = height\n\t}\n\tstatic fromPoints(p1: Vec2, p2: Vec2): Rect {\n\t\treturn new Rect(p1.clone(), p2.x - p1.x, p2.y - p1.y)\n\t}\n\tcenter(): Vec2 {\n\t\treturn new Vec2(this.pos.x + this.width / 2, this.pos.y + this.height / 2)\n\t}\n\tpoints(): [Vec2, Vec2, Vec2, Vec2] {\n\t\treturn [\n\t\t\tthis.pos,\n\t\t\tthis.pos.add(this.width, 0),\n\t\t\tthis.pos.add(this.width, this.height),\n\t\t\tthis.pos.add(0, this.height),\n\t\t]\n\t}\n\ttransform(m: Mat4): Polygon {\n\t\treturn new Polygon(this.points().map((pt) => m.multVec2(pt)))\n\t}\n\tbbox(): Rect {\n\t\treturn new Rect(this.pos.clone(), this.width, this.height)\n\t}\n\tdistToPoint(p: Vec2): number {\n\t\tconst min = this.pos\n\t\tconst max = this.pos.add(this.width, this.height)\n\t\tconst dx = Math.max(min.x - p.x, 0, p.x - max.x)\n\t\tconst dy = Math.max(min.y - p.y, 0, p.y - max.y)\n\t\treturn Math.sqrt(dx * dx + dy * dy)\n\t}\n}\n\nexport class Circle {\n\tcenter: Vec2\n\tradius: number\n\tconstructor(center: Vec2, radius: number) {\n\t\tthis.center = center\n\t\tthis.radius = radius\n\t}\n\ttransform(tr: Mat4): Ellipse {\n\t\treturn new Ellipse(this.center, this.radius, this.radius).transform(tr)\n\t}\n\tbbox(): Rect {\n\t\treturn Rect.fromPoints(\n\t\t\tthis.center.sub(vec2(this.radius)),\n\t\t\tthis.center.add(vec2(this.radius)),\n\t\t)\n\t}\n}\n\nexport class Ellipse {\n\tcenter: Vec2\n\tradiusX: number\n\tradiusY: number\n\tconstructor(center: Vec2, rx: number, ry: number) {\n\t\tthis.center = center\n\t\tthis.radiusX = rx\n\t\tthis.radiusY = ry\n\t}\n\ttransform(tr: Mat4): Ellipse {\n\t\treturn new Ellipse(\n\t\t\ttr.multVec2(this.center),\n\t\t\ttr.m[0] * this.radiusX,\n\t\t\ttr.m[5] * this.radiusY,\n\t\t)\n\t}\n\tbbox(): Rect {\n\t\treturn Rect.fromPoints(\n\t\t\tthis.center.sub(vec2(this.radiusX, this.radiusY)),\n\t\t\tthis.center.add(vec2(this.radiusX, this.radiusY)),\n\t\t)\n\t}\n}\n\nexport class Polygon {\n\tpts: Vec2[]\n\tconstructor(pts: Vec2[]) {\n\t\tif (pts.length < 3) {\n\t\t\tthrow new Error(\"Polygons should have at least 3 vertices\")\n\t\t}\n\t\tthis.pts = pts\n\t}\n\ttransform(m: Mat4): Polygon {\n\t\treturn new Polygon(this.pts.map((pt) => m.multVec2(pt)))\n\t}\n\tbbox(): Rect {\n\t\tconst p1 = vec2(Number.MAX_VALUE)\n\t\tconst p2 = vec2(-Number.MAX_VALUE)\n\t\tfor (const pt of this.pts) {\n\t\t\tp1.x = Math.min(p1.x, pt.x)\n\t\t\tp2.x = Math.max(p2.x, pt.x)\n\t\t\tp1.y = Math.min(p1.y, pt.y)\n\t\t\tp2.y = Math.max(p2.y, pt.y)\n\t\t}\n\t\treturn Rect.fromPoints(p1, p2)\n\t}\n}\n\nexport function sat(p1: Polygon, p2: Polygon): Vec2 | null {\n\tlet overlap = Number.MAX_VALUE\n\tlet displacement = vec2(0)\n\tfor (const poly of [p1, p2]) {\n\t\tfor (let i = 0; i < poly.pts.length; i++) {\n\t\t\tconst a = poly.pts[i]\n\t\t\tconst b = poly.pts[(i + 1) % poly.pts.length]\n\t\t\tconst axisProj = b.sub(a).normal().unit()\n\t\t\tlet min1 = Number.MAX_VALUE\n\t\t\tlet max1 = -Number.MAX_VALUE\n\t\t\tfor (let j = 0; j < p1.pts.length; j++) {\n\t\t\t\tconst q = p1.pts[j].dot(axisProj)\n\t\t\t\tmin1 = Math.min(min1, q)\n\t\t\t\tmax1 = Math.max(max1, q)\n\t\t\t}\n\t\t\tlet min2 = Number.MAX_VALUE\n\t\t\tlet max2 = -Number.MAX_VALUE\n\t\t\tfor (let j = 0; j < p2.pts.length; j++) {\n\t\t\t\tconst q = p2.pts[j].dot(axisProj)\n\t\t\t\tmin2 = Math.min(min2, q)\n\t\t\t\tmax2 = Math.max(max2, q)\n\t\t\t}\n\t\t\tconst o = Math.min(max1, max2) - Math.max(min1, min2)\n\t\t\tif (o < 0) {\n\t\t\t\treturn null\n\t\t\t}\n\t\t\tif (o < Math.abs(overlap)) {\n\t\t\t\tconst o1 = max2 - min1\n\t\t\t\tconst o2 = min2 - max1\n\t\t\t\toverlap = Math.abs(o1) < Math.abs(o2) ? o1 : o2\n\t\t\t\tdisplacement = axisProj.scale(overlap)\n\t\t\t}\n\t\t}\n\t}\n\treturn displacement\n}\n\n// https://easings.net/\nconst c1 = 1.70158\nconst c2 = c1 * 1.525\nconst c3 = c1 + 1\nconst c4 = (2 * Math.PI) / 3\nconst c5 = (2 * Math.PI) / 4.5\n\nexport const easings = {\n\tlinear: (x) => x,\n\teaseInSine: (x) => 1 - Math.cos((x * Math.PI) / 2),\n\teaseOutSine: (x) => Math.sin((x * Math.PI) / 2),\n\teaseInOutSine: (x) => -(Math.cos(Math.PI * x) - 1) / 2,\n\teaseInQuad: (x) => x * x,\n\teaseOutQuad: (x) => 1 - (1 - x) * (1 - x),\n\teaseInOutQuad: (x) => x < 0.5 ? 2 * x * x : 1 - Math.pow(-2 * x + 2, 2) / 2,\n\teaseInCubic: (x) => x * x * x,\n\teaseOutCubic: (x) => 1 - Math.pow(1 - x, 3),\n\teaseInOutCubic: (x) => x < 0.5 ? 4 * x * x * x : 1 - Math.pow(-2 * x + 2, 3) / 2,\n\teaseInQuart: (x) => x * x * x * x,\n\teaseOutQuart: (x) => 1 - Math.pow(1 - x, 4),\n\teaseInOutQuart: (x) => x < 0.5 ? 8 * x * x * x * x : 1 - Math.pow(-2 * x + 2, 4) / 2,\n\teaseInQuint: (x) => x * x * x * x * x,\n\teaseOutQuint: (x) => 1 - Math.pow(1 - x, 5),\n\teaseInOutQuint: (x) => x < 0.5 ? 16 * x * x * x * x * x : 1 - Math.pow(-2 * x + 2, 5) / 2,\n\teaseInExpo: (x) => x === 0 ? 0 : Math.pow(2, 10 * x - 10),\n\teaseOutExpo: (x) => x === 1 ? 1 : 1 - Math.pow(2, -10 * x),\n\teaseInOutExpo: (x) => {\n\t\treturn x === 0\n\t\t\t? 0\n\t\t\t: x === 1\n\t\t\t\t? 1\n\t\t\t\t: x < 0.5\n\t\t\t\t\t? Math.pow(2, 20 * x - 10) / 2\n\t\t\t\t\t: (2 - Math.pow(2, -20 * x + 10)) / 2\n\t},\n\teaseInCirc: (x) => 1 - Math.sqrt(1 - Math.pow(x, 2)),\n\teaseOutCirc: (x) => Math.sqrt(1 - Math.pow(x - 1, 2)),\n\teaseInOutCirc: (x) => {\n\t\treturn x < 0.5\n\t\t\t? (1 - Math.sqrt(1 - Math.pow(2 * x, 2))) / 2\n\t\t\t: (Math.sqrt(1 - Math.pow(-2 * x + 2, 2)) + 1) / 2\n\t},\n\teaseInBack: (x) => c3 * x * x * x - c1 * x * x,\n\teaseOutBack: (x) => 1 + c3 * Math.pow(x - 1, 3) + c1 * Math.pow(x - 1, 2),\n\teaseInOutBack: (x) => {\n\t\treturn x < 0.5\n\t\t\t? (Math.pow(2 * x, 2) * ((c2 + 1) * 2 * x - c2)) / 2\n\t\t\t: (Math.pow(2 * x - 2, 2) * ((c2 + 1) * (x * 2 - 2) + c2) + 2) / 2\n\t},\n\teaseInElastic: (x) => {\n\t\treturn x === 0\n\t\t\t? 0\n\t\t\t: x === 1\n\t\t\t\t? 1\n\t\t\t\t: -Math.pow(2, 10 * x - 10) * Math.sin((x * 10 - 10.75) * c4)\n\t},\n\teaseOutElastic: (x) => {\n\t\treturn x === 0\n\t\t\t? 0\n\t\t\t: x === 1\n\t\t\t\t? 1\n\t\t\t\t: Math.pow(2, -10 * x) * Math.sin((x * 10 - 0.75) * c4) + 1\n\t},\n\teaseInOutElastic: (x) => {\n\t\treturn x === 0\n\t\t\t? 0\n\t\t\t: x === 1\n\t\t\t\t? 1\n\t\t\t\t: x < 0.5\n\t\t\t\t\t? -(Math.pow(2, 20 * x - 10) * Math.sin((20 * x - 11.125) * c5)) / 2\n\t\t\t\t\t: (Math.pow(2, -20 * x + 10) * Math.sin((20 * x - 11.125) * c5)) / 2 + 1\n\t},\n\teaseInBounce: (x) => 1 - easings.easeOutBounce(1 - x),\n\teaseOutBounce: (x) => {\n\t\tconst n1 = 7.5625\n\t\tconst d1 = 2.75\n\t\tif (x < 1 / d1) {\n\t\t\treturn n1 * x * x\n\t\t} else if (x < 2 / d1) {\n\t\t\treturn n1 * (x -= 1.5 / d1) * x + 0.75\n\t\t} else if (x < 2.5 / d1) {\n\t\t\treturn n1 * (x -= 2.25 / d1) * x + 0.9375\n\t\t} else {\n\t\t\treturn n1 * (x -= 2.625 / d1) * x + 0.984375\n\t\t}\n\t},\n\teaseInOutBounce: (x) => {\n\t\treturn x < 0.5\n\t\t\t? (1 - easings.easeOutBounce(1 - 2 * x)) / 2\n\t\t\t: (1 + easings.easeOutBounce(2 * x - 1)) / 2\n\t},\n}\n", "import { EventController } from \"./types\"\n\nexport class IDList<T> extends Map<number, T> {\n\tprivate lastID: number\n\tconstructor(...args) {\n\t\tsuper(...args)\n\t\tthis.lastID = 0\n\t}\n\tpush(v: T): number {\n\t\tconst id = this.lastID\n\t\tthis.set(id, v)\n\t\tthis.lastID++\n\t\treturn id\n\t}\n\tpushd(v: T): () => void {\n\t\tconst id = this.push(v)\n\t\treturn () => this.delete(id)\n\t}\n}\n\nexport class Event<Args extends any[] = any[]> {\n\tprivate handlers: IDList<(...args: Args) => void> = new IDList()\n\tadd(action: (...args: Args) => void): EventController {\n\t\tconst cancel = this.handlers.pushd((...args: Args) => {\n\t\t\tif (handle.paused) return\n\t\t\taction(...args)\n\t\t})\n\t\tconst handle = {\n\t\t\tpaused: false,\n\t\t\tcancel: cancel,\n\t\t}\n\t\treturn handle\n\t}\n\taddOnce(action: (...args) => void): EventController {\n\t\tconst ev = this.add((...args) => {\n\t\t\tev.cancel()\n\t\t\taction(...args)\n\t\t})\n\t\treturn ev\n\t}\n\tnext(): Promise<Args> {\n\t\treturn new Promise((res) => this.addOnce(res))\n\t}\n\ttrigger(...args: Args) {\n\t\tthis.handlers.forEach((action) => action(...args))\n\t}\n\tnumListeners(): number {\n\t\treturn this.handlers.size\n\t}\n}\n\n// TODO: be able to type each event\nexport class EventHandler<E = string> {\n\tprivate handlers: Map<E, Event> = new Map()\n\ton(name: E, action: (...args) => void): EventController {\n\t\tif (!this.handlers.get(name)) {\n\t\t\tthis.handlers.set(name, new Event())\n\t\t}\n\t\treturn this.handlers.get(name).add(action)\n\t}\n\tonOnce(name: E, action: (...args) => void): EventController {\n\t\tconst ev = this.on(name, (...args) => {\n\t\t\tev.cancel()\n\t\t\taction(...args)\n\t\t})\n\t\treturn ev\n\t}\n\tnext(name: E): Promise<unknown> {\n\t\treturn new Promise((res) => {\n\t\t\tthis.onOnce(name, res)\n\t\t})\n\t}\n\ttrigger(name: E, ...args) {\n\t\tif (this.handlers.get(name)) {\n\t\t\tthis.handlers.get(name).trigger(...args)\n\t\t}\n\t}\n\tremove(name: E) {\n\t\tthis.handlers.delete(name)\n\t}\n\tclear() {\n\t\tthis.handlers = new Map()\n\t}\n\tnumListeners(name: E): number {\n\t\treturn this.handlers.get(name)?.numListeners() ?? 0\n\t}\n}\n\nexport function deepEq(o1: any, o2: any): boolean {\n\tconst t1 = typeof o1\n\tconst t2 = typeof o2\n\tif (t1 !== t2) {\n\t\treturn false\n\t}\n\tif (t1 === \"object\" && t2 === \"object\") {\n\t\tconst k1 = Object.keys(o1)\n\t\tconst k2 = Object.keys(o2)\n\t\tif (k1.length !== k2.length) {\n\t\t\treturn false\n\t\t}\n\t\tfor (const k of k1) {\n\t\t\tconst v1 = o1[k]\n\t\t\tconst v2 = o2[k]\n\t\t\tif (!(typeof v1 === \"function\" && typeof v2 === \"function\")) {\n\t\t\t\tif (!deepEq(v1, v2)) {\n\t\t\t\t\treturn false\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn true\n\t}\n\treturn o1 === o2\n}\n\nexport function base64ToArrayBuffer(base64: string): ArrayBuffer {\n\tconst binstr = window.atob(base64)\n\tconst len = binstr.length\n\tconst bytes = new Uint8Array(len)\n\tfor (let i = 0; i < len; i++) {\n\t\tbytes[i] = binstr.charCodeAt(i)\n\t}\n\treturn bytes.buffer\n}\n\nexport function dataURLToArrayBuffer(url: string): ArrayBuffer {\n\treturn base64ToArrayBuffer(url.split(\",\")[1])\n}\n\nexport function download(filename: string, url: string) {\n\tconst a = document.createElement(\"a\")\n\ta.href = url\n\ta.download = filename\n\ta.click()\n}\n\nexport function downloadText(filename: string, text: string) {\n\tdownload(filename, \"data:text/plain;charset=utf-8,\" + text)\n}\n\nexport function downloadJSON(filename: string, data: any) {\n\tdownloadText(filename, JSON.stringify(data))\n}\n\nexport function downloadBlob(filename: string, blob: Blob) {\n\tconst url = URL.createObjectURL(blob)\n\tdownload(filename, url)\n\tURL.revokeObjectURL(url)\n}\n\nexport function isDataURL(str: string) {\n\treturn str.match(/^data:\\w+\\/\\w+;base64,.+/)\n}\n\nexport const uid = (() => {\n\tlet id = 0\n\treturn () => id++\n})()\n\nconst warned = new Set()\n\nexport function warn(msg: string) {\n\tif (!warned.has(msg)) {\n\t\twarned.add(msg)\n\t\tconsole.warn(msg)\n\t}\n}\n\nexport function deprecateMsg(oldName: string, newName: string) {\n\twarn(`${oldName} is deprecated. Use ${newName} instead.`)\n}\n\nexport function deprecate(oldName: string, newName: string, newFunc: (...args) => any) {\n\treturn (...args) => {\n\t\tdeprecateMsg(oldName, newName)\n\t\treturn newFunc(...args)\n\t}\n}\n\nexport function benchmark(task: () => void, times: number = 1) {\n\tconst t1 = performance.now()\n\tfor (let i = 0; i < times; i++) {\n\t\ttask()\n\t}\n\tconst t2 = performance.now()\n\treturn t2 - t1\n}\n", "export default class FPSCounter {\n\n\tprivate dts: number[] = []\n\tprivate timer: number = 0\n\tfps: number = 0\n\n\ttick(dt: number) {\n\n\t\tthis.dts.push(dt)\n\t\tthis.timer += dt\n\n\t\tif (this.timer >= 1) {\n\t\t\tthis.timer = 0\n\t\t\tthis.fps = Math.round(1 / (this.dts.reduce((a, b) => a + b) / this.dts.length))\n\t\t\tthis.dts = []\n\t\t}\n\n\t}\n\n}\n", "export default class Timer {\n\n\ttime: number\n\taction: () => void\n\tfinished: boolean = false\n\tpaused: boolean = false\n\n\tconstructor(time: number, action: () => void) {\n\t\tthis.time = time\n\t\tthis.action = action\n\t}\n\n\ttick(dt: number): boolean {\n\t\tif (this.finished || this.paused) return false\n\t\tthis.time -= dt\n\t\tif (this.time <= 0) {\n\t\t\tthis.action()\n\t\t\tthis.finished = true\n\t\t\tthis.time = 0\n\t\t\treturn true\n\t\t}\n\t\treturn false\n\t}\n\n\treset(time) {\n\t\tthis.time = time\n\t\tthis.finished = false\n\t}\n\n}\n"],
  "mappings": "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",
  "names": ["kaboom_exports", "__export", "kaboom_default", "__toCommonJS", "deg2rad", "deg", "__name", "rad2deg", "rad", "clamp", "val", "min", "max", "lerp", "a", "b", "t", "map", "v", "l1", "h1", "l2", "h2", "mapc", "_Vec2", "x", "y", "angle", "args", "p2", "vec2", "s", "len", "n", "other", "Vec2", "__publicField", "Vec3", "z", "vec3", "_Color", "g", "arr", "hex", "result", "h", "l", "rgb", "hue2rgb", "p", "q", "r", "Color", "hsl2rgb", "Quad", "w", "quad", "Mat4", "m", "out", "i", "j", "p4", "f00", "f01", "f02", "f03", "f04", "f05", "f06", "f07", "f08", "f09", "f10", "f11", "f12", "f13", "f14", "f15", "f16", "f17", "f18", "det", "wave", "lo", "hi", "f", "A", "C", "M", "RNG", "seed", "defRNG", "randSeed", "rand", "randi", "chance", "choose", "list", "testRectRect", "r1", "r2", "__name", "testLineLineT", "l1", "l2", "denom", "ua", "ub", "testLineLine", "t", "vec2", "testRectLine", "r", "l", "testRectPoint", "pts", "Line", "testRectPoint", "r", "pt", "__name", "testCirclePoint", "c", "p", "__name", "testPolygonPoint", "poly", "pt", "c", "p", "i", "j", "__name", "Line", "p1", "p2", "m", "Rect", "__name", "pos", "width", "height", "Vec2", "Polygon", "pt", "p", "min", "max", "dx", "dy", "Circle", "center", "radius", "tr", "Ellipse", "vec2", "rx", "ry", "pts", "sat", "overlap", "displacement", "poly", "i", "a", "axisProj", "min1", "max1", "j", "q", "min2", "max2", "o", "o1", "o2", "c1", "c2", "c3", "c4", "c5", "easings", "x", "IDList", "args", "v", "id", "__name", "Event", "action", "cancel", "handle", "ev", "res", "EventHandler", "name", "deepEq", "o1", "o2", "t1", "t2", "k1", "k2", "k", "v1", "v2", "base64ToArrayBuffer", "base64", "binstr", "len", "bytes", "i", "dataURLToArrayBuffer", "url", "download", "filename", "downloadText", "text", "downloadJSON", "data", "downloadBlob", "blob", "isDataURL", "str", "uid", "FPSCounter", "dt", "b", "__name", "Timer", "time", "action", "dt", "__name", "VERSION", "KEY_ALIAS", "MOUSE_BUTTONS", "PREVENT_DEFAULT_KEYS", "ASCII_CHARS", "MIN_GAIN", "MAX_GAIN", "MIN_SPEED", "MAX_SPEED", "MIN_DETUNE", "MAX_DETUNE", "DEF_ANCHOR", "BG_GRID_SIZE", "DEF_FONT", "DBG_FONT", "DEF_TEXT_SIZE", "DEF_TEXT_CACHE_SIZE", "FONT_ATLAS_SIZE", "UV_PAD", "LOG_MAX", "VERTEX_FORMAT", "STRIDE", "sum", "f", "MAX_BATCHED_QUAD", "MAX_BATCHED_VERTS", "MAX_BATCHED_INDICES", "VERT_TEMPLATE", "FRAG_TEMPLATE", "DEF_VERT", "DEF_FRAG", "COMP_DESC", "COMP_EVENTS", "processButtonState", "s", "__name", "enterFullscreen", "el", "exitFullscreen", "getFullscreenElement", "anchorPt", "orig", "vec2", "alignPt", "align", "createEmptyAudioBuffer", "ctx", "kaboom_default", "gopt", "gc", "app", "root", "canvas", "gscale", "stretchToParent", "pw", "ph", "cw", "ch", "pixelDensity", "styles", "FPSCounter", "gl", "Texture", "w", "h", "opt", "filter", "wrap", "img", "tex", "x", "y", "gfx", "defShader", "makeShader", "emptyTex", "c", "Color", "vbuf", "offset", "i", "ibuf", "bgTex", "Mat4", "SpriteData", "Quad", "frames", "anims", "src", "data", "slice", "url", "loadImg", "SoundData", "buf", "resolve", "reject", "audio", "isDataURL", "dataURLToArrayBuffer", "fetchArrayBuffer", "masterNode", "burpSnd", "burp_default", "err", "Asset", "Event", "loader", "asset", "action", "AssetBucket", "name", "id", "handle", "loaded", "assets", "game", "EventHandler", "make", "load", "prom", "loadProgress", "buckets", "n", "bucket", "loadRoot", "path", "fetchURL", "res", "fetchJSON", "fetchText", "loadFont", "font", "loadBitmapFont", "gw", "gh", "makeFont", "dx", "dy", "qw", "qh", "j", "loadSpriteAtlas", "rej", "data2", "atlas", "map", "info", "spr", "loadSprite", "loadPedit", "images", "loadAseprite", "imgSrc", "jsonSrc", "size", "anim", "loadShader", "vert", "frag", "isUrl", "resolveUrl", "r", "vcode", "fcode", "loadSound", "loadBean", "bean_default", "getSprite", "getSound", "getFont", "getBitmapFont", "getShader", "resolveSprite", "resolveSound", "snd", "resolveShader", "shader", "resolveFont", "volume", "v", "clamp", "play", "pb", "doPlay", "pb2", "k", "onLoad", "stopped", "srcNode", "gainNode", "pos", "startTime", "stopTime", "seek", "oldNode", "val", "burp", "vertSrc", "fragSrc", "vertShader", "fragShader", "prog", "formatShaderError", "msg", "FMT", "match", "vertError", "fragError", "uniform", "loc", "Vec3", "Vec2", "chars", "cols", "charMap", "drawRaw", "verts", "indices", "fixed", "shaderSrc", "deepEq", "flush", "transform", "pt", "screen2ndc", "frameStart", "updateViewport", "drawUnscaled", "drawUVQuad", "width", "height", "frameEnd", "pushMatrix", "m", "pushTranslate", "args", "p", "pushScale", "pushRotateX", "a", "pushRotateY", "pushRotateZ", "pushRotate", "pushTransform", "popTransform", "q", "color", "rgb", "opacity", "uvPadX", "uvPadY", "qx", "qy", "vec3", "drawTexture", "scale", "repX", "repY", "drawSprite", "getArcPts", "radiusX", "radiusY", "start", "end", "deg2rad", "nverts", "step", "pts", "drawRect", "drawPolygon", "drawLine", "p1", "p2", "dis", "drawLines", "minLen", "radius", "drawCircle", "drawTriangle", "drawEllipse", "polyOpt", "npts", "drawStenciled", "content", "mask", "test", "drawMasked", "drawSubtracted", "getViewportScale", "ow", "oh", "applyCharTransform", "fchar", "tr", "TEXT_STYLE_RE", "compileStyledText", "text", "charStyleMap", "renderText", "idxOffset", "origIdx", "fontAtlases", "formatText", "fontName", "c2d", "lineSpacing", "letterSpacing", "curX", "tw", "th", "lines", "curLine", "cursor", "lastSpace", "lastSpaceWidth", "fchars", "line", "ox", "idx", "localIdx", "style", "drawText", "drawFormattedText", "ftext", "isFullscreen", "prevWidth", "prevHeight", "pd", "ww", "wh", "rw", "rc", "sw", "sh", "rg", "canvasEvents", "docEvents", "winEvents", "windowToContent", "contentToView", "setMousePos", "mpos", "touches", "t", "debug", "handleErr", "mousePos", "mouseDeltaPos", "isMousePressed", "isMouseDown", "isMouseReleased", "isMouseMoved", "isKeyPressed", "isKeyPressedRepeat", "isKeyDown", "isKeyReleased", "isVirtualButtonPressed", "btn", "isVirtualButtonDown", "isVirtualButtonReleased", "charInputted", "time", "screenshot", "setCursor", "setFullscreen", "isTouchScreen", "updateFrame", "max", "dt", "camPos", "center", "camScale", "camRot", "angle", "shake", "intensity", "toScreen", "toWorld", "calcTransform", "obj", "comps", "compStates", "customState", "ev", "uid", "tag", "child", "comp", "state", "cleanups", "checkDeps", "dep", "func", "e", "o1", "o2", "cb", "on", "event", "IDList", "promisifyEvent", "onUpdate", "add", "onDraw", "onAdd", "onDestroy", "onCollide", "t1", "t2", "b", "col", "forAllCurrentAndFuture", "get", "onClick", "onMousePress", "events", "joinEventControllers", "onHover", "onHoverUpdate", "onHoverEnd", "wait", "actions", "loop", "curTimer", "newF", "onKeyDown", "onKeyPress", "onKeyPressRepeat", "onKeyRelease", "onMouseDown", "onMouseRelease", "onMouseMove", "onCharInput", "onTouchStart", "onTouchMove", "onTouchEnd", "onVirtualButtonPress", "onVirtualButtonDown", "onVirtualButtonRelease", "enterDebugMode", "toFixed", "enterBurpMode", "gravity", "g", "dest", "speed", "diff", "rotate", "easeFunc", "easings", "tween", "anchor", "o", "z", "follow", "move", "dir", "d", "DEF_OFFSCREEN_DIS", "offscreen", "distance", "isOut", "screenRect", "Rect", "testRectPoint", "area", "opts", "Polygon", "Circle", "other", "a1", "a2", "sat", "hovering", "testPolygonPoint", "localArea", "bbox", "getRenderProps", "sprite", "spriteData", "curAnim", "calcTexScale", "prevAnim", "update", "rect", "uvquad", "circle", "outline", "timer", "timers", "Timer", "cancel", "DEF_JUMP_FORCE", "MAX_VEL", "body", "velY", "curPlatform", "lastPlatformPos", "wantFall", "col2", "prevVelY", "force", "doubleJump", "numJumps", "jumpsLeft", "stay", "scenesToStay", "health", "hp", "lifespan", "fade", "initState", "stateList", "transitions", "initStateEvents", "trigger", "didFirstEnter", "oldState", "available", "from", "to", "fadeIn", "done", "scene", "def", "go", "getData", "key", "setData", "plug", "plugin", "funcs", "grid", "level", "addLevel", "maxRowLen", "levelComp", "posComp", "row", "keys", "record", "frameRate", "stream", "audioDest", "recorder", "chunks", "filename", "blob", "downloadBlob", "isFocused", "destroy", "readd", "destroyAll", "getAll", "boom", "kaSprite", "ka_default", "boomSprite", "boom_default", "addKaboom", "kaboom", "ka", "DEF_HASH_GRID_SIZE", "Collision", "source", "target", "resolved", "checkFrame", "cellSize", "stack", "checkObj", "aobj", "xmin", "ymin", "xmax", "ymax", "checked", "cell", "col1", "drawFrame", "cam", "rand", "lerp", "drawLoadScreen", "progress", "drawInspectText", "txt", "pad", "ftxt", "bw", "bh", "drawDebug", "inspecting", "flipped", "wave", "drawVirtualControls", "drawCircleButton", "testCirclePoint", "drawSquareButton", "onLoadUpdate", "onResize", "onError", "run", "textStyle", "title", "resetInputState", "frame", "realTime", "realDt", "quit", "numTextureUnits", "unit", "min", "duration", "setValue", "curTime", "onFinishEvents", "happy_28x36_default", "Line", "RNG", "randi", "randSeed", "hsl2rgb", "quad", "choose", "chance", "mapc", "rad2deg", "testLineLine", "testRectRect", "testRectLine", "download", "downloadJSON", "downloadText"]
}
